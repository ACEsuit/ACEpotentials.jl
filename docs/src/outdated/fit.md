# Fitting ACE 

## Top-level overview

The most minimal way of generating an ACE potential is 

```julia
using ACEpotentials
params = ... # see below 
fit_ace()
```

In the first instance, the parameters' dictionary (`params`) is generated by the `*params()` functions described in the rest of these pages. It can also be read from a `.json` or `.yaml` file. 

`fit_ace()` takes the dictionary generated by `fit_params()`

```@docs
ACEpotentials.fit_ace
ACEpotentials.fit_params
```

Parameters `LSQ_DB_fname_stem` and `fit_from_LSQ_DB` determine if the least-squares gets saved and/or where/how it gets fit from. 

* `LSQ_DB_fname_stem` is set to `""`: LsqDB is neither saved to nor read from file;
* `LSQ_DB_fname_stem` is given:
    * file not present: LsqDB saved to disk and fit to;
    * file present:
        * `fit_from_LSQ_DB` is true: fit to the LsqDB on disk;
        * `fit_from_LSQ_DB` is false: rename old LsqDB; make, save and fit to a new LsqDB.    


# TODO
### Create LsqDB & fit it separately
#
#It is also possible to decouple making the least-squares database from fitting to it. 
#
#```@docs
#make_ace_db
#fit_ace_db
#```
#
#In fact, `fit_ace()` just calls both of these in one go.

## Reading parameters in from file

Dictionaries may be read in from file with

```julia
params = load_dict("params.json")
# or 
params = load_dict("params.yaml")
```

There is a convenience function `fill_defaults()` that recursively fills in any missing values with defaults, so that only mandatory or non-default values have to be saved in the files.

```@docs
ACEpotentials.fill_defaults
```

## Examples of minimal set of parameters

### Minimal set

To give an overview of the structure of the parameters' dictionary below is an example with only the mandatory values filled in. 


```julia
mandatory_params = Dict(
    "data" => Dict(
        "fname" => "training_set.xyz"),
    "basis" => Dict(
        "main_ace" => Dict(
            "species" => ["Ti", "Al"],  
            "N" => 2,                   # correlation order
            "maxdeg" => 10,             # polynomial degree
            "type" => "ace"),           # specifies many-body/ace basis functions 
        "main_pair" => Dict(
            "species" => ["Ti", "Al"],  
            "maxdeg" => 4,              # polynomial degree for the 2-body functions
            "type" => "pair"            # specify 2-body basis
            ),),
    "solver" => Dict(
        "type" => "rrqr"),              # use rank-revealing QR factorisation 
    "e0" => Dict(                       # isolated atom energies, eV
        "Ti" => -1586.0195,
        "Al" => -105.5954))
```

### With all default values

The following is the full set of parameters, including the default values. 

```julia
params_with_defaults = Dict(
    "data" => Dict(
        "fname" => "training_set.xyz", # mandatory
        "energy_key" => "dft_energy",
        "force_key" => "dft_force",
        "virial_key" => "dft_virial"),
    "basis" => Dict(
        "main_ace" => Dict(
            "species" => ["Ti", "Al"],  # mandatory
            "N" => 2,                   # mandatory 
            "maxdeg" => 10,             # mandatory 
            "type" => "ace",            # mandatory/defines this as the many-body basis & params
            "r0" => 2.5,                # poly transform parameter, Å
            "radial" => Dict(           # parameters for radial basis of ACE 
                "r0" => 2.5,            # from "main_ace" dictionary
                "rcut" => 5.0,          # outter cutoff, Å
                "rin" => 0.5 * r0,      # inner cutoff, Å
                "pcut" => 2,            # outter cutoff parameter
                "pin" => 2,             # inner cutoff parameter
                "type" => "radial" ),   # mandatory/defines this as radial basis
            "transform" => Dict(        # radial transform to use
                "type" => "polynomial", # of 1/(1+r/r0)^2 - type
                "p" => 2, 
                "r0" => 2.5),
            "degree" => ...),           # way to specify the total polynomial degree
        "main_pair" => Dict(
            "species" => ["Ti", "Al"],  # mandatory 
            "maxdeg" => 4,              # mandatory 
            "type" => "pair",           # mandatory/defines this as pair basis 
            "r0" => 2.5,                # poly transform parameter, Å
            "rcut" => 5.0,              # outer cutoff, Å
            "rin" => 0.0,               # inner cutoff, Å
            "pcut" => 2,                # outter cutoff parameter 
            "pin" => 0,                 # inner cutoff parameter
            "transform" => Dict(        # radial transform to use
                "type" => "polynomial", # of 1/(1+r/r0)^2 - type
                "p" => 2, 
                "r0" => 2.5),),),
    "solver" => Dict(
        "type" => "rrqr",               # mandatory/defines this as rrqr solver
        "rrqr_tol" => 1e-5),            # convergence tolerance parameter
    "e0" => Dict(                       # mandatory
        "Ti" => -1586.0195,
        "Al" => -105.5954), 
    "weights" => Dict(                  # defines relative importance of energy vs weight vs virial observations
        "default" => Dict(              
            "E" => 1.0,
            "F" => 1.0, 
            "V" => 1.0)),
    "P" => nothing,                     # additional regularizer/prior
    "ACE_fname" => "ACE_fit.json",      # filename to save ACE model to
    "LSQ_DB_fname_stem" => "",          # do not save ACE LsqDB
    "fit_from_LSQ_DB" => false          # do not refit to a present database
    )
```


