# ETACE Potential - Trim-compatible shared library export
# Generated by export_ace_model.jl
# Compile with: juliac --output-lib libace.so --trim=safe model.jl
#
# NOTE: This export is fully self-contained and trim=safe compatible.
# All spherical harmonics and radial basis evaluation code is inlined.
# No runtime dependency on SpheriCart, P4ML, or EquivariantTensors.

using StaticArrays
using StaticArrays: MVector
using LinearAlgebra: norm, dot

# ============================================================================
# MODEL CONSTANTS - Pre-computed from fitted ETACE model
# ============================================================================

# Species mapping: index -> atomic number
const I2Z = [22, 13]
const NZ = 2

# Helper to convert atomic number to index
@inline function z2i(Z::Integer)
    @inbounds for i in 1:NZ
        I2Z[i] == Z && return i
    end
    error("Unknown atomic number: $Z")
end

# PooledSparseProduct specification
const ABASIS_SPEC = [(1, 1), (17, 2), (17, 3), (17, 4), (30, 5), (30, 6), (30, 7), (30, 8), (30, 9), (2, 1), (18, 2), (18, 3), (18, 4), (31, 5), (31, 6), (31, 7), (31, 8), (31, 9), (3, 1), (19, 2), (19, 3), (19, 4), (32, 5), (32, 6), (32, 7), (32, 8), (32, 9), (4, 1), (20, 2), (20, 3), (20, 4), (5, 1), (21, 2), (21, 3), (21, 4), (6, 1), (22, 2), (22, 3), (22, 4), (7, 1), (23, 2), (23, 3), (23, 4), (8, 1), (24, 2), (24, 3), (24, 4), (9, 1), (25, 2), (25, 3), (25, 4), (10, 1), (11, 1), (12, 1), (13, 1), (14, 1), (15, 1), (16, 1)]

# SparseSymmProd specification (typed per order)
const AABASIS_SPECS_1 = ((1,), (10,), (19,), (28,), (32,), (36,), (40,), (44,), (48,), (52,), (53,), (54,), (55,), (56,), (57,), (58,),)  # Tuple of NTuple{1, Int}
const AABASIS_SPECS_2 = ((1, 1), (1, 10), (1, 19), (1, 28), (1, 32), (1, 36), (1, 40), (1, 44), (1, 48), (1, 52), (1, 53), (1, 54), (1, 55), (1, 56), (1, 57), (10, 10), (10, 19), (10, 28), (10, 32), (10, 36), (10, 40), (10, 44), (10, 48), (10, 52), (10, 53), (10, 54), (10, 55), (10, 56), (19, 19), (19, 28), (19, 32), (19, 36), (19, 40), (19, 44), (19, 48), (19, 52), (19, 53), (19, 54), (19, 55), (28, 28), (28, 32), (28, 36), (28, 40), (28, 44), (28, 48), (28, 52), (28, 53), (28, 54), (2, 2), (4, 4), (3, 3), (2, 11), (4, 13), (3, 12), (2, 20), (4, 22), (3, 21), (2, 29), (4, 31), (3, 30), (2, 33), (4, 35), (3, 34), (2, 37), (4, 39), (3, 38), (2, 41), (4, 43), (3, 42), (2, 45), (4, 47), (3, 46), (2, 49), (4, 51), (3, 50), (32, 32), (32, 36), (32, 40), (32, 44), (32, 48), (32, 52), (32, 53), (11, 11), (13, 13), (12, 12), (11, 20), (13, 22), (12, 21), (11, 29), (13, 31), (12, 30), (11, 33), (13, 35), (12, 34), (11, 37), (13, 39), (12, 38), (11, 41), (13, 43), (12, 42), (11, 45), (13, 47), (12, 46), (36, 36), (36, 40), (36, 44), (36, 48), (36, 52), (20, 20), (22, 22), (21, 21), (20, 29), (22, 31), (21, 30), (20, 33), (22, 35), (21, 34), (20, 37), (22, 39), (21, 38), (20, 41), (22, 43), (21, 42), (40, 40), (40, 44), (40, 48), (29, 29), (31, 31), (30, 30), (29, 33), (31, 35), (30, 34), (29, 37), (31, 39), (30, 38), (5, 5), (9, 9), (6, 6), (8, 8), (7, 7), (5, 14), (9, 18), (6, 15), (8, 17), (7, 16), (5, 23), (9, 27), (6, 24), (8, 26), (7, 25), (44, 44), (33, 33), (35, 35), (34, 34), (14, 14), (18, 18), (15, 15), (17, 17), (16, 16),)  # Tuple of NTuple{2, Int}
const AABASIS_SPECS_3 = ((1, 1, 1), (1, 1, 10), (1, 1, 19), (1, 1, 28), (1, 1, 32), (1, 1, 36), (1, 1, 40), (1, 1, 44), (1, 1, 48), (1, 1, 52), (1, 1, 53), (1, 1, 54), (1, 1, 55), (1, 1, 56), (1, 10, 10), (1, 10, 19), (1, 10, 28), (1, 10, 32), (1, 10, 36), (1, 10, 40), (1, 10, 44), (1, 10, 48), (1, 10, 52), (1, 10, 53), (1, 10, 54), (1, 10, 55), (1, 19, 19), (1, 19, 28), (1, 19, 32), (1, 19, 36), (1, 19, 40), (1, 19, 44), (1, 19, 48), (1, 19, 52), (1, 19, 53), (1, 19, 54), (1, 28, 28), (1, 28, 32), (1, 28, 36), (1, 28, 40), (1, 28, 44), (1, 28, 48), (1, 28, 52), (1, 28, 53), (1, 2, 2), (1, 4, 4), (1, 3, 3), (1, 2, 11), (1, 4, 13), (1, 3, 12), (1, 2, 20), (1, 4, 22), (1, 3, 21), (1, 2, 29), (1, 4, 31), (1, 3, 30), (1, 2, 33), (1, 4, 35), (1, 3, 34), (1, 2, 37), (1, 4, 39), (1, 3, 38), (1, 2, 41), (1, 4, 43), (1, 3, 42), (1, 2, 45), (1, 4, 47), (1, 3, 46), (1, 32, 32), (1, 32, 36), (1, 32, 40), (1, 32, 44), (1, 32, 48), (1, 32, 52), (1, 11, 11), (1, 13, 13), (1, 12, 12), (1, 11, 20), (1, 13, 22), (1, 12, 21), (1, 11, 29), (1, 13, 31), (1, 12, 30), (1, 11, 33), (1, 13, 35), (1, 12, 34), (1, 11, 37), (1, 13, 39), (1, 12, 38), (1, 11, 41), (1, 13, 43), (1, 12, 42), (1, 36, 36), (1, 36, 40), (1, 36, 44), (1, 36, 48), (1, 20, 20), (1, 22, 22), (1, 21, 21), (1, 20, 29), (1, 22, 31), (1, 21, 30), (1, 20, 33), (1, 22, 35), (1, 21, 34), (1, 20, 37), (1, 22, 39), (1, 21, 38), (1, 40, 40), (1, 40, 44), (1, 29, 29), (1, 31, 31), (1, 30, 30), (1, 29, 33), (1, 31, 35), (1, 30, 34), (1, 5, 5), (1, 9, 9), (1, 6, 6), (1, 8, 8), (1, 7, 7), (1, 5, 14), (1, 9, 18), (1, 6, 15), (1, 8, 17), (1, 7, 16), (10, 10, 10), (10, 10, 19), (10, 10, 28), (10, 10, 32), (10, 10, 36), (10, 10, 40), (10, 10, 44), (10, 10, 48), (10, 10, 52), (10, 10, 53), (10, 10, 54), (10, 19, 19), (10, 19, 28), (10, 19, 32), (10, 19, 36), (10, 19, 40), (10, 19, 44), (10, 19, 48), (10, 19, 52), (10, 19, 53), (10, 28, 28), (10, 28, 32), (10, 28, 36), (10, 28, 40), (10, 28, 44), (10, 28, 48), (10, 28, 52), (2, 2, 10), (4, 4, 10), (3, 3, 10), (2, 10, 11), (4, 10, 13), (3, 10, 12), (2, 10, 20), (4, 10, 22), (3, 10, 21), (2, 10, 29), (4, 10, 31), (3, 10, 30), (2, 10, 33), (4, 10, 35), (3, 10, 34), (2, 10, 37), (4, 10, 39), (3, 10, 38), (2, 10, 41), (4, 10, 43), (3, 10, 42), (10, 32, 32), (10, 32, 36), (10, 32, 40), (10, 32, 44), (10, 32, 48), (10, 11, 11), (10, 13, 13), (10, 12, 12), (10, 11, 20), (10, 13, 22), (10, 12, 21), (10, 11, 29), (10, 13, 31), (10, 12, 30), (10, 11, 33), (10, 13, 35), (10, 12, 34), (10, 11, 37), (10, 13, 39), (10, 12, 38), (10, 36, 36), (10, 36, 40), (10, 36, 44), (10, 20, 20), (10, 22, 22), (10, 21, 21), (10, 20, 29), (10, 22, 31), (10, 21, 30), (10, 20, 33), (10, 22, 35), (10, 21, 34), (10, 40, 40), (10, 29, 29), (10, 31, 31), (10, 30, 30), (5, 5, 10), (9, 9, 10), (6, 6, 10), (8, 8, 10), (7, 7, 10), (19, 19, 19), (19, 19, 28), (19, 19, 32), (19, 19, 36), (19, 19, 40), (19, 19, 44), (19, 19, 48), (19, 19, 52), (19, 28, 28), (19, 28, 32), (19, 28, 36), (19, 28, 40), (19, 28, 44), (19, 28, 48), (2, 2, 19), (4, 4, 19), (3, 3, 19), (2, 11, 19), (4, 13, 19), (3, 12, 19), (2, 19, 20), (4, 19, 22), (3, 19, 21), (2, 19, 29), (4, 19, 31), (3, 19, 30), (2, 19, 33), (4, 19, 35), (3, 19, 34), (2, 19, 37), (4, 19, 39), (3, 19, 38), (19, 32, 32), (19, 32, 36), (19, 32, 40), (19, 32, 44), (11, 11, 19), (13, 13, 19), (12, 12, 19), (11, 19, 20), (13, 19, 22), (12, 19, 21), (11, 19, 29), (13, 19, 31), (12, 19, 30), (11, 19, 33), (13, 19, 35), (12, 19, 34), (19, 36, 36), (19, 36, 40), (19, 20, 20), (19, 22, 22), (19, 21, 21), (19, 20, 29), (19, 22, 31), (19, 21, 30), (28, 28, 28), (28, 28, 32), (28, 28, 36), (28, 28, 40), (28, 28, 44), (2, 2, 28), (4, 4, 28), (3, 3, 28), (2, 11, 28), (4, 13, 28), (3, 12, 28), (2, 20, 28), (4, 22, 28), (3, 21, 28), (2, 28, 29), (4, 28, 31), (3, 28, 30), (2, 28, 33), (4, 28, 35), (3, 28, 34), (28, 32, 32), (28, 32, 36), (28, 32, 40), (11, 11, 28), (13, 13, 28), (12, 12, 28), (11, 20, 28), (13, 22, 28), (12, 21, 28), (11, 28, 29), (13, 28, 31), (12, 28, 30), (28, 36, 36), (20, 20, 28), (22, 22, 28), (21, 21, 28), (2, 2, 32), (4, 4, 32), (3, 3, 32), (2, 2, 36), (4, 4, 36), (3, 3, 36), (2, 2, 40), (4, 4, 40), (3, 3, 40), (2, 4, 5), (2, 2, 9), (4, 4, 9), (2, 3, 6), (3, 4, 8), (2, 2, 7), (4, 4, 7), (3, 3, 7), (2, 2, 44), (4, 4, 44), (3, 3, 44), (2, 4, 14), (2, 2, 18), (4, 4, 18), (2, 3, 15), (3, 4, 17), (2, 2, 16), (4, 4, 16), (3, 3, 16), (2, 11, 32), (4, 13, 32), (3, 12, 32), (2, 20, 32), (4, 22, 32), (3, 21, 32), (2, 29, 32), (4, 31, 32), (3, 30, 32), (2, 11, 36), (4, 13, 36), (3, 12, 36), (2, 11, 40), (4, 13, 40), (3, 12, 40), (4, 5, 11), (2, 5, 13), (2, 9, 11), (4, 9, 13), (3, 6, 11), (3, 8, 13), (2, 6, 12), (4, 8, 12), (2, 7, 11), (4, 7, 13), (3, 7, 12), (2, 20, 36), (4, 22, 36), (3, 21, 36), (32, 32, 32), (32, 32, 36), (11, 11, 32), (13, 13, 32), (12, 12, 32), (11, 20, 32), (13, 22, 32), (12, 21, 32), (11, 11, 36), (13, 13, 36), (12, 12, 36),)  # Tuple of NTuple{3, Int}
const AABASIS_RANGES = (1:16, 17:175, 176:550)
const AABASIS_HASCONST = false

# A2B coupling matrices (sparse format: I, J, V)
const A2BMAP_1_I = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 65, 65, 66, 66, 66, 67, 67, 67, 68, 68, 68, 69, 69, 69, 70, 70, 70, 71, 71, 71, 72, 72, 72, 73, 73, 73, 74, 75, 76, 77, 78, 79, 80, 81, 81, 81, 82, 82, 82, 83, 83, 83, 84, 84, 84, 85, 85, 85, 86, 86, 86, 87, 87, 87, 88, 89, 90, 91, 92, 93, 93, 93, 94, 94, 94, 95, 95, 95, 96, 96, 96, 97, 97, 97, 98, 99, 100, 101, 101, 101, 102, 102, 102, 103, 103, 103, 104, 104, 104, 104, 104, 105, 105, 105, 105, 105, 106, 106, 106, 106, 106, 107, 108, 108, 108, 109, 109, 109, 109, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 154, 154, 155, 155, 155, 156, 156, 156, 157, 157, 157, 158, 158, 158, 159, 159, 159, 160, 160, 160, 161, 161, 161, 162, 163, 164, 165, 166, 167, 168, 168, 168, 169, 169, 169, 170, 170, 170, 171, 171, 171, 172, 172, 172, 173, 173, 173, 174, 175, 176, 177, 178, 178, 178, 179, 179, 179, 180, 180, 180, 181, 181, 181, 182, 183, 184, 184, 184, 185, 185, 185, 186, 186, 186, 186, 186, 187, 187, 187, 187, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 215, 215, 216, 216, 216, 217, 217, 217, 218, 218, 218, 219, 219, 219, 220, 220, 220, 221, 221, 221, 222, 223, 224, 225, 226, 227, 227, 227, 228, 228, 228, 229, 229, 229, 230, 230, 230, 231, 231, 231, 232, 233, 234, 235, 235, 235, 236, 236, 236, 237, 237, 237, 238, 239, 239, 239, 240, 240, 240, 240, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 255, 255, 256, 256, 256, 257, 257, 257, 258, 258, 258, 259, 259, 259, 260, 260, 260, 261, 262, 263, 264, 265, 265, 265, 266, 266, 266, 267, 267, 267, 268, 268, 268, 269, 270, 271, 271, 271, 272, 272, 272, 273, 274, 275, 276, 277, 278, 278, 278, 279, 279, 279, 280, 280, 280, 281, 281, 281, 282, 282, 282, 283, 284, 285, 286, 286, 286, 287, 287, 287, 288, 288, 288, 289, 290, 290, 290, 291, 291, 291, 292, 292, 292, 293, 293, 293, 294, 294, 294, 294, 294, 294, 294, 294, 295, 295, 295, 296, 296, 296, 296, 296, 296, 296, 296, 297, 297, 297, 298, 298, 298, 299, 299, 299, 300, 300, 300, 301, 301, 301, 302, 302, 302, 302, 302, 302, 302, 302, 302, 302, 302, 303, 303, 303, 304, 305, 306, 306, 306, 307, 307, 307, 308, 308, 308]
const A2BMAP_1_J = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 385, 386, 387, 388, 389, 390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438, 439, 440, 441, 442, 443, 444, 445, 446, 447, 448, 449, 450, 451, 452, 453, 454, 455, 456, 457, 458, 459, 460, 461, 462, 463, 464, 465, 466, 467, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480, 481, 482, 483, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513, 514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 526, 527, 528, 529, 530, 531, 532, 533, 534, 535, 536, 537, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550]
const A2BMAP_1_V = [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.4472135954999577, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.4472135954999577, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.4472135954999577, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.4472135954999577, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.8, -0.4, 0.4, 0.8, 0.8, -0.2309401076758503, -0.2309401076758503, 0.46188021535170065, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.8, -0.4, 0.4, 0.8, 0.8, -0.2309401076758503, -0.2309401076758503, 0.46188021535170065, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.3162277660168379, 0.3162277660168379, -0.3162277660168379, 0.3162277660168379, 0.3162277660168379, 0.3162277660168379, 0.3162277660168379, 0.3162277660168379, -0.18257418583505533, -0.18257418583505533, 0.3651483716701107, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258]
const A2BMAP_1_SIZE = (308, 550)

# ============================================================================
# RADIAL BASIS (ETACE: Agnesi transform + polynomial + linear weights)
# ============================================================================

const RCUT_MAX = 5.5

# Symmetric species pair indexing: (iz, jz) -> pair index
# For NZ=2: (1,1)->1, (1,2)->2, (2,2)->3
@inline function zz2pair_sym(iz::Int, jz::Int)::Int
    i, j = min(iz, jz), max(iz, jz)
    return (i - 1) * NZ - (i - 1) * (i - 2) ÷ 2 + (j - i + 1)
end

# Polynomial basis (orthonormalized Chebyshev)
# Uses 3-term recurrence: P[n+1] = (A[n]*y + B[n])*P[n] + C[n]*P[n-1]
const N_POLYS = 24
const POLY_A = SVector{24, Float64}([0.7071067811865478, 1.224744871391591, 1.9364916731037103, 1.9720265943665405, 1.984313483298445, 1.9899748742132426, 1.9930434571835678, 1.9948914348241364, 1.9960899278339157, 1.9969111950679388, 1.9974984355438197, 1.9979328159850847, 1.9982631347136353, 1.9985201625794757, 1.9987240828047488, 1.9988885800753289, 1.9990231989649363, 1.9991347609372287, 1.9992282461607338, 1.9993073592865893, 1.999374902313222, 1.9994330262111462, 1.9994834043566176, 1.9995273543594663])
const POLY_B = SVector{24, Float64}([0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0])
const POLY_C = SVector{24, Float64}([0.0, 0.0, -1.1180339887498971, -1.018350154434633, -1.0062305898749073, -1.0028530728448164, -1.0015420209622214, -1.0009272139219598, -1.0006007810695166, -1.0004114379931357, -1.0002940744071827, -1.0002174622185125, -1.0001653302483002, -1.0001286256356232, -1.0001020356106956, -1.0000823011400124, -1.0000673468701322, -1.0000558082429227, -1.0000467628422731, -1.000039571832787, -1.0000337832131325, -1.000029071035082, -1.0000251962155344, -1.000021980678988])

# Inline polynomial evaluation (trim-safe, no P4ML dependency)
# 3-term recurrence: P[n+1] = (A[n]*y + B[n])*P[n] + C[n]*P[n-1]
@inline function eval_polys(y::T) where {T}
    P = MVector{N_POLYS, T}(undef)
    @inbounds begin
        P[1] = one(T)
        if N_POLYS >= 2
            P[2] = (POLY_A[1] * y + POLY_B[1]) * P[1]
        end
        for n = 2:N_POLYS-1
            P[n+1] = (POLY_A[n] * y + POLY_B[n]) * P[n] + POLY_C[n] * P[n-1]
        end
    end
    return P
end

# Inline polynomial evaluation with derivatives (trim-safe)
# d(P[n])/dy computed via differentiation of recurrence relation
@inline function eval_polys_ed(y::T) where {T}
    P = MVector{N_POLYS, T}(undef)
    dP = MVector{N_POLYS, T}(undef)
    @inbounds begin
        P[1] = one(T)
        dP[1] = zero(T)
        if N_POLYS >= 2
            P[2] = (POLY_A[1] * y + POLY_B[1]) * P[1]
            dP[2] = POLY_A[1] * P[1] + (POLY_A[1] * y + POLY_B[1]) * dP[1]
        end
        for n = 2:N_POLYS-1
            P[n+1] = (POLY_A[n] * y + POLY_B[n]) * P[n] + POLY_C[n] * P[n-1]
            dP[n+1] = POLY_A[n] * P[n] + (POLY_A[n] * y + POLY_B[n]) * dP[n] + POLY_C[n] * dP[n-1]
        end
    end
    return P, dP
end

const N_RNL = 51

# Radial basis weights: W[n_rnl, n_polys] for each species pair
const RBASIS_W_1 = [1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]
const RBASIS_W_2 = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]
const RBASIS_W_3 = [1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]
const RBASIS_W_4 = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]

# Envelope: (1 - y^2)^2 for y ∈ [-1, 1]
@inline envelope(y::T) where {T} = (one(T) - y^2)^2
@inline envelope_d(y::T) where {T} = (one(T) - y^2)^2, -4 * y * (one(T) - y^2)

# Per-pair Agnesi transforms (trim-safe: all parameters are constants)
# Agnesi transform for pair 1: r -> y ∈ [-1, 1]
const AGNESI_1_RIN = 0.0
const AGNESI_1_REQ = 2.9
const AGNESI_1_RCUT = 5.5
const AGNESI_1_PIN = 2.0
const AGNESI_1_PCUT = 2.0
const AGNESI_1_A = 0.6666666666666666
const AGNESI_1_B0 = 2.6680991735537187
const AGNESI_1_B1 = -3.6680991735537187

@inline function eval_agnesi_1(r::T) where {T}
    if r <= AGNESI_1_RIN
        return one(T)
    end
    if r >= AGNESI_1_RCUT
        return -one(T)
    end
    s = (r - AGNESI_1_RIN) / (AGNESI_1_REQ - AGNESI_1_RIN)
    x = one(T) / (one(T) + AGNESI_1_A * s^AGNESI_1_PIN / (one(T) + s^(AGNESI_1_PIN - AGNESI_1_PCUT)))
    y = AGNESI_1_B1 * x + AGNESI_1_B0
    return clamp(y, -one(T), one(T))
end

@inline function eval_agnesi_d_1(r::T) where {T}
    if r <= AGNESI_1_RIN
        return one(T), zero(T)
    end
    if r >= AGNESI_1_RCUT
        return -one(T), zero(T)
    end

    rin = AGNESI_1_RIN
    req = AGNESI_1_REQ
    pin = AGNESI_1_PIN
    pcut = AGNESI_1_PCUT
    a = AGNESI_1_A
    b0 = AGNESI_1_B0
    b1 = AGNESI_1_B1

    s = (r - rin) / (req - rin)
    ds_dr = one(T) / (req - rin)

    # x = 1 / (1 + a * s^pin / (1 + s^(pin - pcut)))
    s_pin = s^pin
    s_diff = s^(pin - pcut)
    denom_inner = one(T) + s_diff
    denom = one(T) + a * s_pin / denom_inner
    x = one(T) / denom

    # y = b1 * x + b0
    y = b1 * x + b0

    # Derivative: dy/dr = b1 * dx/dr
    if s > 1e-10  # Avoid division by zero near s=0
        diff = pin - pcut
        ds_pin = pin * s^(pin - 1)
        ds_diff = diff > 0 ? diff * s^(diff - 1) : zero(T)
        d_denom_ds = a * (ds_pin * denom_inner - s_pin * ds_diff) / (denom_inner^2)
        dx_ds = -x^2 * d_denom_ds
        dy_ds = b1 * dx_ds
        dy_dr = dy_ds * ds_dr
    else
        dy_dr = zero(T)
    end

    if y <= -one(T) || y >= one(T)
        return clamp(y, -one(T), one(T)), zero(T)
    end
    return y, dy_dr
end

# Agnesi transform for pair 2: r -> y ∈ [-1, 1]
const AGNESI_2_RIN = 0.0
const AGNESI_2_REQ = 2.9
const AGNESI_2_RCUT = 5.5
const AGNESI_2_PIN = 2.0
const AGNESI_2_PCUT = 2.0
const AGNESI_2_A = 0.6666666666666666
const AGNESI_2_B0 = 2.6680991735537187
const AGNESI_2_B1 = -3.6680991735537187

@inline function eval_agnesi_2(r::T) where {T}
    if r <= AGNESI_2_RIN
        return one(T)
    end
    if r >= AGNESI_2_RCUT
        return -one(T)
    end
    s = (r - AGNESI_2_RIN) / (AGNESI_2_REQ - AGNESI_2_RIN)
    x = one(T) / (one(T) + AGNESI_2_A * s^AGNESI_2_PIN / (one(T) + s^(AGNESI_2_PIN - AGNESI_2_PCUT)))
    y = AGNESI_2_B1 * x + AGNESI_2_B0
    return clamp(y, -one(T), one(T))
end

@inline function eval_agnesi_d_2(r::T) where {T}
    if r <= AGNESI_2_RIN
        return one(T), zero(T)
    end
    if r >= AGNESI_2_RCUT
        return -one(T), zero(T)
    end

    rin = AGNESI_2_RIN
    req = AGNESI_2_REQ
    pin = AGNESI_2_PIN
    pcut = AGNESI_2_PCUT
    a = AGNESI_2_A
    b0 = AGNESI_2_B0
    b1 = AGNESI_2_B1

    s = (r - rin) / (req - rin)
    ds_dr = one(T) / (req - rin)

    # x = 1 / (1 + a * s^pin / (1 + s^(pin - pcut)))
    s_pin = s^pin
    s_diff = s^(pin - pcut)
    denom_inner = one(T) + s_diff
    denom = one(T) + a * s_pin / denom_inner
    x = one(T) / denom

    # y = b1 * x + b0
    y = b1 * x + b0

    # Derivative: dy/dr = b1 * dx/dr
    if s > 1e-10  # Avoid division by zero near s=0
        diff = pin - pcut
        ds_pin = pin * s^(pin - 1)
        ds_diff = diff > 0 ? diff * s^(diff - 1) : zero(T)
        d_denom_ds = a * (ds_pin * denom_inner - s_pin * ds_diff) / (denom_inner^2)
        dx_ds = -x^2 * d_denom_ds
        dy_ds = b1 * dx_ds
        dy_dr = dy_ds * ds_dr
    else
        dy_dr = zero(T)
    end

    if y <= -one(T) || y >= one(T)
        return clamp(y, -one(T), one(T)), zero(T)
    end
    return y, dy_dr
end

# Agnesi transform for pair 3: r -> y ∈ [-1, 1]
const AGNESI_3_RIN = 0.0
const AGNESI_3_REQ = 2.9
const AGNESI_3_RCUT = 5.5
const AGNESI_3_PIN = 2.0
const AGNESI_3_PCUT = 2.0
const AGNESI_3_A = 0.6666666666666666
const AGNESI_3_B0 = 2.6680991735537187
const AGNESI_3_B1 = -3.6680991735537187

@inline function eval_agnesi_3(r::T) where {T}
    if r <= AGNESI_3_RIN
        return one(T)
    end
    if r >= AGNESI_3_RCUT
        return -one(T)
    end
    s = (r - AGNESI_3_RIN) / (AGNESI_3_REQ - AGNESI_3_RIN)
    x = one(T) / (one(T) + AGNESI_3_A * s^AGNESI_3_PIN / (one(T) + s^(AGNESI_3_PIN - AGNESI_3_PCUT)))
    y = AGNESI_3_B1 * x + AGNESI_3_B0
    return clamp(y, -one(T), one(T))
end

@inline function eval_agnesi_d_3(r::T) where {T}
    if r <= AGNESI_3_RIN
        return one(T), zero(T)
    end
    if r >= AGNESI_3_RCUT
        return -one(T), zero(T)
    end

    rin = AGNESI_3_RIN
    req = AGNESI_3_REQ
    pin = AGNESI_3_PIN
    pcut = AGNESI_3_PCUT
    a = AGNESI_3_A
    b0 = AGNESI_3_B0
    b1 = AGNESI_3_B1

    s = (r - rin) / (req - rin)
    ds_dr = one(T) / (req - rin)

    # x = 1 / (1 + a * s^pin / (1 + s^(pin - pcut)))
    s_pin = s^pin
    s_diff = s^(pin - pcut)
    denom_inner = one(T) + s_diff
    denom = one(T) + a * s_pin / denom_inner
    x = one(T) / denom

    # y = b1 * x + b0
    y = b1 * x + b0

    # Derivative: dy/dr = b1 * dx/dr
    if s > 1e-10  # Avoid division by zero near s=0
        diff = pin - pcut
        ds_pin = pin * s^(pin - 1)
        ds_diff = diff > 0 ? diff * s^(diff - 1) : zero(T)
        d_denom_ds = a * (ds_pin * denom_inner - s_pin * ds_diff) / (denom_inner^2)
        dx_ds = -x^2 * d_denom_ds
        dy_ds = b1 * dx_ds
        dy_dr = dy_ds * ds_dr
    else
        dy_dr = zero(T)
    end

    if y <= -one(T) || y >= one(T)
        return clamp(y, -one(T), one(T)), zero(T)
    end
    return y, dy_dr
end

# Agnesi transform for pair 4: r -> y ∈ [-1, 1]
const AGNESI_4_RIN = 0.0
const AGNESI_4_REQ = 2.9
const AGNESI_4_RCUT = 5.5
const AGNESI_4_PIN = 2.0
const AGNESI_4_PCUT = 2.0
const AGNESI_4_A = 0.6666666666666666
const AGNESI_4_B0 = 2.6680991735537187
const AGNESI_4_B1 = -3.6680991735537187

@inline function eval_agnesi_4(r::T) where {T}
    if r <= AGNESI_4_RIN
        return one(T)
    end
    if r >= AGNESI_4_RCUT
        return -one(T)
    end
    s = (r - AGNESI_4_RIN) / (AGNESI_4_REQ - AGNESI_4_RIN)
    x = one(T) / (one(T) + AGNESI_4_A * s^AGNESI_4_PIN / (one(T) + s^(AGNESI_4_PIN - AGNESI_4_PCUT)))
    y = AGNESI_4_B1 * x + AGNESI_4_B0
    return clamp(y, -one(T), one(T))
end

@inline function eval_agnesi_d_4(r::T) where {T}
    if r <= AGNESI_4_RIN
        return one(T), zero(T)
    end
    if r >= AGNESI_4_RCUT
        return -one(T), zero(T)
    end

    rin = AGNESI_4_RIN
    req = AGNESI_4_REQ
    pin = AGNESI_4_PIN
    pcut = AGNESI_4_PCUT
    a = AGNESI_4_A
    b0 = AGNESI_4_B0
    b1 = AGNESI_4_B1

    s = (r - rin) / (req - rin)
    ds_dr = one(T) / (req - rin)

    # x = 1 / (1 + a * s^pin / (1 + s^(pin - pcut)))
    s_pin = s^pin
    s_diff = s^(pin - pcut)
    denom_inner = one(T) + s_diff
    denom = one(T) + a * s_pin / denom_inner
    x = one(T) / denom

    # y = b1 * x + b0
    y = b1 * x + b0

    # Derivative: dy/dr = b1 * dx/dr
    if s > 1e-10  # Avoid division by zero near s=0
        diff = pin - pcut
        ds_pin = pin * s^(pin - 1)
        ds_diff = diff > 0 ? diff * s^(diff - 1) : zero(T)
        d_denom_ds = a * (ds_pin * denom_inner - s_pin * ds_diff) / (denom_inner^2)
        dx_ds = -x^2 * d_denom_ds
        dy_ds = b1 * dx_ds
        dy_dr = dy_ds * ds_dr
    else
        dy_dr = zero(T)
    end

    if y <= -one(T) || y >= one(T)
        return clamp(y, -one(T), one(T)), zero(T)
    end
    return y, dy_dr
end

# Per-pair specialized radial basis functions (trim-safe)
@inline function evaluate_Rnl_1(r::T)::SVector{N_RNL, T} where {T}
    # Transform distance to y ∈ [-1, 1] (using specialized Agnesi)
    y = eval_agnesi_1(r)

    # Evaluate envelope
    env = envelope(y)
    if env <= zero(T)
        return zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials at y (inline, trim-safe)
    P = eval_polys(y)

    # Apply envelope and linear layer
    return RBASIS_W_1 * SVector{N_POLYS, T}(env .* P)
end

@inline function evaluate_Rnl_d_1(r::T)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    # Transform with derivative (using specialized Agnesi)
    y, dy_dr = eval_agnesi_d_1(r)

    # Envelope with derivative
    env, denv_dy = envelope_d(y)
    denv_dr = denv_dy * dy_dr

    if env <= zero(T)
        return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials with derivatives (inline, trim-safe)
    P, dP = eval_polys_ed(y)
    dP_dr = dP .* dy_dr

    # P_env = env * P, d(P_env)/dr = denv/dr * P + env * dP/dr
    P_env = env .* P
    dP_env_dr = denv_dr .* P .+ env .* dP_dr

    # Linear layer
    Rnl = RBASIS_W_1 * SVector{N_POLYS, T}(P_env)
    dRnl = RBASIS_W_1 * SVector{N_POLYS, T}(dP_env_dr)

    return Rnl, dRnl
end

@inline function evaluate_Rnl_2(r::T)::SVector{N_RNL, T} where {T}
    # Transform distance to y ∈ [-1, 1] (using specialized Agnesi)
    y = eval_agnesi_2(r)

    # Evaluate envelope
    env = envelope(y)
    if env <= zero(T)
        return zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials at y (inline, trim-safe)
    P = eval_polys(y)

    # Apply envelope and linear layer
    return RBASIS_W_2 * SVector{N_POLYS, T}(env .* P)
end

@inline function evaluate_Rnl_d_2(r::T)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    # Transform with derivative (using specialized Agnesi)
    y, dy_dr = eval_agnesi_d_2(r)

    # Envelope with derivative
    env, denv_dy = envelope_d(y)
    denv_dr = denv_dy * dy_dr

    if env <= zero(T)
        return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials with derivatives (inline, trim-safe)
    P, dP = eval_polys_ed(y)
    dP_dr = dP .* dy_dr

    # P_env = env * P, d(P_env)/dr = denv/dr * P + env * dP/dr
    P_env = env .* P
    dP_env_dr = denv_dr .* P .+ env .* dP_dr

    # Linear layer
    Rnl = RBASIS_W_2 * SVector{N_POLYS, T}(P_env)
    dRnl = RBASIS_W_2 * SVector{N_POLYS, T}(dP_env_dr)

    return Rnl, dRnl
end

@inline function evaluate_Rnl_3(r::T)::SVector{N_RNL, T} where {T}
    # Transform distance to y ∈ [-1, 1] (using specialized Agnesi)
    y = eval_agnesi_3(r)

    # Evaluate envelope
    env = envelope(y)
    if env <= zero(T)
        return zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials at y (inline, trim-safe)
    P = eval_polys(y)

    # Apply envelope and linear layer
    return RBASIS_W_3 * SVector{N_POLYS, T}(env .* P)
end

@inline function evaluate_Rnl_d_3(r::T)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    # Transform with derivative (using specialized Agnesi)
    y, dy_dr = eval_agnesi_d_3(r)

    # Envelope with derivative
    env, denv_dy = envelope_d(y)
    denv_dr = denv_dy * dy_dr

    if env <= zero(T)
        return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials with derivatives (inline, trim-safe)
    P, dP = eval_polys_ed(y)
    dP_dr = dP .* dy_dr

    # P_env = env * P, d(P_env)/dr = denv/dr * P + env * dP/dr
    P_env = env .* P
    dP_env_dr = denv_dr .* P .+ env .* dP_dr

    # Linear layer
    Rnl = RBASIS_W_3 * SVector{N_POLYS, T}(P_env)
    dRnl = RBASIS_W_3 * SVector{N_POLYS, T}(dP_env_dr)

    return Rnl, dRnl
end

@inline function evaluate_Rnl_4(r::T)::SVector{N_RNL, T} where {T}
    # Transform distance to y ∈ [-1, 1] (using specialized Agnesi)
    y = eval_agnesi_4(r)

    # Evaluate envelope
    env = envelope(y)
    if env <= zero(T)
        return zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials at y (inline, trim-safe)
    P = eval_polys(y)

    # Apply envelope and linear layer
    return RBASIS_W_4 * SVector{N_POLYS, T}(env .* P)
end

@inline function evaluate_Rnl_d_4(r::T)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    # Transform with derivative (using specialized Agnesi)
    y, dy_dr = eval_agnesi_d_4(r)

    # Envelope with derivative
    env, denv_dy = envelope_d(y)
    denv_dr = denv_dy * dy_dr

    if env <= zero(T)
        return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials with derivatives (inline, trim-safe)
    P, dP = eval_polys_ed(y)
    dP_dr = dP .* dy_dr

    # P_env = env * P, d(P_env)/dr = denv/dr * P + env * dP/dr
    P_env = env .* P
    dP_env_dr = denv_dr .* P .+ env .* dP_dr

    # Linear layer
    Rnl = RBASIS_W_4 * SVector{N_POLYS, T}(P_env)
    dRnl = RBASIS_W_4 * SVector{N_POLYS, T}(dP_env_dr)

    return Rnl, dRnl
end

# Radial basis dispatch: r, iz, jz -> Rnl vector
@inline function evaluate_Rnl(r::T, iz::Int, jz::Int)::SVector{N_RNL, T} where {T}
    pair_idx = zz2pair_sym(iz, jz)

    if pair_idx == 1
        return evaluate_Rnl_1(r)
    elseif pair_idx == 2
        return evaluate_Rnl_2(r)
    elseif pair_idx == 3
        return evaluate_Rnl_3(r)
    elseif pair_idx == 4
        return evaluate_Rnl_4(r)
    end
    return zero(SVector{N_RNL, T})  # fallback
end

# Radial basis with derivatives dispatch
@inline function evaluate_Rnl_d(r::T, iz::Int, jz::Int)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    pair_idx = zz2pair_sym(iz, jz)

    if pair_idx == 1
        return evaluate_Rnl_d_1(r)
    elseif pair_idx == 2
        return evaluate_Rnl_d_2(r)
    elseif pair_idx == 3
        return evaluate_Rnl_d_3(r)
    elseif pair_idx == 4
        return evaluate_Rnl_d_4(r)
    end
    return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})  # fallback
end
# ============================================================================
# SOLID HARMONICS (inline, trim-safe)
# ============================================================================
# Generated from SpheriCart v0.2.3 internals
# maxl = 4, normalisation = L2
#
# This code is derived from SpheriCart's recurrence relations but avoids
# Val-based dispatch for trim=safe compatibility.

const MAXL = 4
const N_YLM = 25

# Solid harmonics evaluation (values only)
@inline function eval_ylm(R::SVector{3, TT}) where {TT}
    x, y, z = R[1], R[2], R[3]

    r² = x ^ 2 + y ^ 2 + z ^ 2
    s_0 = zero(Float64)
    c_0 = one(Float64)
    s_1 = s_0 * x + c_0 * y
    c_1 = c_0 * x - s_0 * y
    s_2 = s_1 * x + c_1 * y
    c_2 = c_1 * x - s_1 * y
    s_3 = s_2 * x + c_2 * y
    c_3 = c_2 * x - s_2 * y
    s_4 = s_3 * x + c_3 * y
    c_4 = c_3 * x - s_3 * y
    c_0 = one(Float64) / 1.4142135623730951
    Q_0_0 = one(Float64)
    Z_1 = 0.28209479177387814Q_0_0
    Q_1_1 = -1 * Q_0_0
    Z_4 = -0.4886025119029199 * Q_1_1 * c_1
    Z_2 = -0.4886025119029199 * Q_1_1 * s_1
    Q_1_0 = 1 * z * Q_0_0
    Z_3 = 0.690988298942671 * Q_1_0 * s_0
    Z_3 = 0.690988298942671 * Q_1_0 * c_0
    Q_2_2 = -3 * Q_1_1
    Z_9 = 0.18209140509867988 * Q_2_2 * c_2
    Z_5 = 0.18209140509867988 * Q_2_2 * s_2
    Q_2_1 = 3 * z * Q_1_1
    Z_6 = -0.36418281019735976 * Q_2_1 * s_1
    Z_8 = -0.36418281019735976 * Q_2_1 * c_1
    Q_2_0 = 1.5 * z * Q_1_0 - 0.5 * r² * Q_0_0
    Z_7 = 0.8920620580763856 * Q_2_0 * s_0
    Z_7 = 0.8920620580763856 * Q_2_0 * c_0
    Q_3_3 = -5 * Q_2_2
    Z_16 = -0.03933623932844291 * Q_3_3 * c_3
    Z_10 = -0.03933623932844291 * Q_3_3 * s_3
    Q_3_2 = 5 * z * Q_2_2
    Z_11 = 0.09635371475468514 * Q_3_2 * s_2
    Z_15 = 0.09635371475468514 * Q_3_2 * c_2
    Q_3_1 = 2.5 * z * Q_2_1 - 1.5 * r² * Q_1_1
    Z_12 = -0.3046971996429772 * Q_3_1 * s_1
    Z_14 = -0.3046971996429772 * Q_3_1 * c_1
    Q_3_0 = 1.6666666666666667 * z * Q_2_0 - 0.6666666666666666 * r² * Q_1_0
    Z_13 = 1.055502061411188 * Q_3_0 * s_0
    Z_13 = 1.055502061411188 * Q_3_0 * c_0
    Q_4_4 = -7 * Q_3_3
    Z_25 = 0.005960340337611202 * Q_4_4 * c_4
    Z_17 = 0.005960340337611202 * Q_4_4 * s_4
    Q_4_3 = 7 * z * Q_3_3
    Z_18 = -0.016858388283618388 * Q_4_3 * s_3
    Z_24 = -0.016858388283618388 * Q_4_3 * c_3
    Q_4_2 = 3.5 * z * Q_3_2 - 2.5 * r² * Q_2_2
    Z_19 = 0.063078313050504 * Q_4_2 * s_2
    Z_23 = 0.063078313050504 * Q_4_2 * c_2
    Q_4_1 = 2.3333333333333335 * z * Q_3_1 - 1.3333333333333333 * r² * Q_2_1
    Z_20 = -0.26761861742291565 * Q_4_1 * s_1
    Z_22 = -0.26761861742291565 * Q_4_1 * c_1
    Q_4_0 = 1.75 * z * Q_3_0 - 0.75 * r² * Q_2_0
    Z_21 = 1.196826841204298 * Q_4_0 * s_0
    Z_21 = 1.196826841204298 * Q_4_0 * c_0
    return SVector{25, TT}(Z_1, Z_2, Z_3, Z_4, Z_5, Z_6, Z_7, Z_8, Z_9, Z_10, Z_11, Z_12, Z_13, Z_14, Z_15, Z_16, Z_17, Z_18, Z_19, Z_20, Z_21, Z_22, Z_23, Z_24, Z_25)
end

# Solid harmonics with gradients
@inline function eval_ylm_ed(R::SVector{3, TT}) where {TT}
    x, y, z = R[1], R[2], R[3]

    r² = x ^ 2 + y ^ 2 + z ^ 2
    s_0 = zero(Float64)
    c_0 = one(Float64)
    s_1 = s_0 * x + c_0 * y
    c_1 = c_0 * x - s_0 * y
    s_2 = s_1 * x + c_1 * y
    c_2 = c_1 * x - s_1 * y
    s_3 = s_2 * x + c_2 * y
    c_3 = c_2 * x - s_2 * y
    s_4 = s_3 * x + c_3 * y
    c_4 = c_3 * x - s_3 * y
    Q_0_0 = one(Float64)
    Z_1 = 0.28209479177387814Q_0_0
    dZ_1 = zero(SVector{3, Float64})
    Q_1_1 = -Q_0_0
    Z_4 = 0.4886025119029199c_1
    Z_2 = 0.4886025119029199s_1
    Q_1_0 = z
    Z_3 = 0.4886025119029199 * Q_1_0 * c_0
    dZ_4 = SA[0.4886025119029199, zero(Float64), zero(Float64)]
    dZ_2 = SA[zero(Float64), 0.4886025119029199, zero(Float64)]
    dZ_3 = SA[zero(Float64), zero(Float64), 0.4886025119029199]
    Q_2_2 = -3 * Q_1_1
    Z_9 = 0.18209140509867988 * Q_2_2 * c_2
    Z_5 = 0.18209140509867988 * Q_2_2 * s_2
    Q_2_1 = 3 * z * Q_1_1
    Z_6 = -0.36418281019735976 * Q_2_1 * s_1
    Z_8 = -0.36418281019735976 * Q_2_1 * c_1
    dZ_9 = 0.18209140509867988 * Q_2_2 * SA[2c_1, -2 * s_1, zero(Float64)]
    dZ_5 = 0.18209140509867988 * Q_2_2 * SA[2s_1, 2c_1, zero(Float64)]
    dZ_6 = -0.36418281019735976 * SA[Q_2_1 * 1 * s_0, Q_2_1 * 1 * c_0, 3 * Q_1_1 * s_1]
    dZ_8 = -0.36418281019735976 * SA[Q_2_1 * 1 * c_0, Q_2_1 * -1 * s_0, 3 * Q_1_1 * c_1]
    Q_2_0 = 1.5 * z * Q_1_0 - 0.5 * r² * Q_0_0
    Z_7 = 0.63078313050504Q_2_0
    dZ_7 = 0.63078313050504 * SA[Q_1_1 * x, Q_1_1 * y, 2Q_1_0]
    Q_3_3 = -5 * Q_2_2
    Z_16 = -0.03933623932844291 * Q_3_3 * c_3
    Z_10 = -0.03933623932844291 * Q_3_3 * s_3
    Q_3_2 = 5 * z * Q_2_2
    Z_11 = 0.09635371475468514 * Q_3_2 * s_2
    Z_15 = 0.09635371475468514 * Q_3_2 * c_2
    dZ_16 = -0.03933623932844291 * Q_3_3 * SA[3c_2, -3 * s_2, zero(Float64)]
    dZ_10 = -0.03933623932844291 * Q_3_3 * SA[3s_2, 3c_2, zero(Float64)]
    dZ_11 = 0.09635371475468514 * SA[Q_3_2 * 2 * s_1, Q_3_2 * 2 * c_1, 5 * Q_2_2 * s_2]
    dZ_15 = 0.09635371475468514 * SA[Q_3_2 * 2 * c_1, Q_3_2 * -2 * s_1, 5 * Q_2_2 * c_2]
    Q_3_1 = 2.5 * z * Q_2_1 - 1.5 * r² * Q_1_1
    Z_12 = -0.3046971996429772 * Q_3_1 * s_1
    Z_14 = -0.3046971996429772 * Q_3_1 * c_1
    dZ_12 = -0.3046971996429772 * SA[Q_3_1 * 1 * s_0 + x * Q_2_2 * s_1, Q_3_1 * 1 * c_0 + y * Q_2_2 * s_1, 4 * Q_2_1 * s_1]
    dZ_14 = -0.3046971996429772 * SA[Q_3_1 * 1 * c_0 + x * Q_2_2 * c_1, Q_3_1 * -1 * s_0 + y * Q_2_2 * c_1, 4 * Q_2_1 * c_1]
    Q_3_0 = 1.6666666666666667 * z * Q_2_0 - 0.6666666666666666 * r² * Q_1_0
    Z_13 = 0.7463526651802308Q_3_0
    dZ_13 = 0.7463526651802308 * SA[Q_2_1 * x, Q_2_1 * y, 3Q_2_0]
    Q_4_4 = -7 * Q_3_3
    Z_25 = 0.005960340337611202 * Q_4_4 * c_4
    Z_17 = 0.005960340337611202 * Q_4_4 * s_4
    Q_4_3 = 7 * z * Q_3_3
    Z_18 = -0.016858388283618388 * Q_4_3 * s_3
    Z_24 = -0.016858388283618388 * Q_4_3 * c_3
    dZ_25 = 0.005960340337611202 * Q_4_4 * SA[4c_3, -4 * s_3, zero(Float64)]
    dZ_17 = 0.005960340337611202 * Q_4_4 * SA[4s_3, 4c_3, zero(Float64)]
    dZ_18 = -0.016858388283618388 * SA[Q_4_3 * 3 * s_2, Q_4_3 * 3 * c_2, 7 * Q_3_3 * s_3]
    dZ_24 = -0.016858388283618388 * SA[Q_4_3 * 3 * c_2, Q_4_3 * -3 * s_2, 7 * Q_3_3 * c_3]
    Q_4_2 = 3.5 * z * Q_3_2 - 2.5 * r² * Q_2_2
    Z_19 = 0.063078313050504 * Q_4_2 * s_2
    Z_23 = 0.063078313050504 * Q_4_2 * c_2
    dZ_19 = 0.063078313050504 * SA[Q_4_2 * 2 * s_1 + x * Q_3_3 * s_2, Q_4_2 * 2 * c_1 + y * Q_3_3 * s_2, 6 * Q_3_2 * s_2]
    dZ_23 = 0.063078313050504 * SA[Q_4_2 * 2 * c_1 + x * Q_3_3 * c_2, Q_4_2 * -2 * s_1 + y * Q_3_3 * c_2, 6 * Q_3_2 * c_2]
    Q_4_1 = 2.3333333333333335 * z * Q_3_1 - 1.3333333333333333 * r² * Q_2_1
    Z_20 = -0.26761861742291565 * Q_4_1 * s_1
    Z_22 = -0.26761861742291565 * Q_4_1 * c_1
    dZ_20 = -0.26761861742291565 * SA[Q_4_1 * 1 * s_0 + x * Q_3_2 * s_1, Q_4_1 * 1 * c_0 + y * Q_3_2 * s_1, 5 * Q_3_1 * s_1]
    dZ_22 = -0.26761861742291565 * SA[Q_4_1 * 1 * c_0 + x * Q_3_2 * c_1, Q_4_1 * -1 * s_0 + y * Q_3_2 * c_1, 5 * Q_3_1 * c_1]
    Q_4_0 = 1.75 * z * Q_3_0 - 0.75 * r² * Q_2_0
    Z_21 = 0.8462843753216343Q_4_0
    dZ_21 = 0.8462843753216343 * SA[Q_3_1 * x, Q_3_1 * y, 4Q_3_0]
    Z = SVector{25, Float64}(Z_1, Z_2, Z_3, Z_4, Z_5, Z_6, Z_7, Z_8, Z_9, Z_10, Z_11, Z_12, Z_13, Z_14, Z_15, Z_16, Z_17, Z_18, Z_19, Z_20, Z_21, Z_22, Z_23, Z_24, Z_25)
    dZ = SVector{25, SVector{3, Float64}}(dZ_1, dZ_2, dZ_3, dZ_4, dZ_5, dZ_6, dZ_7, dZ_8, dZ_9, dZ_10, dZ_11, dZ_12, dZ_13, dZ_14, dZ_15, dZ_16, dZ_17, dZ_18, dZ_19, dZ_20, dZ_21, dZ_22, dZ_23, dZ_24, dZ_25)
    Z = SVector{25, TT}(Z_1, Z_2, Z_3, Z_4, Z_5, Z_6, Z_7, Z_8, Z_9, Z_10, Z_11, Z_12, Z_13, Z_14, Z_15, Z_16, Z_17, Z_18, Z_19, Z_20, Z_21, Z_22, Z_23, Z_24, Z_25)
    dZ = SVector{25, SVector{3, TT}}(dZ_1, dZ_2, dZ_3, dZ_4, dZ_5, dZ_6, dZ_7, dZ_8, dZ_9, dZ_10, dZ_11, dZ_12, dZ_13, dZ_14, dZ_15, dZ_16, dZ_17, dZ_18, dZ_19, dZ_20, dZ_21, dZ_22, dZ_23, dZ_24, dZ_25)
    return Z, dZ
end

# ============================================================================
# MODEL WEIGHTS (ETACE: readout weights only, no pair potential)
# ============================================================================

# Number of basis functions
const N_BASIS = 308

# B basis weights (per species)
const WB_1 = [10.521185624306716, 0.02800135370104853, 3.0602533687544744, 0.13408821944247096, 0.10238926042098395, -0.07354200669650839, 0.006770706368255776, -0.004102942904416811, 0.004839851388449864, -0.0011950332636661573, 0.00121736894884726, -0.0012229794451609711, -0.0005679831954589716, 0.0004776803088186766, 0.0009176866159935536, -0.00020005010471688933, -2.583292302772042, -5.047921516958533, -0.24286476042096963, 0.2039479113012493, 0.19992503925105046, -0.10432898017647285, -0.03820152390924855, -0.016498038629750255, -0.001785789605023942, 0.002850449302744258, 0.001395004047100078, 0.0010716249530605415, -0.0019931478739717893, -8.296171979707688e-5, 0.002078416706976993, -2.5034950534225073, -1.7705033986669874, -0.8808744730645242, -0.45654154792565693, -0.11836163892878648, 0.014144244330653444, 0.011271086760517912, 0.018453567901454523, -0.0026801375082913504, 0.0017054612042978442, -0.0023168884919698564, -0.00039666942544930534, 0.0012558007328639048, 0.11878957087210065, 0.007320000982488146, -0.13899159908560862, 0.06758341061555027, 0.033618447324765606, 0.0030591328422914787, 0.006281329968557191, -0.008737029149705679, -0.004923805074332214, -0.002736110684892006, -0.002717188279067214, -0.16448599157562824, -0.06546009145881346, 0.06668538859412, 0.023408566092746903, -0.00019573300934684526, 0.0016615956725125926, 0.003408968930884805, 0.0020617867853564994, 0.003305522120468377, -0.19931762838875303, -0.11758718874011116, 0.917252930064386, 0.30035526201629703, -0.21117963385203503, -0.14777202435148554, 0.05493198251340083, 0.06248861058216622, -0.02685985018222264, -0.0978622216489879, 0.04205685235816764, -0.013880921988162305, 0.006706114706974005, 0.005455804476240921, -0.002138138046153878, 0.0066636682116137, -0.17079122643195285, -0.0028221469690463586, 0.32580139403453795, -0.05453285343566728, -0.22141140299251577, 0.01678859130217692, 0.06652817425216115, -0.04622863600427626, -0.018292227591432904, -0.023886280657394465, -0.006168374375160107, 0.002846330112184114, -0.41050168406910936, 0.38740920959810815, 0.2619726504453236, -0.25600552676482174, -0.07520526917608206, -0.01007188412391088, -0.019570497783170267, 0.021070477483536975, 0.017550347674316888, -0.03874653607698915, 0.032640086285003, -0.0003977648090831904, -0.0012741019645086458, 0.0027767625803291527, 0.017798673472331904, 0.038734056481929166, -0.001976093883639876, 0.4734621881794067, 0.3773876735850865, -1.3383422480781944, -0.10305272511430734, 0.10756612375238764, -0.0690934979271439, -0.12255453864477703, -0.030976027812688964, -0.0025787907670163954, 0.022610860344608154, -0.0005695293024817439, 0.010421760336361557, -0.0076419177967059345, -0.0026116969981851506, 0.5681759243858279, 0.8375095038201461, -0.02766921427749966, -0.15779325192137605, -0.36462057051766283, -0.0646850790543178, -0.03372394128455916, 0.009860291313856764, 0.005722285701986787, 0.001721824107481008, 0.002524597939322421, -0.003565521202811787, 0.4399843813181981, 0.12397367951800035, -0.4450947538329828, -0.039912997883316016, -0.003820672349251494, -0.029006558837021013, 0.010715359843128937, -0.009023060511523783, -0.007361256523261077, -0.0004023488789816117, 0.059719416022559764, 0.11117099546814876, 0.14611569440488925, 0.07120012269535787, 0.020734847342694186, 0.0020197232175514627, 0.01544090065328002, 0.0015743709674008143, 0.2754406142948881, 0.22440006678390031, -0.6738570496115378, -0.20664911022823956, 0.1554400898675525, 0.021132049064601727, -0.05508447102177416, -0.025085951367667447, 0.06544901647191163, -0.11281603859616261, -0.006219369805877122, -0.019891897381130518, -0.0013017958110620232, -0.010958613832654583, -0.019320734680173157, -0.146013374832402, 0.005432628359823937, 0.054213987000489225, 0.0016702574260648861, -0.021936661485238478, -0.0015486174810257637, 0.023950081105216136, -0.00590291697634339, 0.01374102655723004, 0.070550081255443, -0.1499003515239608, -0.041603847282405904, 0.11887572282125276, 0.012758432913697796, -0.03503125654876584, -0.02711215803002152, 0.011074817577484687, 0.00017633702150126422, -0.0002973856700333189, 0.04867962164153719, 0.01676622843478757, 0.21324635725795163, 0.20277856137302244, -0.22492279722335987, -0.047614173280996167, 0.029596535112625815, -0.00986434711980675, 0.0057419833169574785, 0.004153788801992148, 0.0024047712294443823, 0.19876024228143344, 0.12527686768386959, 0.14863322735092227, 0.10558786504668635, 0.1274225384973733, 0.019692141389249934, 0.008059334766818556, -0.014875339463240673, -0.012706563101032171, 0.029673478039415852, -0.2183136729931537, -0.008847440665808778, -0.01874821375155645, -0.033150407169507116, -0.007775094124225624, 0.010332153102953942, -0.07069634607056625, 0.054140261382214, -0.02321867435928466, -0.08719098447083545, 0.004502564110595148, 0.0326369162807522, 0.046696582272162945, 0.0797134343363052, 0.020892066938938986, -0.061009805054725065, 0.02664766758371919, -0.0007431294756547567, 0.09067916649359302, -0.04707551966789141, -0.07207706890818434, 0.010787418182220973, 0.03892898395715085, -0.098381212712094, -0.021527682331693738, -0.022603192725392785, 0.07575231451779715, -0.05805740916227197, -0.06976219250809197, -0.05724930863579658, 0.0001889910861504345, -0.0010695112817084287, 0.4549356841185503, -0.014299744114999026, -0.2545440499646254, 0.13747918055151942, -0.016344611101169932, 0.01100592810503986, 0.004400022168465783, -0.010579158556856996, -0.027670307127963156, -0.01780545510906946, -0.0438543299874158, 0.07841346193220686, -0.007148426532091239, 0.00681671220107333, -0.4648529925720867, -0.4731202931907709, 0.5137749671233381, 0.1623528731549377, -0.16839980995704293, -0.009453368651480595, 0.19828887659635083, 0.015733047558323946, 0.010396748537016866, 0.019816137425486702, -0.0646882953889511, 0.16207294773542144, 0.050255985593277354, -0.0881128899998759, -0.14638777037300935, -0.05633952083438943, -0.14453684331507505, 0.10162455742709556, 0.05835272648942049, -0.03248516516229492, 0.12539082985227615, -0.003751560778286785, 0.010791515416962707, -0.07400852682566081, -0.18099529249692028, 0.10077054216006118, 0.13323000622214645, 0.014152719747892405, -0.04132437077767003, -0.0866432224127051, -0.04856002458381602, -0.06295076924025754, 0.11824853272837321, 0.05006284773941609, 0.009887990060052131, -0.02298881969728913, 0.028704654228620754, -0.1149873500797354, -0.015160200244481531, 0.0020119245562993933, -0.013927422285195624, -0.0002190422839056046, 0.09254585798544743, -0.29916291753694535, -0.0938889446859366, -0.01581395575763552, -0.020829910961772363, 0.002675033157200095, 0.08503942836951248, 0.0227059406835259, 0.11564919536142519, -0.0066052530654114585, -0.17334331008477186, 0.025248399838565777]
const WB_2 = [7.168346592052781, 4.608940307463971, 1.3393698444675832, -2.627335746588797, -0.31621716766826574, 0.08935783797833603, -0.011940734699955165, 0.22057175657521835, -0.0027761307620126525, -0.036199927239805245, -0.002453169999488064, -0.007249536235713781, 0.0008642010823128349, 0.008405769086307838, -0.00033524983429115155, -0.01037377331541068, 4.329331552149101, 10.5162989693235, -2.5468929645469407, -2.8228470854150025, -0.2854925169766058, 0.07643002084361647, 0.008950900806026353, 0.3059367240752523, -0.009800055985959217, -0.06272081556759833, -0.005458615848558645, 0.0001036734156083757, 0.002192940337644014, 0.015463093527937262, -0.0008575838555599975, 2.8601759506903965, -0.6179031836646646, -2.5482745201243517, -0.1973161894134731, -0.10390732208370763, 0.04869398593954663, 0.2931764543793642, -0.0033765403117594125, -0.07227418757277722, -0.008683399273421077, 0.0014045521984090736, -0.0013447333118650324, 0.017935982188079284, -0.5980747269055237, -0.7303949721184825, -0.005648990337219486, -0.01742070921392491, 0.015774207406874213, 0.08708004263632463, 0.013779013228944842, -0.028214027035655797, 0.002935458025345792, 0.0034124914785155125, -0.0013797954605827994, -0.5708380507841649, 0.12234926999138483, -0.1084394141396077, -0.024710758891715628, 0.038760250917327765, -0.02379108805446876, -0.010877000241004374, -0.002922563702776862, 0.002391685577764872, 0.002612177638247484, 0.40227677195610245, -0.6749514987369349, -1.25002579295081, -0.3607972472744145, -0.05122164210393413, 0.03753691393504567, 0.02149302387678634, 0.024226924272305623, 0.10963302577115239, 0.046246642328061416, 0.0036791492387600096, -0.11016126189230513, -0.017416917403261435, 0.02402651641424104, -0.009114253795877813, 0.3058725516050061, -0.937129869405445, -1.0725177145155431, -0.2795767227614829, -0.07560897388328225, -0.046010283449360125, -0.01792482496498708, 0.05484030652719174, 0.01961959962068316, -0.024957833713888627, 0.011546321768981632, 0.026132510709296588, 0.08860540473983364, 0.8011774822870212, 0.03986730478964717, 0.015687598354910456, -0.053011211079293186, 0.021692291999987956, -0.007884646153122336, -0.03573813074305482, 0.23971720296130208, 0.18528450009605946, 0.09222775963106805, 0.001415361430492567, 0.0068966561421420994, 0.0008673708378289238, 0.004125728616034819, 0.002956511560205106, -0.00026778189116439746, -0.2387599318679373, -1.5796423199041938, 0.6028497150199746, 0.9154999457568054, 0.1663038806723571, -0.2821614284734983, 0.07781834940473092, 0.306165483901071, -0.016639815386999362, -0.09475239445926897, -0.010948817641597516, 0.032998439648128555, 0.0030799771877522285, 0.027339440659938208, -1.5413398763098585, -0.0165176930362479, 0.8333476692127731, 0.0746454326637881, -0.08615341181063575, 0.13107254567188922, 0.29854644073867237, -0.020820565404758375, -0.13673799041012943, -0.020963431590794942, 0.03397293031886966, -0.0011352434329324629, -0.2435261335405505, -0.04793668099148207, -0.0005532270966244886, -0.318370036781884, 0.055130795077708974, 0.05331965288634689, 0.038516231195366124, -0.03979767815294598, 0.006210700969276756, 0.01990320704421622, -0.009859967647421957, -0.20054720767727946, -0.182858008839139, -0.08602373964007849, 0.016252053747348543, -0.049972308038649514, -0.02276182319374792, -0.00562269254267012, -0.08392732641668027, -0.13156922360383982, 0.3691891356959597, 0.2483979301323887, 0.022931912064337655, 0.012933897020663995, 0.022074296482376705, -0.015910743015114026, 0.05141536705972585, 0.0836152858440316, 0.04048186836751784, -0.0743235729101305, -0.03724133840820659, 0.04264424552230216, -0.187296050309449, 0.3806706704600115, 0.3780807676189001, 0.08050366489421074, -0.006081717189431408, 0.016361787691344207, 0.15206650635078545, 0.052577052390551104, 0.03193540854744512, 0.04003033551149454, -0.07541118276684156, -0.17803693662652795, 0.051264220504163786, 0.03760188212869785, 0.05696411645429373, 0.027913131481264866, -0.05254319271181678, -0.09842017214859837, -0.0005953458358972289, -0.002305833952796311, -0.23814887253381545, 0.19515286243003838, 0.43829458153020345, -0.07160158783020282, -0.2772202568115547, 0.14136343743128751, 0.3268688256056582, 0.005370005156419188, -0.15649834016758218, -0.016956779247295703, 0.034098862809341074, 0.665516009784306, 0.30014551849076604, 0.25559959923162784, -0.07770979369462765, 0.08555256664212484, 0.06974446764501406, 0.02745634472220944, -0.06313662652425245, 0.001282010274966242, 0.029970357369340738, -0.29197759448452676, -0.2599887027092082, -0.08175853397573199, -0.0012665361285694652, -0.03359641329203193, -0.02539445533378776, -0.08860132839416683, -0.12868291881983335, 0.2550829636979669, 0.4223895962887347, 0.09617344406017114, 0.05787053934167497, -0.053900970399363174, -0.08062220173202077, 0.15893756414757138, -0.019655456667154934, -0.07219000174693829, -0.012678213074628096, -0.02500618371982355, 0.2610944001477445, 0.32547554250978006, 0.015282299315964098, 0.033027070429112064, 0.014110202219615123, 0.03529251282874115, 0.0032286265288634496, -0.02269952528481932, -0.24608286117323902, -0.00988993300156795, 0.033333454334567456, -0.1056057884709007, -0.000609808593401045, 0.2771426051574248, -0.06749218503501436, 0.15938884721606028, -0.10590299408679016, 0.08560574929149177, 0.014104268652627506, 0.035430117384863416, -0.023394069122072488, -0.10251746958282333, -0.04908923140998023, -0.22062616887103367, -0.013096391890349888, -0.024208471371290882, -0.004875150323027888, 0.11150004869114383, 0.03105740819929586, -0.12436485339547951, 0.10711949644816873, 0.12081231614596664, -0.17088570583533974, 0.15513577893511765, 0.12025357076648782, 0.03360268240979147, 0.005320325044097761, 0.18731600442543567, -0.19894710731096976, -0.20203752728690028, 0.08785744819145239, -0.028326397185954925, 0.035981290275253784, -0.1355107378863762, -0.11092770949922265, 0.56529782777438, -0.15102137421722828, 0.11445327625343255, -0.05856355190956017, -0.0073870712501606615, 0.22268863173026943, 0.13990822491767704, -0.1171316977833994, -0.04690923539947956, 0.005236831267910087, -0.1423242952361415, 0.023197183860120298, 0.013666714815547638, 0.05814060576834122, -0.014962720066704738, -0.08790662811564495, 0.14711271341838994, -0.01828597239302423, 0.08320423542853858, -0.09610905744317448, -0.05565761981707926, 0.0041917830214942865, -0.009244093808520721, 0.0016328914233071216, 0.1407374720501486, 0.00200359259336515, 0.00373233996208955, 0.03639282734135801, -0.05642246121139365, 0.0006808392381505466, 0.1379344796064502, 0.05729689800706725, -0.02170207179711576, 0.03378636238333872, 0.025600178658332907, 0.06549925816843587]

# Note: ETACE has no pair potential (many-body only)

# ============================================================================
# REFERENCE ENERGIES (E0)
# ============================================================================

# Note: ETACE calculates many-body energy only. E0 contributions should be
# added separately using StackedCalculator with ETOneBody.
const E0_1 = 0.0  # Z=22
const E0_2 = 0.0  # Z=13

# ============================================================================
# PRE-ALLOCATED WORK ARRAYS (avoid allocations in hot paths)
# ============================================================================

const MAX_NEIGHBORS = 256  # Maximum number of neighbors per site

# Work arrays for embeddings (indexed as [neighbor, feature])
# Layout matches the abasis inner loop: Rnl[j, ϕ1] with j varying is contiguous
const WORK_Rnl = zeros(Float64, MAX_NEIGHBORS, N_RNL)
const WORK_dRnl = zeros(Float64, MAX_NEIGHBORS, N_RNL)
const WORK_Ylm = zeros(Float64, MAX_NEIGHBORS, N_YLM)
const WORK_dYlm = zeros(SVector{3, Float64}, MAX_NEIGHBORS, N_YLM)
const WORK_rs = zeros(Float64, MAX_NEIGHBORS)
const WORK_rhats = zeros(SVector{3, Float64}, MAX_NEIGHBORS)

# Work arrays for tensor evaluation
const WORK_A = zeros(Float64, 58)
const WORK_AA = zeros(Float64, 550)
const WORK_B = zeros(Float64, N_BASIS)

# Work arrays for pullback
const WORK_∂A = zeros(Float64, 58)
const WORK_∂AA = zeros(Float64, 550)
const WORK_∂Rnl = zeros(Float64, MAX_NEIGHBORS, N_RNL)
const WORK_∂Ylm = zeros(Float64, MAX_NEIGHBORS, N_YLM)
const WORK_∂B = zeros(Float64, N_BASIS)

# ============================================================================
# EVALUATION FUNCTIONS
# ============================================================================

# Compute embeddings for all neighbors (values only)
# Uses pre-allocated arrays, returns views
function compute_embeddings(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    nneigh = length(Rs)
    @assert nneigh <= MAX_NEIGHBORS "Too many neighbors: $nneigh > $MAX_NEIGHBORS"
    iz0 = z2i(Z0)

    # Get views into pre-allocated arrays
    Rnl = view(WORK_Rnl, 1:nneigh, :)
    Ylm = view(WORK_Ylm, 1:nneigh, :)

    @inbounds for j in 1:nneigh
        r = norm(Rs[j])
        if r > 1e-10
            jz = z2i(Zs[j])
            Rnl_j = evaluate_Rnl(r, iz0, jz)
            @simd for t in 1:N_RNL
                WORK_Rnl[j, t] = Rnl_j[t]
            end

            # Solid harmonics: evaluate with full R vector (not unit vector!)
            Ylm_j = eval_ylm(Rs[j])
            @simd for t in 1:N_YLM
                WORK_Ylm[j, t] = Ylm_j[t]
            end
        else
            # Zero out for this neighbor (r too small)
            @simd for t in 1:N_RNL
                WORK_Rnl[j, t] = 0.0
            end
            @simd for t in 1:N_YLM
                WORK_Ylm[j, t] = 0.0
            end
        end
    end

    return Rnl, Ylm
end

# Compute embeddings with derivatives for analytic forces
# Uses pre-allocated arrays, returns views
function compute_embeddings_ed(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    nneigh = length(Rs)
    @assert nneigh <= MAX_NEIGHBORS "Too many neighbors: $nneigh > $MAX_NEIGHBORS"
    iz0 = z2i(Z0)

    # Get views into pre-allocated arrays
    Rnl = view(WORK_Rnl, 1:nneigh, :)
    dRnl = view(WORK_dRnl, 1:nneigh, :)
    Ylm = view(WORK_Ylm, 1:nneigh, :)
    dYlm = view(WORK_dYlm, 1:nneigh, :)
    rs = view(WORK_rs, 1:nneigh)
    rhats = view(WORK_rhats, 1:nneigh)

    @inbounds for j in 1:nneigh
        r = norm(Rs[j])
        WORK_rs[j] = r
        if r > 1e-10
            rhat = Rs[j] / r
            WORK_rhats[j] = rhat
            jz = z2i(Zs[j])

            # Radial basis with derivative
            Rnl_j, dRnl_j = evaluate_Rnl_d(r, iz0, jz)
            @simd for t in 1:N_RNL
                WORK_Rnl[j, t] = Rnl_j[t]
                WORK_dRnl[j, t] = dRnl_j[t]
            end

            # Solid harmonics with derivatives (evaluated with full R vector)
            # dYlm returns dR_lm/dR directly (not dY_lm/dr̂)
            Ylm_j, dYlm_j = eval_ylm_ed(Rs[j])
            @simd for t in 1:N_YLM
                WORK_Ylm[j, t] = Ylm_j[t]
                WORK_dYlm[j, t] = dYlm_j[t]
            end
        else
            # Zero out for this neighbor (r too small)
            WORK_rhats[j] = zero(SVector{3, Float64})
            @simd for t in 1:N_RNL
                WORK_Rnl[j, t] = 0.0
                WORK_dRnl[j, t] = 0.0
            end
            @simd for t in 1:N_YLM
                WORK_Ylm[j, t] = 0.0
                WORK_dYlm[j, t] = zero(SVector{3, Float64})
            end
        end
    end

    return Rnl, dRnl, Ylm, dYlm, rs, rhats
end

# Site energy evaluation
function site_energy(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    iz0 = z2i(Z0)

    if length(Rs) == 0
        # Return E0 for isolated atom

        if iz0 == 1; return E0_1
        elseif iz0 == 2; return E0_2
        end
    end

    # Compute embeddings
    Rnl, Ylm = compute_embeddings(Rs, Zs, Z0)

    # Evaluate tensor (using manual inline evaluation, trim-safe)
    B, _ = tensor_evaluate(Rnl, Ylm)

    # Contract with weights
    val = 0.0

    if iz0 == 1
        val = dot(B, WB_1)
    elseif iz0 == 2
        val = dot(B, WB_2)
    end

    # Add reference energy

    if iz0 == 1; val += E0_1
    elseif iz0 == 2; val += E0_2
    end

    return val
end

# Site basis evaluation (returns raw basis vector without weight contraction)
function site_basis(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    if length(Rs) == 0
        # Return zeros for isolated atom
        return zeros(Float64, N_BASIS)
    end

    # Compute embeddings
    Rnl, Ylm = compute_embeddings(Rs, Zs, Z0)

    # Evaluate tensor (using manual inline evaluation, trim-safe)
    B, _ = tensor_evaluate(Rnl, Ylm)

    return collect(B)
end

# ============================================================================
# MANUAL PULLBACK FUNCTIONS (trim-safe)
# ============================================================================

# Static product with gradient (for SparseSymmProd pullback)
@inline function _static_prod_ed(b::NTuple{1, T}) where {T}
    return b[1], (one(T),)
end

@inline function _static_prod_ed(b::NTuple{2, T}) where {T}
    return b[1] * b[2], (b[2], b[1])
end

@inline function _static_prod_ed(b::NTuple{3, T}) where {T}
    p12 = b[1] * b[2]
    return p12 * b[3], (b[2] * b[3], b[1] * b[3], p12)
end

@inline function _static_prod_ed(b::NTuple{4, T}) where {T}
    p12 = b[1] * b[2]
    p34 = b[3] * b[4]
    return p12 * p34, (b[2] * p34, b[1] * p34, p12 * b[4], p12 * b[3])
end

# Manual pullback through PooledSparseProduct (abasis): ∂A -> (∂Rnl, ∂Ylm)
# This is the key function that replaces ET.pullback for the abasis
@inline function pullback_abasis!(∂Rnl, ∂Ylm, ∂A, Rnl, Ylm)
    nX = size(Rnl, 1)

    @inbounds for (iA, ϕ) in enumerate(ABASIS_SPEC)
        ϕ1, ϕ2 = ϕ  # (Rnl index, Ylm index)
        ∂A_iA = ∂A[iA]
        @simd ivdep for j = 1:nX
            ∂Rnl[j, ϕ1] += ∂A_iA * Ylm[j, ϕ2]
            ∂Ylm[j, ϕ2] += ∂A_iA * Rnl[j, ϕ1]
        end
    end
    return ∂Rnl, ∂Ylm
end

# Manual pullback through SparseSymmProd (aabasis): ∂AA -> ∂A
# Note: Accepts any array types to support views
@inline function pullback_aabasis!(∂A, ∂AA, A)

    # Order 1 terms (indices 1:16)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_1)
        i = 0 + i_local
        ∂AA_i = ∂AA[i]
        ∂A[ϕ[1]] += ∂AA_i
    end

    # Order 2 terms (indices 17:175)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_2)
        i = 16 + i_local
        ∂AA_i = ∂AA[i]
        a1, a2 = A[ϕ[1]], A[ϕ[2]]
        ∂A[ϕ[1]] += ∂AA_i * a2
        ∂A[ϕ[2]] += ∂AA_i * a1
    end

    # Order 3 terms (indices 176:550)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_3)
        i = 175 + i_local
        ∂AA_i = ∂AA[i]
        a1, a2, a3 = A[ϕ[1]], A[ϕ[2]], A[ϕ[3]]
        ∂A[ϕ[1]] += ∂AA_i * a2 * a3
        ∂A[ϕ[2]] += ∂AA_i * a1 * a3
        ∂A[ϕ[3]] += ∂AA_i * a1 * a2
    end

    return ∂A
end

# ============================================================================
# MANUAL FORWARD EVALUATION FUNCTIONS (trim-safe)
# ============================================================================

# Manual forward pass through PooledSparseProduct (abasis): (Rnl, Ylm) -> A
# This replaces ET.evaluate! for the abasis
@inline function evaluate_abasis!(A, Rnl, Ylm)
    nX = size(Rnl, 1)

    @inbounds for (iA, ϕ) in enumerate(ABASIS_SPEC)
        ϕ1, ϕ2 = ϕ  # (Rnl index, Ylm index)
        acc = 0.0
        @simd ivdep for j = 1:nX
            acc += Rnl[j, ϕ1] * Ylm[j, ϕ2]
        end
        A[iA] = acc
    end
    return A
end

# Manual forward pass through SparseSymmProd (aabasis): A -> AA
# This replaces ET.evaluate for the aabasis
# Note: Accepts any array types to support views
@inline function evaluate_aabasis!(AA, A)

    # Order 1 terms (indices 1:16)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_1)
        i = 0 + i_local
        AA[i] = A[ϕ[1]]
    end

    # Order 2 terms (indices 17:175)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_2)
        i = 16 + i_local
        AA[i] = A[ϕ[1]] * A[ϕ[2]]
    end

    # Order 3 terms (indices 176:550)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_3)
        i = 175 + i_local
        AA[i] = A[ϕ[1]] * A[ϕ[2]] * A[ϕ[3]]
    end

    return AA
end

# Full manual forward pass through tensor: (Rnl, Ylm) -> B
# This replaces ET.evaluate with a trim-safe implementation
# Uses pre-allocated work arrays to avoid allocations
function tensor_evaluate(Rnl, Ylm)
    # Reset and use pre-allocated arrays
    fill!(WORK_A, 0.0)
    fill!(WORK_AA, 0.0)
    fill!(WORK_B, 0.0)

    # Step 1: A = evaluate(abasis, Rnl, Ylm)
    evaluate_abasis!(WORK_A, Rnl, Ylm)

    # Step 2: AA = evaluate(aabasis, A)
    evaluate_aabasis!(WORK_AA, WORK_A)

    # Step 3: B = A2Bmap * AA (sparse matrix-vector multiplication)
    @inbounds for (idx, I) in enumerate(A2BMAP_1_I)
        J = A2BMAP_1_J[idx]
        V = A2BMAP_1_V[idx]
        WORK_B[I] += V * WORK_AA[J]
    end

    return WORK_B, WORK_A
end

# ============================================================================
# MANUAL PULLBACK FUNCTIONS (trim-safe)
# ============================================================================

# Full manual pullback through tensor: ∂B -> (∂Rnl, ∂Ylm)
# This replaces ET.pullback with a trim-safe implementation
# Uses pre-allocated work arrays to avoid allocations
function tensor_pullback!(∂Rnl, ∂Ylm, ∂B, Rnl, Ylm, A)
    # Reset pre-allocated arrays
    fill!(WORK_∂AA, 0.0)
    fill!(WORK_∂A, 0.0)

    # Step 1: ∂AA = A2Bmap' * ∂B (sparse transpose multiplication)
    @inbounds for (I_idx, I) in enumerate(A2BMAP_1_I)
        J = A2BMAP_1_J[I_idx]
        V = A2BMAP_1_V[I_idx]
        WORK_∂AA[J] += V * ∂B[I]  # Transpose: A2Bmap'[J,I] = A2Bmap[I,J]
    end

    # Step 2: ∂A = pullback_aabasis(∂AA, A)
    pullback_aabasis!(WORK_∂A, WORK_∂AA, A)

    # Step 3: (∂Rnl, ∂Ylm) = pullback_abasis(∂A, Rnl, Ylm)
    pullback_abasis!(∂Rnl, ∂Ylm, WORK_∂A, Rnl, Ylm)

    return ∂Rnl, ∂Ylm
end

# Site energy with ANALYTIC forces using manual pullback (trim-safe)
function site_energy_forces(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    iz0 = z2i(Z0)
    nneigh = length(Rs)

    if nneigh == 0
        # Return E0 for isolated atom, no forces

        if iz0 == 1; return E0_1, SVector{3, Float64}[]
        elseif iz0 == 2; return E0_2, SVector{3, Float64}[]
        end
    end

    # Compute embeddings with derivatives
    Rnl, dRnl, Ylm, dYlm, rs, rhats = compute_embeddings_ed(Rs, Zs, Z0)

    # Evaluate tensor (using manual inline evaluation, trim-safe)
    # Returns both B and A (A needed for pullback)
    B, A = tensor_evaluate(Rnl, Ylm)

    # Contract with weights to get energy
    # Use pre-allocated ∂B array
    fill!(WORK_∂B, 0.0)
    Ei = 0.0

    if iz0 == 1
        Ei = dot(B, WB_1)
        for k in 1:N_BASIS; WORK_∂B[k] = WB_1[k]; end  # ∂Ei/∂B = WB
    elseif iz0 == 2
        Ei = dot(B, WB_2)
        for k in 1:N_BASIS; WORK_∂B[k] = WB_2[k]; end  # ∂Ei/∂B = WB
    end

    # Backward pass through tensor using MANUAL pullback (trim-safe)
    # Use pre-allocated arrays for gradients
    ∂Rnl = view(WORK_∂Rnl, 1:nneigh, :)
    ∂Ylm = view(WORK_∂Ylm, 1:nneigh, :)
    @inbounds for j in 1:nneigh
        @simd for t in 1:N_RNL; WORK_∂Rnl[j, t] = 0.0; end
        @simd for t in 1:N_YLM; WORK_∂Ylm[j, t] = 0.0; end
    end
    tensor_pullback!(∂Rnl, ∂Ylm, WORK_∂B, Rnl, Ylm, A)

    # Assemble forces: ∂Ei/∂Rⱼ
    forces = Vector{SVector{3, Float64}}(undef, nneigh)
    @inbounds for j in 1:nneigh
        f = zero(SVector{3, Float64})
        r = rs[j]
        if r > 1e-10
            rhat = rhats[j]
            # Contribution from radial basis: ∂Ei/∂Rnl * dRnl/dr * r̂
            for t in 1:N_RNL
                f = f + (∂Rnl[j, t] * dRnl[j, t]) * rhat
            end
            # Contribution from solid harmonics: ∂Ei/∂R_lm * dR_lm/dR
            # (dYlm is dR_lm/dR for solid harmonics - direct gradient, no chain rule needed)
            for t in 1:N_YLM
                f = f + ∂Ylm[j, t] * dYlm[j, t]
            end
        end
        forces[j] = -f  # Force is negative gradient
    end

    # Add reference energy

    if iz0 == 1; Ei += E0_1
    elseif iz0 == 2; Ei += E0_2
    end

    return Ei, forces
end

# Site energy with forces AND virial stress using manual pullback (trim-safe)
function site_energy_forces_virial(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    iz0 = z2i(Z0)
    nneigh = length(Rs)

    # Initialize virial tensor (3x3 symmetric)
    virial = zeros(SMatrix{3, 3, Float64, 9})

    if nneigh == 0
        # Return E0 for isolated atom, no forces/virial

        if iz0 == 1; return E0_1, SVector{3, Float64}[], virial
        elseif iz0 == 2; return E0_2, SVector{3, Float64}[], virial
        end
    end

    # Compute embeddings with derivatives
    Rnl, dRnl, Ylm, dYlm, rs, rhats = compute_embeddings_ed(Rs, Zs, Z0)

    # Evaluate tensor (using manual inline evaluation, trim-safe)
    # Returns both B and A (A needed for pullback)
    B, A = tensor_evaluate(Rnl, Ylm)

    # Contract with weights to get energy
    # Use pre-allocated ∂B array
    fill!(WORK_∂B, 0.0)
    Ei = 0.0

    if iz0 == 1
        Ei = dot(B, WB_1)
        for k in 1:N_BASIS; WORK_∂B[k] = WB_1[k]; end  # ∂Ei/∂B = WB
    elseif iz0 == 2
        Ei = dot(B, WB_2)
        for k in 1:N_BASIS; WORK_∂B[k] = WB_2[k]; end  # ∂Ei/∂B = WB
    end

    # Backward pass through tensor using MANUAL pullback (trim-safe)
    # Use pre-allocated arrays for gradients
    ∂Rnl = view(WORK_∂Rnl, 1:nneigh, :)
    ∂Ylm = view(WORK_∂Ylm, 1:nneigh, :)
    @inbounds for j in 1:nneigh
        @simd for t in 1:N_RNL; WORK_∂Rnl[j, t] = 0.0; end
        @simd for t in 1:N_YLM; WORK_∂Ylm[j, t] = 0.0; end
    end
    tensor_pullback!(∂Rnl, ∂Ylm, WORK_∂B, Rnl, Ylm, A)

    # Assemble forces and virial
    forces = Vector{SVector{3, Float64}}(undef, nneigh)
    @inbounds for j in 1:nneigh
        f = zero(SVector{3, Float64})
        r = rs[j]
        if r > 1e-10
            rhat = rhats[j]
            Rj = Rs[j]
            # Contribution from radial basis
            for t in 1:N_RNL
                df = (∂Rnl[j, t] * dRnl[j, t]) * rhat
                f = f + df
                # Virial: -Rⱼ ⊗ fⱼ (outer product)
                virial = virial - Rj * df'
            end
            # Contribution from solid harmonics: ∂Ei/∂R_lm * dR_lm/dR
            for t in 1:N_YLM
                df = ∂Ylm[j, t] * dYlm[j, t]
                f = f + df
                virial = virial - Rj * df'
            end
        end
        forces[j] = -f
    end

    # Add reference energy

    if iz0 == 1; Ei += E0_1
    elseif iz0 == 2; Ei += E0_2
    end

    return Ei, forces, virial
end

# ============================================================================
# C INTERFACE FOR SHARED LIBRARY
# ============================================================================
#
# Two API levels:
# 1. SITE-LEVEL (for LAMMPS): Works with pre-computed neighbor lists
# 2. SYSTEM-LEVEL (for Python/ASE): Computes neighbor list internally

# ============================================================================
# HELPER FUNCTIONS FOR C INTERFACE
# ============================================================================

@inline function c_read_Rij(ptr::Ptr{Cdouble}, nneigh::Int)::Vector{SVector{3, Float64}}
    Rs = Vector{SVector{3, Float64}}(undef, nneigh)
    @inbounds for j in 1:nneigh
        x = unsafe_load(ptr, 3*(j-1) + 1)
        y = unsafe_load(ptr, 3*(j-1) + 2)
        z = unsafe_load(ptr, 3*(j-1) + 3)
        Rs[j] = SVector(x, y, z)
    end
    return Rs
end

@inline function c_read_species(ptr::Ptr{Cint}, n::Int)::Vector{Int}
    species = Vector{Int}(undef, n)
    @inbounds for i in 1:n
        species[i] = unsafe_load(ptr, i)
    end
    return species
end

@inline function c_write_forces!(ptr::Ptr{Cdouble}, forces::Vector{SVector{3, Float64}})
    @inbounds for j in 1:length(forces)
        unsafe_store!(ptr, forces[j][1], 3*(j-1) + 1)
        unsafe_store!(ptr, forces[j][2], 3*(j-1) + 2)
        unsafe_store!(ptr, forces[j][3], 3*(j-1) + 3)
    end
end

@inline function c_write_virial!(ptr::Ptr{Cdouble}, virial::SMatrix{3,3,Float64,9})
    # Voigt notation: xx, yy, zz, yz, xz, xy (LAMMPS convention)
    unsafe_store!(ptr, virial[1,1], 1)  # xx
    unsafe_store!(ptr, virial[2,2], 2)  # yy
    unsafe_store!(ptr, virial[3,3], 3)  # zz
    unsafe_store!(ptr, virial[2,3], 4)  # yz
    unsafe_store!(ptr, virial[1,3], 5)  # xz
    unsafe_store!(ptr, virial[1,2], 6)  # xy
end

# ============================================================================
# SITE-LEVEL C INTERFACE (for LAMMPS)
# ============================================================================
# These work directly with LAMMPS neighbor lists.
# Forces returned are forces ON the neighbors (not on the center atom).
# LAMMPS handles force accumulation via Newton's 3rd law.

Base.@ccallable function ace_site_energy(
    z0::Cint,
    nneigh::Cint,
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble}
)::Cdouble
    if nneigh == 0
        # Return E0 for isolated atom
        iz0 = z2i(z0)

        if iz0 == 1; return E0_1
        elseif iz0 == 2; return E0_2
        end
        return 0.0
    end

    Zs = c_read_species(neighbor_z, Int(nneigh))
    Rs = c_read_Rij(neighbor_Rij, Int(nneigh))

    return site_energy(Rs, Zs, Int(z0))
end

Base.@ccallable function ace_site_energy_forces(
    z0::Cint,
    nneigh::Cint,
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble},
    forces::Ptr{Cdouble}
)::Cdouble
    if nneigh == 0
        iz0 = z2i(z0)

        if iz0 == 1; return E0_1
        elseif iz0 == 2; return E0_2
        end
        return 0.0
    end

    Zs = c_read_species(neighbor_z, Int(nneigh))
    Rs = c_read_Rij(neighbor_Rij, Int(nneigh))

    Ei, Fi = site_energy_forces(Rs, Zs, Int(z0))

    # Write forces (these are -dE/dRj, the force ON neighbor j)
    c_write_forces!(forces, Fi)

    return Ei
end

Base.@ccallable function ace_site_energy_forces_virial(
    z0::Cint,
    nneigh::Cint,
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble},
    forces::Ptr{Cdouble},
    virial::Ptr{Cdouble}
)::Cdouble
    if nneigh == 0
        iz0 = z2i(z0)
        # Zero virial for isolated atom
        for k in 1:6
            unsafe_store!(virial, 0.0, k)
        end

        if iz0 == 1; return E0_1
        elseif iz0 == 2; return E0_2
        end
        return 0.0
    end

    Zs = c_read_species(neighbor_z, Int(nneigh))
    Rs = c_read_Rij(neighbor_Rij, Int(nneigh))

    Ei, Fi, Vi = site_energy_forces_virial(Rs, Zs, Int(z0))

    c_write_forces!(forces, Fi)
    c_write_virial!(virial, Vi)

    return Ei
end

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

Base.@ccallable function ace_get_cutoff()::Cdouble
    return RCUT_MAX
end

Base.@ccallable function ace_get_n_species()::Cint
    return Cint(NZ)
end

Base.@ccallable function ace_get_species(idx::Cint)::Cint
    if idx < 1 || idx > NZ
        return Cint(-1)
    end
    return Cint(I2Z[idx])
end

Base.@ccallable function ace_get_n_basis()::Cint
    return Cint(N_BASIS)
end

# ============================================================================
# BASIS EVALUATION (for descriptor computation)
# ============================================================================

Base.@ccallable function ace_site_basis(
    z0::Cint,
    nneigh::Cint,
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble},
    basis_out::Ptr{Cdouble}
)::Cint
    if nneigh == 0
        # Return zeros for isolated atom
        for k in 1:N_BASIS
            unsafe_store!(basis_out, 0.0, k)
        end
        return Cint(0)
    end

    Zs = c_read_species(neighbor_z, Int(nneigh))
    Rs = c_read_Rij(neighbor_Rij, Int(nneigh))

    B = site_basis(Rs, Zs, Int(z0))

    # Write basis to output buffer
    for k in 1:N_BASIS
        unsafe_store!(basis_out, B[k], k)
    end

    return Cint(0)  # Success
end

# ============================================================================
# BATCH API
# ============================================================================
# Process multiple atoms at once, reducing Python-Julia FFI call overhead.
# Note: Threads.@threads doesn't work with --trim=safe (closures are trimmed).
# For multi-threaded evaluation, use LAMMPS (OpenMP) or IPICalculator.

Base.@ccallable function ace_batch_energy_forces_virial(
    natoms::Cint,
    z::Ptr{Cint},
    neighbor_counts::Ptr{Cint},
    neighbor_offsets::Ptr{Cint},
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble},
    energies::Ptr{Cdouble},
    forces::Ptr{Cdouble},
    virials::Ptr{Cdouble}
)::Cvoid
    # Process atoms sequentially
    for i in 1:Int(natoms)
        z0 = unsafe_load(z, i)
        nneigh = Int(unsafe_load(neighbor_counts, i))
        offset = Int(unsafe_load(neighbor_offsets, i))  # 0-indexed from C

        if nneigh == 0
            # Isolated atom - return E0
            iz0 = z2i(z0)

            if iz0 == 1; E0 = E0_1
            elseif iz0 == 2; E0 = E0_2
            else; E0 = 0.0
            end
            unsafe_store!(energies, E0, i)
            # Zero virial
            for k in 1:6
                unsafe_store!(virials, 0.0, (i-1)*6 + k)
            end
        else
            # Read neighbor data for this atom
            Zs = Vector{Int}(undef, nneigh)
            Rs = Vector{SVector{3, Float64}}(undef, nneigh)

            @inbounds for j in 1:nneigh
                idx = offset + j  # 1-indexed from 0-indexed offset
                Zs[j] = unsafe_load(neighbor_z, idx)
                x = unsafe_load(neighbor_Rij, 3*(idx-1) + 1)
                y = unsafe_load(neighbor_Rij, 3*(idx-1) + 2)
                z_coord = unsafe_load(neighbor_Rij, 3*(idx-1) + 3)
                Rs[j] = SVector(x, y, z_coord)
            end

            # Compute energy, forces, virial
            Ei, Fi, Vi = site_energy_forces_virial(Rs, Zs, Int(z0))

            # Write outputs
            unsafe_store!(energies, Ei, i)

            # Forces for this atom's neighbors
            @inbounds for j in 1:nneigh
                idx = offset + j
                unsafe_store!(forces, Fi[j][1], 3*(idx-1) + 1)
                unsafe_store!(forces, Fi[j][2], 3*(idx-1) + 2)
                unsafe_store!(forces, Fi[j][3], 3*(idx-1) + 3)
            end

            # Virial in Voigt notation: xx, yy, zz, yz, xz, xy
            vbase = (i-1)*6
            unsafe_store!(virials, Vi[1,1], vbase + 1)
            unsafe_store!(virials, Vi[2,2], vbase + 2)
            unsafe_store!(virials, Vi[3,3], vbase + 3)
            unsafe_store!(virials, Vi[2,3], vbase + 4)
            unsafe_store!(virials, Vi[1,3], vbase + 5)
            unsafe_store!(virials, Vi[1,2], vbase + 6)
        end
    end
    return nothing
end


