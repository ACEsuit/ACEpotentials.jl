# ETACE Potential - Trim-compatible shared library export
# Generated by export_ace_model.jl
# Compile with: juliac --output-lib libace.so --trim=safe model.jl
#
# NOTE: This export is fully self-contained and trim=safe compatible.
# All spherical harmonics and radial basis evaluation code is inlined.
# No runtime dependency on SpheriCart, P4ML, or EquivariantTensors.

using StaticArrays
using StaticArrays: MVector
using LinearAlgebra: norm, dot

# ============================================================================
# MODEL CONSTANTS - Pre-computed from fitted ETACE model
# ============================================================================

# Species mapping: index -> atomic number
const I2Z = [22, 13]
const NZ = 2

# Helper to convert atomic number to index
@inline function z2i(Z::Integer)
    @inbounds for i in 1:NZ
        I2Z[i] == Z && return i
    end
    error("Unknown atomic number: $Z")
end

# PooledSparseProduct specification
const ABASIS_SPEC = [(1, 1), (17, 2), (17, 3), (17, 4), (30, 5), (30, 6), (30, 7), (30, 8), (30, 9), (2, 1), (18, 2), (18, 3), (18, 4), (31, 5), (31, 6), (31, 7), (31, 8), (31, 9), (3, 1), (19, 2), (19, 3), (19, 4), (32, 5), (32, 6), (32, 7), (32, 8), (32, 9), (4, 1), (20, 2), (20, 3), (20, 4), (5, 1), (21, 2), (21, 3), (21, 4), (6, 1), (22, 2), (22, 3), (22, 4), (7, 1), (23, 2), (23, 3), (23, 4), (8, 1), (24, 2), (24, 3), (24, 4), (9, 1), (25, 2), (25, 3), (25, 4), (10, 1), (11, 1), (12, 1), (13, 1), (14, 1), (15, 1), (16, 1)]

# SparseSymmProd specification (typed per order)
const AABASIS_SPECS_1 = ((1,), (10,), (19,), (28,), (32,), (36,), (40,), (44,), (48,), (52,), (53,), (54,), (55,), (56,), (57,), (58,),)  # Tuple of NTuple{1, Int}
const AABASIS_SPECS_2 = ((1, 1), (1, 10), (1, 19), (1, 28), (1, 32), (1, 36), (1, 40), (1, 44), (1, 48), (1, 52), (1, 53), (1, 54), (1, 55), (1, 56), (1, 57), (10, 10), (10, 19), (10, 28), (10, 32), (10, 36), (10, 40), (10, 44), (10, 48), (10, 52), (10, 53), (10, 54), (10, 55), (10, 56), (19, 19), (19, 28), (19, 32), (19, 36), (19, 40), (19, 44), (19, 48), (19, 52), (19, 53), (19, 54), (19, 55), (28, 28), (28, 32), (28, 36), (28, 40), (28, 44), (28, 48), (28, 52), (28, 53), (28, 54), (2, 2), (4, 4), (3, 3), (2, 11), (4, 13), (3, 12), (2, 20), (4, 22), (3, 21), (2, 29), (4, 31), (3, 30), (2, 33), (4, 35), (3, 34), (2, 37), (4, 39), (3, 38), (2, 41), (4, 43), (3, 42), (2, 45), (4, 47), (3, 46), (2, 49), (4, 51), (3, 50), (32, 32), (32, 36), (32, 40), (32, 44), (32, 48), (32, 52), (32, 53), (11, 11), (13, 13), (12, 12), (11, 20), (13, 22), (12, 21), (11, 29), (13, 31), (12, 30), (11, 33), (13, 35), (12, 34), (11, 37), (13, 39), (12, 38), (11, 41), (13, 43), (12, 42), (11, 45), (13, 47), (12, 46), (36, 36), (36, 40), (36, 44), (36, 48), (36, 52), (20, 20), (22, 22), (21, 21), (20, 29), (22, 31), (21, 30), (20, 33), (22, 35), (21, 34), (20, 37), (22, 39), (21, 38), (20, 41), (22, 43), (21, 42), (40, 40), (40, 44), (40, 48), (29, 29), (31, 31), (30, 30), (29, 33), (31, 35), (30, 34), (29, 37), (31, 39), (30, 38), (5, 5), (9, 9), (6, 6), (8, 8), (7, 7), (5, 14), (9, 18), (6, 15), (8, 17), (7, 16), (5, 23), (9, 27), (6, 24), (8, 26), (7, 25), (44, 44), (33, 33), (35, 35), (34, 34), (14, 14), (18, 18), (15, 15), (17, 17), (16, 16),)  # Tuple of NTuple{2, Int}
const AABASIS_SPECS_3 = ((1, 1, 1), (1, 1, 10), (1, 1, 19), (1, 1, 28), (1, 1, 32), (1, 1, 36), (1, 1, 40), (1, 1, 44), (1, 1, 48), (1, 1, 52), (1, 1, 53), (1, 1, 54), (1, 1, 55), (1, 1, 56), (1, 10, 10), (1, 10, 19), (1, 10, 28), (1, 10, 32), (1, 10, 36), (1, 10, 40), (1, 10, 44), (1, 10, 48), (1, 10, 52), (1, 10, 53), (1, 10, 54), (1, 10, 55), (1, 19, 19), (1, 19, 28), (1, 19, 32), (1, 19, 36), (1, 19, 40), (1, 19, 44), (1, 19, 48), (1, 19, 52), (1, 19, 53), (1, 19, 54), (1, 28, 28), (1, 28, 32), (1, 28, 36), (1, 28, 40), (1, 28, 44), (1, 28, 48), (1, 28, 52), (1, 28, 53), (1, 2, 2), (1, 4, 4), (1, 3, 3), (1, 2, 11), (1, 4, 13), (1, 3, 12), (1, 2, 20), (1, 4, 22), (1, 3, 21), (1, 2, 29), (1, 4, 31), (1, 3, 30), (1, 2, 33), (1, 4, 35), (1, 3, 34), (1, 2, 37), (1, 4, 39), (1, 3, 38), (1, 2, 41), (1, 4, 43), (1, 3, 42), (1, 2, 45), (1, 4, 47), (1, 3, 46), (1, 32, 32), (1, 32, 36), (1, 32, 40), (1, 32, 44), (1, 32, 48), (1, 32, 52), (1, 11, 11), (1, 13, 13), (1, 12, 12), (1, 11, 20), (1, 13, 22), (1, 12, 21), (1, 11, 29), (1, 13, 31), (1, 12, 30), (1, 11, 33), (1, 13, 35), (1, 12, 34), (1, 11, 37), (1, 13, 39), (1, 12, 38), (1, 11, 41), (1, 13, 43), (1, 12, 42), (1, 36, 36), (1, 36, 40), (1, 36, 44), (1, 36, 48), (1, 20, 20), (1, 22, 22), (1, 21, 21), (1, 20, 29), (1, 22, 31), (1, 21, 30), (1, 20, 33), (1, 22, 35), (1, 21, 34), (1, 20, 37), (1, 22, 39), (1, 21, 38), (1, 40, 40), (1, 40, 44), (1, 29, 29), (1, 31, 31), (1, 30, 30), (1, 29, 33), (1, 31, 35), (1, 30, 34), (1, 5, 5), (1, 9, 9), (1, 6, 6), (1, 8, 8), (1, 7, 7), (1, 5, 14), (1, 9, 18), (1, 6, 15), (1, 8, 17), (1, 7, 16), (10, 10, 10), (10, 10, 19), (10, 10, 28), (10, 10, 32), (10, 10, 36), (10, 10, 40), (10, 10, 44), (10, 10, 48), (10, 10, 52), (10, 10, 53), (10, 10, 54), (10, 19, 19), (10, 19, 28), (10, 19, 32), (10, 19, 36), (10, 19, 40), (10, 19, 44), (10, 19, 48), (10, 19, 52), (10, 19, 53), (10, 28, 28), (10, 28, 32), (10, 28, 36), (10, 28, 40), (10, 28, 44), (10, 28, 48), (10, 28, 52), (2, 2, 10), (4, 4, 10), (3, 3, 10), (2, 10, 11), (4, 10, 13), (3, 10, 12), (2, 10, 20), (4, 10, 22), (3, 10, 21), (2, 10, 29), (4, 10, 31), (3, 10, 30), (2, 10, 33), (4, 10, 35), (3, 10, 34), (2, 10, 37), (4, 10, 39), (3, 10, 38), (2, 10, 41), (4, 10, 43), (3, 10, 42), (10, 32, 32), (10, 32, 36), (10, 32, 40), (10, 32, 44), (10, 32, 48), (10, 11, 11), (10, 13, 13), (10, 12, 12), (10, 11, 20), (10, 13, 22), (10, 12, 21), (10, 11, 29), (10, 13, 31), (10, 12, 30), (10, 11, 33), (10, 13, 35), (10, 12, 34), (10, 11, 37), (10, 13, 39), (10, 12, 38), (10, 36, 36), (10, 36, 40), (10, 36, 44), (10, 20, 20), (10, 22, 22), (10, 21, 21), (10, 20, 29), (10, 22, 31), (10, 21, 30), (10, 20, 33), (10, 22, 35), (10, 21, 34), (10, 40, 40), (10, 29, 29), (10, 31, 31), (10, 30, 30), (5, 5, 10), (9, 9, 10), (6, 6, 10), (8, 8, 10), (7, 7, 10), (19, 19, 19), (19, 19, 28), (19, 19, 32), (19, 19, 36), (19, 19, 40), (19, 19, 44), (19, 19, 48), (19, 19, 52), (19, 28, 28), (19, 28, 32), (19, 28, 36), (19, 28, 40), (19, 28, 44), (19, 28, 48), (2, 2, 19), (4, 4, 19), (3, 3, 19), (2, 11, 19), (4, 13, 19), (3, 12, 19), (2, 19, 20), (4, 19, 22), (3, 19, 21), (2, 19, 29), (4, 19, 31), (3, 19, 30), (2, 19, 33), (4, 19, 35), (3, 19, 34), (2, 19, 37), (4, 19, 39), (3, 19, 38), (19, 32, 32), (19, 32, 36), (19, 32, 40), (19, 32, 44), (11, 11, 19), (13, 13, 19), (12, 12, 19), (11, 19, 20), (13, 19, 22), (12, 19, 21), (11, 19, 29), (13, 19, 31), (12, 19, 30), (11, 19, 33), (13, 19, 35), (12, 19, 34), (19, 36, 36), (19, 36, 40), (19, 20, 20), (19, 22, 22), (19, 21, 21), (19, 20, 29), (19, 22, 31), (19, 21, 30), (28, 28, 28), (28, 28, 32), (28, 28, 36), (28, 28, 40), (28, 28, 44), (2, 2, 28), (4, 4, 28), (3, 3, 28), (2, 11, 28), (4, 13, 28), (3, 12, 28), (2, 20, 28), (4, 22, 28), (3, 21, 28), (2, 28, 29), (4, 28, 31), (3, 28, 30), (2, 28, 33), (4, 28, 35), (3, 28, 34), (28, 32, 32), (28, 32, 36), (28, 32, 40), (11, 11, 28), (13, 13, 28), (12, 12, 28), (11, 20, 28), (13, 22, 28), (12, 21, 28), (11, 28, 29), (13, 28, 31), (12, 28, 30), (28, 36, 36), (20, 20, 28), (22, 22, 28), (21, 21, 28), (2, 2, 32), (4, 4, 32), (3, 3, 32), (2, 2, 36), (4, 4, 36), (3, 3, 36), (2, 2, 40), (4, 4, 40), (3, 3, 40), (2, 4, 5), (2, 2, 9), (4, 4, 9), (2, 3, 6), (3, 4, 8), (2, 2, 7), (4, 4, 7), (3, 3, 7), (2, 2, 44), (4, 4, 44), (3, 3, 44), (2, 4, 14), (2, 2, 18), (4, 4, 18), (2, 3, 15), (3, 4, 17), (2, 2, 16), (4, 4, 16), (3, 3, 16), (2, 11, 32), (4, 13, 32), (3, 12, 32), (2, 20, 32), (4, 22, 32), (3, 21, 32), (2, 29, 32), (4, 31, 32), (3, 30, 32), (2, 11, 36), (4, 13, 36), (3, 12, 36), (2, 11, 40), (4, 13, 40), (3, 12, 40), (4, 5, 11), (2, 5, 13), (2, 9, 11), (4, 9, 13), (3, 6, 11), (3, 8, 13), (2, 6, 12), (4, 8, 12), (2, 7, 11), (4, 7, 13), (3, 7, 12), (2, 20, 36), (4, 22, 36), (3, 21, 36), (32, 32, 32), (32, 32, 36), (11, 11, 32), (13, 13, 32), (12, 12, 32), (11, 20, 32), (13, 22, 32), (12, 21, 32), (11, 11, 36), (13, 13, 36), (12, 12, 36),)  # Tuple of NTuple{3, Int}
const AABASIS_RANGES = (1:16, 17:175, 176:550)
const AABASIS_HASCONST = false

# A2B coupling matrices (sparse format: I, J, V)
const A2BMAP_1_I = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 65, 65, 66, 66, 66, 67, 67, 67, 68, 68, 68, 69, 69, 69, 70, 70, 70, 71, 71, 71, 72, 72, 72, 73, 73, 73, 74, 75, 76, 77, 78, 79, 80, 81, 81, 81, 82, 82, 82, 83, 83, 83, 84, 84, 84, 85, 85, 85, 86, 86, 86, 87, 87, 87, 88, 89, 90, 91, 92, 93, 93, 93, 94, 94, 94, 95, 95, 95, 96, 96, 96, 97, 97, 97, 98, 99, 100, 101, 101, 101, 102, 102, 102, 103, 103, 103, 104, 104, 104, 104, 104, 105, 105, 105, 105, 105, 106, 106, 106, 106, 106, 107, 108, 108, 108, 109, 109, 109, 109, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 154, 154, 155, 155, 155, 156, 156, 156, 157, 157, 157, 158, 158, 158, 159, 159, 159, 160, 160, 160, 161, 161, 161, 162, 163, 164, 165, 166, 167, 168, 168, 168, 169, 169, 169, 170, 170, 170, 171, 171, 171, 172, 172, 172, 173, 173, 173, 174, 175, 176, 177, 178, 178, 178, 179, 179, 179, 180, 180, 180, 181, 181, 181, 182, 183, 184, 184, 184, 185, 185, 185, 186, 186, 186, 186, 186, 187, 187, 187, 187, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 215, 215, 216, 216, 216, 217, 217, 217, 218, 218, 218, 219, 219, 219, 220, 220, 220, 221, 221, 221, 222, 223, 224, 225, 226, 227, 227, 227, 228, 228, 228, 229, 229, 229, 230, 230, 230, 231, 231, 231, 232, 233, 234, 235, 235, 235, 236, 236, 236, 237, 237, 237, 238, 239, 239, 239, 240, 240, 240, 240, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 255, 255, 256, 256, 256, 257, 257, 257, 258, 258, 258, 259, 259, 259, 260, 260, 260, 261, 262, 263, 264, 265, 265, 265, 266, 266, 266, 267, 267, 267, 268, 268, 268, 269, 270, 271, 271, 271, 272, 272, 272, 273, 274, 275, 276, 277, 278, 278, 278, 279, 279, 279, 280, 280, 280, 281, 281, 281, 282, 282, 282, 283, 284, 285, 286, 286, 286, 287, 287, 287, 288, 288, 288, 289, 290, 290, 290, 291, 291, 291, 292, 292, 292, 293, 293, 293, 294, 294, 294, 294, 294, 294, 294, 294, 295, 295, 295, 296, 296, 296, 296, 296, 296, 296, 296, 297, 297, 297, 298, 298, 298, 299, 299, 299, 300, 300, 300, 301, 301, 301, 302, 302, 302, 302, 302, 302, 302, 302, 302, 302, 302, 303, 303, 303, 304, 305, 306, 306, 306, 307, 307, 307, 308, 308, 308]
const A2BMAP_1_J = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 385, 386, 387, 388, 389, 390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438, 439, 440, 441, 442, 443, 444, 445, 446, 447, 448, 449, 450, 451, 452, 453, 454, 455, 456, 457, 458, 459, 460, 461, 462, 463, 464, 465, 466, 467, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480, 481, 482, 483, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513, 514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 526, 527, 528, 529, 530, 531, 532, 533, 534, 535, 536, 537, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550]
const A2BMAP_1_V = [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.4472135954999577, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.4472135954999577, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.4472135954999577, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.4472135954999577, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 0.44721359549995765, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.8, -0.4, 0.4, 0.8, 0.8, -0.2309401076758503, -0.2309401076758503, 0.46188021535170065, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.8, -0.4, 0.4, 0.8, 0.8, -0.2309401076758503, -0.2309401076758503, 0.46188021535170065, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 0.3162277660168379, 0.3162277660168379, -0.3162277660168379, 0.3162277660168379, 0.3162277660168379, 0.3162277660168379, 0.3162277660168379, 0.3162277660168379, -0.18257418583505533, -0.18257418583505533, 0.3651483716701107, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, 1.0, 1.0, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258, -0.5773502691896257, -0.5773502691896257, -0.5773502691896258]
const A2BMAP_1_SIZE = (308, 550)

# ============================================================================
# RADIAL BASIS (ETACE: Agnesi transform + polynomial + linear weights)
# ============================================================================

const RCUT_MAX = 5.5

# Symmetric species pair indexing: (iz, jz) -> pair index
# For NZ=2: (1,1)->1, (1,2)->2, (2,2)->3
@inline function zz2pair_sym(iz::Int, jz::Int)::Int
    i, j = min(iz, jz), max(iz, jz)
    return (i - 1) * NZ - (i - 1) * (i - 2) ÷ 2 + (j - i + 1)
end

# Polynomial basis (orthonormalized Chebyshev)
# Uses 3-term recurrence: P[n+1] = (A[n]*y + B[n])*P[n] + C[n]*P[n-1]
const N_POLYS = 24
const POLY_A = SVector{24, Float64}([0.7071067811865478, 1.224744871391591, 1.9364916731037103, 1.9720265943665405, 1.984313483298445, 1.9899748742132426, 1.9930434571835678, 1.9948914348241364, 1.9960899278339157, 1.9969111950679388, 1.9974984355438197, 1.9979328159850847, 1.9982631347136353, 1.9985201625794757, 1.9987240828047488, 1.9988885800753289, 1.9990231989649363, 1.9991347609372287, 1.9992282461607338, 1.9993073592865893, 1.999374902313222, 1.9994330262111462, 1.9994834043566176, 1.9995273543594663])
const POLY_B = SVector{24, Float64}([0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0])
const POLY_C = SVector{24, Float64}([0.0, 0.0, -1.1180339887498971, -1.018350154434633, -1.0062305898749073, -1.0028530728448164, -1.0015420209622214, -1.0009272139219598, -1.0006007810695166, -1.0004114379931357, -1.0002940744071827, -1.0002174622185125, -1.0001653302483002, -1.0001286256356232, -1.0001020356106956, -1.0000823011400124, -1.0000673468701322, -1.0000558082429227, -1.0000467628422731, -1.000039571832787, -1.0000337832131325, -1.000029071035082, -1.0000251962155344, -1.000021980678988])

# Inline polynomial evaluation (trim-safe, no P4ML dependency)
# 3-term recurrence: P[n+1] = (A[n]*y + B[n])*P[n] + C[n]*P[n-1]
@inline function eval_polys(y::T) where {T}
    P = MVector{N_POLYS, T}(undef)
    @inbounds begin
        P[1] = one(T)
        if N_POLYS >= 2
            P[2] = (POLY_A[1] * y + POLY_B[1]) * P[1]
        end
        for n = 2:N_POLYS-1
            P[n+1] = (POLY_A[n] * y + POLY_B[n]) * P[n] + POLY_C[n] * P[n-1]
        end
    end
    return P
end

# Inline polynomial evaluation with derivatives (trim-safe)
# d(P[n])/dy computed via differentiation of recurrence relation
@inline function eval_polys_ed(y::T) where {T}
    P = MVector{N_POLYS, T}(undef)
    dP = MVector{N_POLYS, T}(undef)
    @inbounds begin
        P[1] = one(T)
        dP[1] = zero(T)
        if N_POLYS >= 2
            P[2] = (POLY_A[1] * y + POLY_B[1]) * P[1]
            dP[2] = POLY_A[1] * P[1] + (POLY_A[1] * y + POLY_B[1]) * dP[1]
        end
        for n = 2:N_POLYS-1
            P[n+1] = (POLY_A[n] * y + POLY_B[n]) * P[n] + POLY_C[n] * P[n-1]
            dP[n+1] = POLY_A[n] * P[n] + (POLY_A[n] * y + POLY_B[n]) * dP[n] + POLY_C[n] * dP[n-1]
        end
    end
    return P, dP
end

const N_RNL = 50

# Radial basis weights: W[n_rnl, n_polys] for each species pair
const RBASIS_W_1 = [1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]
const RBASIS_W_2 = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]
const RBASIS_W_3 = [1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]
const RBASIS_W_4 = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]

# Envelope: (1 - y^2)^2 for y ∈ [-1, 1]
@inline envelope(y::T) where {T} = (one(T) - y^2)^2
@inline envelope_d(y::T) where {T} = (one(T) - y^2)^2, -4 * y * (one(T) - y^2)

# Per-pair Agnesi transforms (trim-safe: all parameters are constants)
# Agnesi transform for pair 1: r -> y ∈ [-1, 1]
const AGNESI_1_RIN = 0.0
const AGNESI_1_REQ = 2.95
const AGNESI_1_RCUT = 5.5
const AGNESI_1_PIN = 2.0
const AGNESI_1_PCUT = 2.0
const AGNESI_1_A = 0.6666666666666666
const AGNESI_1_B0 = 2.726115702479339
const AGNESI_1_B1 = -3.726115702479339

@inline function eval_agnesi_1(r::T) where {T}
    if r <= AGNESI_1_RIN
        return one(T)
    end
    if r >= AGNESI_1_RCUT
        return -one(T)
    end
    s = (r - AGNESI_1_RIN) / (AGNESI_1_REQ - AGNESI_1_RIN)
    x = one(T) / (one(T) + AGNESI_1_A * s^AGNESI_1_PIN / (one(T) + s^(AGNESI_1_PIN - AGNESI_1_PCUT)))
    y = AGNESI_1_B1 * x + AGNESI_1_B0
    return clamp(y, -one(T), one(T))
end

@inline function eval_agnesi_d_1(r::T) where {T}
    if r <= AGNESI_1_RIN
        return one(T), zero(T)
    end
    if r >= AGNESI_1_RCUT
        return -one(T), zero(T)
    end

    rin = AGNESI_1_RIN
    req = AGNESI_1_REQ
    pin = AGNESI_1_PIN
    pcut = AGNESI_1_PCUT
    a = AGNESI_1_A
    b0 = AGNESI_1_B0
    b1 = AGNESI_1_B1

    s = (r - rin) / (req - rin)
    ds_dr = one(T) / (req - rin)

    # x = 1 / (1 + a * s^pin / (1 + s^(pin - pcut)))
    s_pin = s^pin
    s_diff = s^(pin - pcut)
    denom_inner = one(T) + s_diff
    denom = one(T) + a * s_pin / denom_inner
    x = one(T) / denom

    # y = b1 * x + b0
    y = b1 * x + b0

    # Derivative: dy/dr = b1 * dx/dr
    if s > 1e-10  # Avoid division by zero near s=0
        diff = pin - pcut
        ds_pin = pin * s^(pin - 1)
        ds_diff = diff > 0 ? diff * s^(diff - 1) : zero(T)
        d_denom_ds = a * (ds_pin * denom_inner - s_pin * ds_diff) / (denom_inner^2)
        dx_ds = -x^2 * d_denom_ds
        dy_ds = b1 * dx_ds
        dy_dr = dy_ds * ds_dr
    else
        dy_dr = zero(T)
    end

    if y <= -one(T) || y >= one(T)
        return clamp(y, -one(T), one(T)), zero(T)
    end
    return y, dy_dr
end

# Agnesi transform for pair 2: r -> y ∈ [-1, 1]
const AGNESI_2_RIN = 0.0
const AGNESI_2_REQ = 2.9
const AGNESI_2_RCUT = 5.5
const AGNESI_2_PIN = 2.0
const AGNESI_2_PCUT = 2.0
const AGNESI_2_A = 0.6666666666666666
const AGNESI_2_B0 = 2.6680991735537187
const AGNESI_2_B1 = -3.6680991735537187

@inline function eval_agnesi_2(r::T) where {T}
    if r <= AGNESI_2_RIN
        return one(T)
    end
    if r >= AGNESI_2_RCUT
        return -one(T)
    end
    s = (r - AGNESI_2_RIN) / (AGNESI_2_REQ - AGNESI_2_RIN)
    x = one(T) / (one(T) + AGNESI_2_A * s^AGNESI_2_PIN / (one(T) + s^(AGNESI_2_PIN - AGNESI_2_PCUT)))
    y = AGNESI_2_B1 * x + AGNESI_2_B0
    return clamp(y, -one(T), one(T))
end

@inline function eval_agnesi_d_2(r::T) where {T}
    if r <= AGNESI_2_RIN
        return one(T), zero(T)
    end
    if r >= AGNESI_2_RCUT
        return -one(T), zero(T)
    end

    rin = AGNESI_2_RIN
    req = AGNESI_2_REQ
    pin = AGNESI_2_PIN
    pcut = AGNESI_2_PCUT
    a = AGNESI_2_A
    b0 = AGNESI_2_B0
    b1 = AGNESI_2_B1

    s = (r - rin) / (req - rin)
    ds_dr = one(T) / (req - rin)

    # x = 1 / (1 + a * s^pin / (1 + s^(pin - pcut)))
    s_pin = s^pin
    s_diff = s^(pin - pcut)
    denom_inner = one(T) + s_diff
    denom = one(T) + a * s_pin / denom_inner
    x = one(T) / denom

    # y = b1 * x + b0
    y = b1 * x + b0

    # Derivative: dy/dr = b1 * dx/dr
    if s > 1e-10  # Avoid division by zero near s=0
        diff = pin - pcut
        ds_pin = pin * s^(pin - 1)
        ds_diff = diff > 0 ? diff * s^(diff - 1) : zero(T)
        d_denom_ds = a * (ds_pin * denom_inner - s_pin * ds_diff) / (denom_inner^2)
        dx_ds = -x^2 * d_denom_ds
        dy_ds = b1 * dx_ds
        dy_dr = dy_ds * ds_dr
    else
        dy_dr = zero(T)
    end

    if y <= -one(T) || y >= one(T)
        return clamp(y, -one(T), one(T)), zero(T)
    end
    return y, dy_dr
end

# Agnesi transform for pair 3: r -> y ∈ [-1, 1]
const AGNESI_3_RIN = 0.0
const AGNESI_3_REQ = 2.9
const AGNESI_3_RCUT = 5.5
const AGNESI_3_PIN = 2.0
const AGNESI_3_PCUT = 2.0
const AGNESI_3_A = 0.6666666666666666
const AGNESI_3_B0 = 2.6680991735537187
const AGNESI_3_B1 = -3.6680991735537187

@inline function eval_agnesi_3(r::T) where {T}
    if r <= AGNESI_3_RIN
        return one(T)
    end
    if r >= AGNESI_3_RCUT
        return -one(T)
    end
    s = (r - AGNESI_3_RIN) / (AGNESI_3_REQ - AGNESI_3_RIN)
    x = one(T) / (one(T) + AGNESI_3_A * s^AGNESI_3_PIN / (one(T) + s^(AGNESI_3_PIN - AGNESI_3_PCUT)))
    y = AGNESI_3_B1 * x + AGNESI_3_B0
    return clamp(y, -one(T), one(T))
end

@inline function eval_agnesi_d_3(r::T) where {T}
    if r <= AGNESI_3_RIN
        return one(T), zero(T)
    end
    if r >= AGNESI_3_RCUT
        return -one(T), zero(T)
    end

    rin = AGNESI_3_RIN
    req = AGNESI_3_REQ
    pin = AGNESI_3_PIN
    pcut = AGNESI_3_PCUT
    a = AGNESI_3_A
    b0 = AGNESI_3_B0
    b1 = AGNESI_3_B1

    s = (r - rin) / (req - rin)
    ds_dr = one(T) / (req - rin)

    # x = 1 / (1 + a * s^pin / (1 + s^(pin - pcut)))
    s_pin = s^pin
    s_diff = s^(pin - pcut)
    denom_inner = one(T) + s_diff
    denom = one(T) + a * s_pin / denom_inner
    x = one(T) / denom

    # y = b1 * x + b0
    y = b1 * x + b0

    # Derivative: dy/dr = b1 * dx/dr
    if s > 1e-10  # Avoid division by zero near s=0
        diff = pin - pcut
        ds_pin = pin * s^(pin - 1)
        ds_diff = diff > 0 ? diff * s^(diff - 1) : zero(T)
        d_denom_ds = a * (ds_pin * denom_inner - s_pin * ds_diff) / (denom_inner^2)
        dx_ds = -x^2 * d_denom_ds
        dy_ds = b1 * dx_ds
        dy_dr = dy_ds * ds_dr
    else
        dy_dr = zero(T)
    end

    if y <= -one(T) || y >= one(T)
        return clamp(y, -one(T), one(T)), zero(T)
    end
    return y, dy_dr
end

# Agnesi transform for pair 4: r -> y ∈ [-1, 1]
const AGNESI_4_RIN = 0.0
const AGNESI_4_REQ = 2.86
const AGNESI_4_RCUT = 5.5
const AGNESI_4_PIN = 2.0
const AGNESI_4_PCUT = 2.0
const AGNESI_4_A = 0.6666666666666666
const AGNESI_4_B0 = 2.6224000000000003
const AGNESI_4_B1 = -3.6224000000000003

@inline function eval_agnesi_4(r::T) where {T}
    if r <= AGNESI_4_RIN
        return one(T)
    end
    if r >= AGNESI_4_RCUT
        return -one(T)
    end
    s = (r - AGNESI_4_RIN) / (AGNESI_4_REQ - AGNESI_4_RIN)
    x = one(T) / (one(T) + AGNESI_4_A * s^AGNESI_4_PIN / (one(T) + s^(AGNESI_4_PIN - AGNESI_4_PCUT)))
    y = AGNESI_4_B1 * x + AGNESI_4_B0
    return clamp(y, -one(T), one(T))
end

@inline function eval_agnesi_d_4(r::T) where {T}
    if r <= AGNESI_4_RIN
        return one(T), zero(T)
    end
    if r >= AGNESI_4_RCUT
        return -one(T), zero(T)
    end

    rin = AGNESI_4_RIN
    req = AGNESI_4_REQ
    pin = AGNESI_4_PIN
    pcut = AGNESI_4_PCUT
    a = AGNESI_4_A
    b0 = AGNESI_4_B0
    b1 = AGNESI_4_B1

    s = (r - rin) / (req - rin)
    ds_dr = one(T) / (req - rin)

    # x = 1 / (1 + a * s^pin / (1 + s^(pin - pcut)))
    s_pin = s^pin
    s_diff = s^(pin - pcut)
    denom_inner = one(T) + s_diff
    denom = one(T) + a * s_pin / denom_inner
    x = one(T) / denom

    # y = b1 * x + b0
    y = b1 * x + b0

    # Derivative: dy/dr = b1 * dx/dr
    if s > 1e-10  # Avoid division by zero near s=0
        diff = pin - pcut
        ds_pin = pin * s^(pin - 1)
        ds_diff = diff > 0 ? diff * s^(diff - 1) : zero(T)
        d_denom_ds = a * (ds_pin * denom_inner - s_pin * ds_diff) / (denom_inner^2)
        dx_ds = -x^2 * d_denom_ds
        dy_ds = b1 * dx_ds
        dy_dr = dy_ds * ds_dr
    else
        dy_dr = zero(T)
    end

    if y <= -one(T) || y >= one(T)
        return clamp(y, -one(T), one(T)), zero(T)
    end
    return y, dy_dr
end

# Per-pair specialized radial basis functions (trim-safe)
@inline function evaluate_Rnl_1(r::T)::SVector{N_RNL, T} where {T}
    # Transform distance to y ∈ [-1, 1] (using specialized Agnesi)
    y = eval_agnesi_1(r)

    # Evaluate envelope
    env = envelope(y)
    if env <= zero(T)
        return zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials at y (inline, trim-safe)
    P = eval_polys(y)

    # Apply envelope and linear layer
    return RBASIS_W_1 * SVector{N_POLYS, T}(env .* P)
end

@inline function evaluate_Rnl_d_1(r::T)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    # Transform with derivative (using specialized Agnesi)
    y, dy_dr = eval_agnesi_d_1(r)

    # Envelope with derivative
    env, denv_dy = envelope_d(y)
    denv_dr = denv_dy * dy_dr

    if env <= zero(T)
        return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials with derivatives (inline, trim-safe)
    P, dP = eval_polys_ed(y)
    dP_dr = dP .* dy_dr

    # P_env = env * P, d(P_env)/dr = denv/dr * P + env * dP/dr
    P_env = env .* P
    dP_env_dr = denv_dr .* P .+ env .* dP_dr

    # Linear layer
    Rnl = RBASIS_W_1 * SVector{N_POLYS, T}(P_env)
    dRnl = RBASIS_W_1 * SVector{N_POLYS, T}(dP_env_dr)

    return Rnl, dRnl
end

@inline function evaluate_Rnl_2(r::T)::SVector{N_RNL, T} where {T}
    # Transform distance to y ∈ [-1, 1] (using specialized Agnesi)
    y = eval_agnesi_2(r)

    # Evaluate envelope
    env = envelope(y)
    if env <= zero(T)
        return zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials at y (inline, trim-safe)
    P = eval_polys(y)

    # Apply envelope and linear layer
    return RBASIS_W_2 * SVector{N_POLYS, T}(env .* P)
end

@inline function evaluate_Rnl_d_2(r::T)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    # Transform with derivative (using specialized Agnesi)
    y, dy_dr = eval_agnesi_d_2(r)

    # Envelope with derivative
    env, denv_dy = envelope_d(y)
    denv_dr = denv_dy * dy_dr

    if env <= zero(T)
        return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials with derivatives (inline, trim-safe)
    P, dP = eval_polys_ed(y)
    dP_dr = dP .* dy_dr

    # P_env = env * P, d(P_env)/dr = denv/dr * P + env * dP/dr
    P_env = env .* P
    dP_env_dr = denv_dr .* P .+ env .* dP_dr

    # Linear layer
    Rnl = RBASIS_W_2 * SVector{N_POLYS, T}(P_env)
    dRnl = RBASIS_W_2 * SVector{N_POLYS, T}(dP_env_dr)

    return Rnl, dRnl
end

@inline function evaluate_Rnl_3(r::T)::SVector{N_RNL, T} where {T}
    # Transform distance to y ∈ [-1, 1] (using specialized Agnesi)
    y = eval_agnesi_3(r)

    # Evaluate envelope
    env = envelope(y)
    if env <= zero(T)
        return zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials at y (inline, trim-safe)
    P = eval_polys(y)

    # Apply envelope and linear layer
    return RBASIS_W_3 * SVector{N_POLYS, T}(env .* P)
end

@inline function evaluate_Rnl_d_3(r::T)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    # Transform with derivative (using specialized Agnesi)
    y, dy_dr = eval_agnesi_d_3(r)

    # Envelope with derivative
    env, denv_dy = envelope_d(y)
    denv_dr = denv_dy * dy_dr

    if env <= zero(T)
        return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials with derivatives (inline, trim-safe)
    P, dP = eval_polys_ed(y)
    dP_dr = dP .* dy_dr

    # P_env = env * P, d(P_env)/dr = denv/dr * P + env * dP/dr
    P_env = env .* P
    dP_env_dr = denv_dr .* P .+ env .* dP_dr

    # Linear layer
    Rnl = RBASIS_W_3 * SVector{N_POLYS, T}(P_env)
    dRnl = RBASIS_W_3 * SVector{N_POLYS, T}(dP_env_dr)

    return Rnl, dRnl
end

@inline function evaluate_Rnl_4(r::T)::SVector{N_RNL, T} where {T}
    # Transform distance to y ∈ [-1, 1] (using specialized Agnesi)
    y = eval_agnesi_4(r)

    # Evaluate envelope
    env = envelope(y)
    if env <= zero(T)
        return zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials at y (inline, trim-safe)
    P = eval_polys(y)

    # Apply envelope and linear layer
    return RBASIS_W_4 * SVector{N_POLYS, T}(env .* P)
end

@inline function evaluate_Rnl_d_4(r::T)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    # Transform with derivative (using specialized Agnesi)
    y, dy_dr = eval_agnesi_d_4(r)

    # Envelope with derivative
    env, denv_dy = envelope_d(y)
    denv_dr = denv_dy * dy_dr

    if env <= zero(T)
        return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})
    end

    # Evaluate polynomials with derivatives (inline, trim-safe)
    P, dP = eval_polys_ed(y)
    dP_dr = dP .* dy_dr

    # P_env = env * P, d(P_env)/dr = denv/dr * P + env * dP/dr
    P_env = env .* P
    dP_env_dr = denv_dr .* P .+ env .* dP_dr

    # Linear layer
    Rnl = RBASIS_W_4 * SVector{N_POLYS, T}(P_env)
    dRnl = RBASIS_W_4 * SVector{N_POLYS, T}(dP_env_dr)

    return Rnl, dRnl
end

# Radial basis dispatch: r, iz, jz -> Rnl vector
@inline function evaluate_Rnl(r::T, iz::Int, jz::Int)::SVector{N_RNL, T} where {T}
    pair_idx = zz2pair_sym(iz, jz)

    if pair_idx == 1
        return evaluate_Rnl_1(r)
    elseif pair_idx == 2
        return evaluate_Rnl_2(r)
    elseif pair_idx == 3
        return evaluate_Rnl_3(r)
    elseif pair_idx == 4
        return evaluate_Rnl_4(r)
    end
    return zero(SVector{N_RNL, T})  # fallback
end

# Radial basis with derivatives dispatch
@inline function evaluate_Rnl_d(r::T, iz::Int, jz::Int)::Tuple{SVector{N_RNL, T}, SVector{N_RNL, T}} where {T}
    pair_idx = zz2pair_sym(iz, jz)

    if pair_idx == 1
        return evaluate_Rnl_d_1(r)
    elseif pair_idx == 2
        return evaluate_Rnl_d_2(r)
    elseif pair_idx == 3
        return evaluate_Rnl_d_3(r)
    elseif pair_idx == 4
        return evaluate_Rnl_d_4(r)
    end
    return zero(SVector{N_RNL, T}), zero(SVector{N_RNL, T})  # fallback
end
# ============================================================================
# SOLID HARMONICS (inline, trim-safe)
# ============================================================================
# Generated from SpheriCart v0.2.3 internals
# maxl = 4, normalisation = L2
#
# This code is derived from SpheriCart's recurrence relations but avoids
# Val-based dispatch for trim=safe compatibility.

const MAXL = 4
const N_YLM = 25

# Solid harmonics evaluation (values only)
@inline function eval_ylm(R::SVector{3, TT}) where {TT}
    x, y, z = R[1], R[2], R[3]

    r² = x ^ 2 + y ^ 2 + z ^ 2
    s_0 = zero(Float64)
    c_0 = one(Float64)
    s_1 = s_0 * x + c_0 * y
    c_1 = c_0 * x - s_0 * y
    s_2 = s_1 * x + c_1 * y
    c_2 = c_1 * x - s_1 * y
    s_3 = s_2 * x + c_2 * y
    c_3 = c_2 * x - s_2 * y
    s_4 = s_3 * x + c_3 * y
    c_4 = c_3 * x - s_3 * y
    c_0 = one(Float64) / 1.4142135623730951
    Q_0_0 = one(Float64)
    Z_1 = 0.28209479177387814Q_0_0
    Q_1_1 = -1 * Q_0_0
    Z_4 = -0.4886025119029199 * Q_1_1 * c_1
    Z_2 = -0.4886025119029199 * Q_1_1 * s_1
    Q_1_0 = 1 * z * Q_0_0
    Z_3 = 0.690988298942671 * Q_1_0 * s_0
    Z_3 = 0.690988298942671 * Q_1_0 * c_0
    Q_2_2 = -3 * Q_1_1
    Z_9 = 0.18209140509867988 * Q_2_2 * c_2
    Z_5 = 0.18209140509867988 * Q_2_2 * s_2
    Q_2_1 = 3 * z * Q_1_1
    Z_6 = -0.36418281019735976 * Q_2_1 * s_1
    Z_8 = -0.36418281019735976 * Q_2_1 * c_1
    Q_2_0 = 1.5 * z * Q_1_0 - 0.5 * r² * Q_0_0
    Z_7 = 0.8920620580763856 * Q_2_0 * s_0
    Z_7 = 0.8920620580763856 * Q_2_0 * c_0
    Q_3_3 = -5 * Q_2_2
    Z_16 = -0.03933623932844291 * Q_3_3 * c_3
    Z_10 = -0.03933623932844291 * Q_3_3 * s_3
    Q_3_2 = 5 * z * Q_2_2
    Z_11 = 0.09635371475468514 * Q_3_2 * s_2
    Z_15 = 0.09635371475468514 * Q_3_2 * c_2
    Q_3_1 = 2.5 * z * Q_2_1 - 1.5 * r² * Q_1_1
    Z_12 = -0.3046971996429772 * Q_3_1 * s_1
    Z_14 = -0.3046971996429772 * Q_3_1 * c_1
    Q_3_0 = 1.6666666666666667 * z * Q_2_0 - 0.6666666666666666 * r² * Q_1_0
    Z_13 = 1.055502061411188 * Q_3_0 * s_0
    Z_13 = 1.055502061411188 * Q_3_0 * c_0
    Q_4_4 = -7 * Q_3_3
    Z_25 = 0.005960340337611202 * Q_4_4 * c_4
    Z_17 = 0.005960340337611202 * Q_4_4 * s_4
    Q_4_3 = 7 * z * Q_3_3
    Z_18 = -0.016858388283618388 * Q_4_3 * s_3
    Z_24 = -0.016858388283618388 * Q_4_3 * c_3
    Q_4_2 = 3.5 * z * Q_3_2 - 2.5 * r² * Q_2_2
    Z_19 = 0.063078313050504 * Q_4_2 * s_2
    Z_23 = 0.063078313050504 * Q_4_2 * c_2
    Q_4_1 = 2.3333333333333335 * z * Q_3_1 - 1.3333333333333333 * r² * Q_2_1
    Z_20 = -0.26761861742291565 * Q_4_1 * s_1
    Z_22 = -0.26761861742291565 * Q_4_1 * c_1
    Q_4_0 = 1.75 * z * Q_3_0 - 0.75 * r² * Q_2_0
    Z_21 = 1.196826841204298 * Q_4_0 * s_0
    Z_21 = 1.196826841204298 * Q_4_0 * c_0
    return SVector{25, TT}(Z_1, Z_2, Z_3, Z_4, Z_5, Z_6, Z_7, Z_8, Z_9, Z_10, Z_11, Z_12, Z_13, Z_14, Z_15, Z_16, Z_17, Z_18, Z_19, Z_20, Z_21, Z_22, Z_23, Z_24, Z_25)
end

# Solid harmonics with gradients
@inline function eval_ylm_ed(R::SVector{3, TT}) where {TT}
    x, y, z = R[1], R[2], R[3]

    r² = x ^ 2 + y ^ 2 + z ^ 2
    s_0 = zero(Float64)
    c_0 = one(Float64)
    s_1 = s_0 * x + c_0 * y
    c_1 = c_0 * x - s_0 * y
    s_2 = s_1 * x + c_1 * y
    c_2 = c_1 * x - s_1 * y
    s_3 = s_2 * x + c_2 * y
    c_3 = c_2 * x - s_2 * y
    s_4 = s_3 * x + c_3 * y
    c_4 = c_3 * x - s_3 * y
    Q_0_0 = one(Float64)
    Z_1 = 0.28209479177387814Q_0_0
    dZ_1 = zero(SVector{3, Float64})
    Q_1_1 = -Q_0_0
    Z_4 = 0.4886025119029199c_1
    Z_2 = 0.4886025119029199s_1
    Q_1_0 = z
    Z_3 = 0.4886025119029199 * Q_1_0 * c_0
    dZ_4 = SA[0.4886025119029199, zero(Float64), zero(Float64)]
    dZ_2 = SA[zero(Float64), 0.4886025119029199, zero(Float64)]
    dZ_3 = SA[zero(Float64), zero(Float64), 0.4886025119029199]
    Q_2_2 = -3 * Q_1_1
    Z_9 = 0.18209140509867988 * Q_2_2 * c_2
    Z_5 = 0.18209140509867988 * Q_2_2 * s_2
    Q_2_1 = 3 * z * Q_1_1
    Z_6 = -0.36418281019735976 * Q_2_1 * s_1
    Z_8 = -0.36418281019735976 * Q_2_1 * c_1
    dZ_9 = 0.18209140509867988 * Q_2_2 * SA[2c_1, -2 * s_1, zero(Float64)]
    dZ_5 = 0.18209140509867988 * Q_2_2 * SA[2s_1, 2c_1, zero(Float64)]
    dZ_6 = -0.36418281019735976 * SA[Q_2_1 * 1 * s_0, Q_2_1 * 1 * c_0, 3 * Q_1_1 * s_1]
    dZ_8 = -0.36418281019735976 * SA[Q_2_1 * 1 * c_0, Q_2_1 * -1 * s_0, 3 * Q_1_1 * c_1]
    Q_2_0 = 1.5 * z * Q_1_0 - 0.5 * r² * Q_0_0
    Z_7 = 0.63078313050504Q_2_0
    dZ_7 = 0.63078313050504 * SA[Q_1_1 * x, Q_1_1 * y, 2Q_1_0]
    Q_3_3 = -5 * Q_2_2
    Z_16 = -0.03933623932844291 * Q_3_3 * c_3
    Z_10 = -0.03933623932844291 * Q_3_3 * s_3
    Q_3_2 = 5 * z * Q_2_2
    Z_11 = 0.09635371475468514 * Q_3_2 * s_2
    Z_15 = 0.09635371475468514 * Q_3_2 * c_2
    dZ_16 = -0.03933623932844291 * Q_3_3 * SA[3c_2, -3 * s_2, zero(Float64)]
    dZ_10 = -0.03933623932844291 * Q_3_3 * SA[3s_2, 3c_2, zero(Float64)]
    dZ_11 = 0.09635371475468514 * SA[Q_3_2 * 2 * s_1, Q_3_2 * 2 * c_1, 5 * Q_2_2 * s_2]
    dZ_15 = 0.09635371475468514 * SA[Q_3_2 * 2 * c_1, Q_3_2 * -2 * s_1, 5 * Q_2_2 * c_2]
    Q_3_1 = 2.5 * z * Q_2_1 - 1.5 * r² * Q_1_1
    Z_12 = -0.3046971996429772 * Q_3_1 * s_1
    Z_14 = -0.3046971996429772 * Q_3_1 * c_1
    dZ_12 = -0.3046971996429772 * SA[Q_3_1 * 1 * s_0 + x * Q_2_2 * s_1, Q_3_1 * 1 * c_0 + y * Q_2_2 * s_1, 4 * Q_2_1 * s_1]
    dZ_14 = -0.3046971996429772 * SA[Q_3_1 * 1 * c_0 + x * Q_2_2 * c_1, Q_3_1 * -1 * s_0 + y * Q_2_2 * c_1, 4 * Q_2_1 * c_1]
    Q_3_0 = 1.6666666666666667 * z * Q_2_0 - 0.6666666666666666 * r² * Q_1_0
    Z_13 = 0.7463526651802308Q_3_0
    dZ_13 = 0.7463526651802308 * SA[Q_2_1 * x, Q_2_1 * y, 3Q_2_0]
    Q_4_4 = -7 * Q_3_3
    Z_25 = 0.005960340337611202 * Q_4_4 * c_4
    Z_17 = 0.005960340337611202 * Q_4_4 * s_4
    Q_4_3 = 7 * z * Q_3_3
    Z_18 = -0.016858388283618388 * Q_4_3 * s_3
    Z_24 = -0.016858388283618388 * Q_4_3 * c_3
    dZ_25 = 0.005960340337611202 * Q_4_4 * SA[4c_3, -4 * s_3, zero(Float64)]
    dZ_17 = 0.005960340337611202 * Q_4_4 * SA[4s_3, 4c_3, zero(Float64)]
    dZ_18 = -0.016858388283618388 * SA[Q_4_3 * 3 * s_2, Q_4_3 * 3 * c_2, 7 * Q_3_3 * s_3]
    dZ_24 = -0.016858388283618388 * SA[Q_4_3 * 3 * c_2, Q_4_3 * -3 * s_2, 7 * Q_3_3 * c_3]
    Q_4_2 = 3.5 * z * Q_3_2 - 2.5 * r² * Q_2_2
    Z_19 = 0.063078313050504 * Q_4_2 * s_2
    Z_23 = 0.063078313050504 * Q_4_2 * c_2
    dZ_19 = 0.063078313050504 * SA[Q_4_2 * 2 * s_1 + x * Q_3_3 * s_2, Q_4_2 * 2 * c_1 + y * Q_3_3 * s_2, 6 * Q_3_2 * s_2]
    dZ_23 = 0.063078313050504 * SA[Q_4_2 * 2 * c_1 + x * Q_3_3 * c_2, Q_4_2 * -2 * s_1 + y * Q_3_3 * c_2, 6 * Q_3_2 * c_2]
    Q_4_1 = 2.3333333333333335 * z * Q_3_1 - 1.3333333333333333 * r² * Q_2_1
    Z_20 = -0.26761861742291565 * Q_4_1 * s_1
    Z_22 = -0.26761861742291565 * Q_4_1 * c_1
    dZ_20 = -0.26761861742291565 * SA[Q_4_1 * 1 * s_0 + x * Q_3_2 * s_1, Q_4_1 * 1 * c_0 + y * Q_3_2 * s_1, 5 * Q_3_1 * s_1]
    dZ_22 = -0.26761861742291565 * SA[Q_4_1 * 1 * c_0 + x * Q_3_2 * c_1, Q_4_1 * -1 * s_0 + y * Q_3_2 * c_1, 5 * Q_3_1 * c_1]
    Q_4_0 = 1.75 * z * Q_3_0 - 0.75 * r² * Q_2_0
    Z_21 = 0.8462843753216343Q_4_0
    dZ_21 = 0.8462843753216343 * SA[Q_3_1 * x, Q_3_1 * y, 4Q_3_0]
    Z = SVector{25, Float64}(Z_1, Z_2, Z_3, Z_4, Z_5, Z_6, Z_7, Z_8, Z_9, Z_10, Z_11, Z_12, Z_13, Z_14, Z_15, Z_16, Z_17, Z_18, Z_19, Z_20, Z_21, Z_22, Z_23, Z_24, Z_25)
    dZ = SVector{25, SVector{3, Float64}}(dZ_1, dZ_2, dZ_3, dZ_4, dZ_5, dZ_6, dZ_7, dZ_8, dZ_9, dZ_10, dZ_11, dZ_12, dZ_13, dZ_14, dZ_15, dZ_16, dZ_17, dZ_18, dZ_19, dZ_20, dZ_21, dZ_22, dZ_23, dZ_24, dZ_25)
    Z = SVector{25, TT}(Z_1, Z_2, Z_3, Z_4, Z_5, Z_6, Z_7, Z_8, Z_9, Z_10, Z_11, Z_12, Z_13, Z_14, Z_15, Z_16, Z_17, Z_18, Z_19, Z_20, Z_21, Z_22, Z_23, Z_24, Z_25)
    dZ = SVector{25, SVector{3, TT}}(dZ_1, dZ_2, dZ_3, dZ_4, dZ_5, dZ_6, dZ_7, dZ_8, dZ_9, dZ_10, dZ_11, dZ_12, dZ_13, dZ_14, dZ_15, dZ_16, dZ_17, dZ_18, dZ_19, dZ_20, dZ_21, dZ_22, dZ_23, dZ_24, dZ_25)
    return Z, dZ
end

# ============================================================================
# MODEL WEIGHTS (ETACE: readout weights only, no pair potential)
# ============================================================================

# Number of basis functions
const N_BASIS = 308

# B basis weights (per species)
const WB_1 = [34.03060384222418, -0.03877371482992582, -3.517241092900799, 0.44153107271299263, 1.31412064493364, 0.1227468060395665, -0.26153910713811607, -0.06990787609120827, -0.025603641266172556, 0.03502617683935682, -0.004892085880222299, 0.016079710191906488, 0.0004398379355075362, -0.006248561888767522, 0.013375365021250678, -0.0022613848012638963, -7.6056232451931525, -7.326128367160771, 0.7715467755870145, 0.2720841894869233, 1.2704128846139684, 0.1243872153449645, -0.34324759556384693, -0.0759277763573304, 0.013270632741933498, 0.05161615009459491, -0.01700249692396975, 0.014131281000762498, -0.0020681639065977136, -0.009717562450937422, 0.028134060711853946, -9.82928777545516, -4.771474291836533, 0.09462686408714065, 1.4830683564534475, 0.16319719881425956, -0.3015966314634804, -0.09867870560654142, -0.0038366402296633162, 0.06785886876278671, -0.004912492523254822, 0.02162665829926731, 0.007437212401269894, -0.014250513118889216, -0.6955196909944806, 2.0200830323208114, -0.35740557937990314, 0.11519164164469008, -0.03320571582945094, -0.06463621136823572, 0.04791266627425345, 0.007937074370895681, -0.007386543090507213, 0.004652509522164521, -0.00878683449281062, 0.0834090071230732, 0.731614330569629, 0.04759033523372781, -0.047536711656571286, 0.03919468324299683, 0.003341497548807618, 0.03229925676365114, 0.0075551673530672775, 0.0004922829090563282, -0.8130553476431234, -1.326160620372221, 1.1346072652663595, -0.7358594906288141, 0.4173469227613484, 0.44528524198664454, -0.12836096438067726, -0.30296449783382995, 0.07153891859833704, -0.2870315787466285, -0.03017878010186548, 0.09464987157777664, 0.0004931419647535907, 0.008210913432604399, -0.04227229522141786, 0.02652567607251792, -0.8332197628450546, 0.4083489899854303, 0.0748133312885942, -0.2412814556480069, -0.05635986217368595, -0.16448144873627613, -0.1360669823931918, -0.11796719057250246, -0.004040560690845979, 0.09724022902134352, -0.007435833289039044, -0.029204426377081014, -0.1424303744761046, 0.46869695196851735, 0.3953397534932615, -0.37012841247135064, 0.06728626039300281, -0.05382645350167534, -0.05032695243974292, -0.015322921518825408, -0.8955289112145913, 0.5602133993065511, 0.4291250674689618, 0.0048841294930075125, 0.03607772563924845, 0.003498210687826085, 0.04330159460924438, 0.13077292122823544, 0.024402318189647734, 1.7272518336090148, -0.630054718098338, -3.0339130556969, 0.5252709685603911, 0.4558102568657827, -0.21575261307277424, -0.30763208117006874, -0.01353154415512796, 0.1381582704381721, 0.08218025723728264, -0.04891602586498565, -0.014186648319450094, -0.007172135083991682, -0.01892011557544238, 3.9216291392245224, 0.5388312396836618, -2.1713118618729212, -0.4095700654146268, -0.067378700351903, -0.3518208614997941, -0.06916883737419487, 0.1108452778944492, 0.06947817503501375, -0.027869180638089085, -0.002794110782349399, 0.006886997032667012, 3.5587958751665503, 0.3887792281860055, -0.43744364931407564, -0.4033906813005583, -0.09314708549870003, -0.10408569335740293, 0.09199957179574361, 0.017903138723938842, -0.010925133337337812, -0.0021684528488386113, 0.7302706405922257, 0.2716037516416539, 0.27797098755795846, 0.07962242838403656, 0.15020643778288395, 0.06303969321093715, 0.049247702742879415, 0.0026133099220849933, 1.2447595027565286, 2.0362794489130684, -1.7225785611550857, -0.6879681661330613, 0.3345971451939315, 0.2788617478491727, -0.1639293492593563, -0.05237132298650326, 0.15574467271745243, -0.00514928372095239, -0.025452691867352748, -0.06495599924969424, -0.05922084961846815, -0.06749398459854242, 0.5875396860791468, -0.6791469463744502, 0.22939206982145785, 0.17376894537746423, 0.042463903823184476, -0.06870204255470283, -0.19301921270855285, -0.007334442367959234, 0.0899022886587391, -0.02911342882477257, -0.17705042972583615, -0.5922873771940463, -0.12086619228242192, 0.2683833351927285, -0.049315749300517596, -0.11952838487923953, -0.15390972077483348, -0.23816404020262752, -0.0039062030112360494, -0.009477257332885755, 2.3575522608133883, -1.135594728033597, -2.190920037012995, 1.0233095923882531, -0.03431488550006953, -0.40797028858881945, -0.11509462840235757, 0.06261344842168055, 0.12353135610730454, 0.020747951039379812, 0.010659696511139264, 0.14394615762027146, 0.6725366839108728, -0.03188063706395112, 0.27580000541755106, 0.04006386534733272, -0.020879684046194877, 0.09688510249954753, -0.0002835071181851238, -0.011914649631067508, 1.4869186710153812, -0.5716586028039454, -0.17158407901253023, -0.04307911092702236, 0.01888096498732541, 0.09068629235042149, 0.07246164757740546, 0.9190172415499946, 1.2186506196169307, -0.9339522260570067, 0.10080681079498112, 0.22481109274698816, -0.06019571746398147, -0.054052535465187214, 0.11558507588245633, 0.08600781025291708, -0.08356473639843424, 0.11339820926686763, -0.02354170164723651, 0.2913083802253356, -0.33775058207946335, 0.2952707078866777, 0.12694719018211378, -0.04379274379185807, -0.3064499345761492, -0.06286160807680972, 0.17041291806617914, 0.3845212766618685, 0.06649758163660872, -0.22822091357280863, -0.18109202973325567, 0.0892639025870759, 0.0017472177937536632, -1.0119646811130594, 0.11032343515358105, 0.07603741767735844, 0.04615534646343265, -0.03131851910887723, -0.049933700039438485, 0.012482389031961675, -0.011525562780825845, 0.711947611057298, -0.034911362042508894, -0.09148860308758182, 0.10997238196701141, 0.006956548529465759, 0.06850320822959127, -0.7283853670083357, -1.038236454497594, 1.049922095916338, 0.38917156357157284, -0.17181749374574373, -0.2612892106716594, 0.4865294833049238, 0.16037768538662098, -0.02676550828624288, 0.03721639982576292, -0.378861664427543, 0.2297212928704263, -0.31629687096641207, 0.24222587262791379, -0.33862429033012603, -0.05152339565404365, -0.2014607604871416, 0.10478392082902778, 0.2704491209765624, -1.1479003597921393, -0.013134390769004897, -0.1567506508533074, 0.09799482546744719, -1.3217782512530607, -2.2698585500363935, 1.036327630032803, 0.41983927625904766, -0.06758851032677345, -0.15822940382313214, -0.15704791003678137, -0.04262365251646929, -0.9113765667421565, 0.6386305195304944, 0.2212500463901912, 0.06915011310645428, -0.027462485350401817, 0.33100364881322486, 0.34460582545038476, 0.17773669632890401, 0.008575960809732452, 0.08791162969917093, 0.005502437498244193, 0.8547681017497069, -0.8479475129347355, -0.21453224854608335, 0.7967559596220662, 0.17123025207412665, 0.004985260002739355, -0.028470414606942933, 0.08055044316218349, 0.11719090671869777, 0.3852488148585116, -0.5953655502201954, 0.35454394505790937]
const WB_2 = [-9.926070636504086, -43.48049087049797, 4.410330800372971, 2.31096415522614, 0.5277887983976239, -1.1344597378731887, -0.20345186890034545, -0.009868741580572115, 0.08136781623694164, 0.06430847979501993, 0.03225423190889644, -0.029517357188292875, -0.011304660979351008, 0.015958015875097875, -0.00378969499144276, -0.001039639240793384, 8.555714386042629, 19.39912413825657, -0.37587287872468994, 4.314774394981976, 0.7738734508191571, -1.3598800093413868, -0.2708605935800207, 0.08568098868425242, 0.09190326113484744, 0.08101282383802566, 0.02609241077953622, -0.06351473977499315, -0.014158632615266236, 0.043082301539963036, 0.001354263134329688, 5.336421289398689, -2.3298786858849514, 0.6715023570546379, 0.6805191458732608, -0.8547615851294604, -0.20889699452305074, 0.08958643374934325, 0.11780449898003452, 0.06503856547695978, 0.024741989858649362, -0.04715637240240708, -0.023522060442608288, 0.043117407612224094, -2.826926998832537, 1.4977672312294745, 0.24779647722864948, -0.21531872920173223, 0.005103711734863386, -0.035362796255512106, 0.058498535259040904, 0.04720267916472468, 0.007886081720881297, -0.011262744335735441, -0.010562097128101772, 0.49060399177234637, -0.2969428361952776, -0.33356543964166374, -0.1324314298788182, -0.033999946088389174, 0.018650691656634747, 0.0012874771030659071, 0.009320443703133915, -0.006191318952154359, 1.1519835160951977, 0.6996802500911732, -1.842596093252542, -1.196087919787726, 0.5148331191638725, 0.12728151331742124, -0.6981767384974447, -0.36307511292897, 0.10516647096755478, 0.20349384026675707, 0.6268797932674314, 0.1098790975954979, -0.06750567305004174, -0.11036317371915833, -0.0735362484870628, -0.03297939229824672, 0.33022495381149664, -1.3644619673323821, -1.6083232226101374, 0.030965364423274907, 0.08358364725946814, -0.6633913261692778, -0.17461721496950394, 0.4482284972270962, 0.14666674842493402, 0.06668219970168232, -0.032774974012657485, -0.05422800353186885, -0.511776287664882, 0.5983423855657768, 0.18939663185558125, 0.6830658670797105, -0.03356586432684527, 0.05095870154599756, 0.01378984453501549, -0.027132131631480892, -0.42141322106047213, -0.21413910878011008, 0.4440283970438335, -0.029066652791070253, 0.007835188597459639, 0.006062193379281903, 0.005596721949382998, -0.005596745457877638, 0.01487013181704088, 0.15787858653146125, -3.5284325249939013, -2.124235849539607, 0.5946852168389958, 0.6504711385941429, -0.4115791963977087, -0.23594418719131155, 0.32715363027347355, -0.021451436602904616, 0.03682083963400324, -0.06093065034492478, -0.13000971705815548, -0.008265033005375455, 0.11430271799609304, -2.9943628501318247, -0.43076389204134036, 1.6296213803427477, 0.8419462831023234, -0.3189689137702747, -0.230566925525178, 0.4189108674777607, 0.015581462618775145, 0.04328451197518463, -0.054320309678603476, -0.10487800074183608, -0.027164081694160704, 2.7833372352167083, -0.02627315872703298, -0.5639374590228153, -0.18434138114226453, -0.017836280608752756, -0.027713090106160933, 0.09204762683182759, 0.07351289248193933, -0.008181774806670475, -0.021262647229060013, 0.2900716631432673, -0.7563122485334574, -0.6064209152228748, -0.17459966463866747, -0.016733470193696958, -0.03212446754047119, -0.008402089156195617, -0.020665442978263587, -0.4355109730242705, -0.023474348465421055, 0.6411677727830642, 0.2677107376054849, -0.10283332761871182, -0.18738691928263917, 0.23763305824561345, -0.0036206151465805417, -0.2662423348005359, 0.3930370553508174, -0.008322797769972658, -0.17561907816364405, -0.11838720830475476, -0.04954642894638252, -0.26293340125051046, 0.5003831013990978, 1.0477668916703786, 0.027868232109223512, -0.34913635030002727, 0.23992572766347658, 0.5771842568686607, 0.3013055759720958, 0.05121871039623448, 0.07273123363747985, 0.08011067855744268, -0.21968062515523293, 0.0012305546892483988, -0.16776393443997334, 0.0699968368121816, 0.03557857124872695, -0.11119241740721432, 0.09191428524372483, 0.004448420203383171, 0.0008537616890166675, 0.7260513005364239, -1.7568802814218196, -0.9408909827880974, 1.711536586278338, 0.6562200202675119, -0.2068691846088043, 0.11942769244070987, 0.12933848345697754, 0.002154123245464552, -0.010021132528576712, -0.05651138903614475, 1.6565287541523837, 0.01097028118439078, 0.4085007041586385, 0.3312217481467894, 0.07841495686864766, -0.008900922775832917, 0.08789657820572135, 0.034814178327322164, -0.012845715508038574, -0.42952649729004455, -1.0956575227972267, -0.025093765410796023, -0.3197947749713756, -0.023166374296589697, -0.0027253092323945654, -0.035702879810838424, -0.1382870912388812, 0.7755843803530365, 0.2444308515635454, -0.43279793663843774, 0.3620197629054997, 0.5747511474489246, -0.10883954131265447, -0.26851724243547287, 0.39021600301271575, -0.0748007761190765, -0.29166788423875695, -0.09880715807586746, 0.6080821829362886, 0.2399166008650398, 0.17472435207584192, 0.19231209908273642, 0.4575899700693078, 0.10639606262991327, 0.14234331665011496, 0.10427838833944773, -0.06565537939912078, -0.4942669510667518, -0.04052460823628506, -0.05730576398741387, -0.10303527718849505, 0.009771614639963873, -0.7890952075107481, -1.7809155313178653, -0.1718458062610959, 0.22720036567777466, 0.19024492984986455, -0.024045144953767274, 0.09652213159143916, 0.017877057192761534, 1.2300321278511424, -0.25105624764400564, -0.2596184468305381, 0.07584395223984633, -0.09008353494270883, 0.014427369697255782, 0.19718358988171006, -0.6907329089043891, 0.12474306809656759, 0.40434669898402065, -0.07653453456298087, -0.1935029612158222, 0.2937699932919866, 0.2539358711722417, -0.022130004216495525, 0.015866057063859344, -0.26125713983181015, 0.1120414290601425, -0.23040913207103267, -0.22597600289159073, -0.08846450795079407, 0.09525911556986529, -0.10599434205589527, 0.10143703201991175, 0.4376296135783761, -0.8593087735530512, 0.15913636849097465, -0.36993124464201393, 0.01816255002798533, 0.6484283380779854, -0.18390199382075695, -0.6421845715318593, 0.0839380430440777, -0.021255376482789932, -0.23272398406980543, 0.25451829877342835, -0.03793001103486992, -0.25091332372196096, 0.23628442435911495, -0.4046747748477098, 0.18954279410502495, 0.50451357840721, -0.1926792418722329, -0.45154393777554624, 0.26495001360921827, 0.012078255033801135, 0.09567461248583226, 0.0029732985385020234, 0.13052372956235503, 0.1464678052483309, -0.08386494678662122, -0.06636764363494253, 0.27616424397377953, 0.012063524917217112, 0.5058436728270785, -0.2829197679238242, -0.20142757480364973, 0.24017440531901502, 0.15885959691287121, 0.28559136668230123]

# Note: ETACE has no pair potential (many-body only)

# ============================================================================
# REFERENCE ENERGIES (E0)
# ============================================================================

# E0 values extracted from ETOneBody calculator
const E0_1 = -1586.0195  # Z=22
const E0_2 = -105.5954  # Z=13

# ============================================================================
# PRE-ALLOCATED WORK ARRAYS (avoid allocations in hot paths)
# ============================================================================

const MAX_NEIGHBORS = 256  # Maximum number of neighbors per site

# Work arrays for embeddings (indexed as [neighbor, feature])
# Layout matches the abasis inner loop: Rnl[j, ϕ1] with j varying is contiguous
const WORK_Rnl = zeros(Float64, MAX_NEIGHBORS, N_RNL)
const WORK_dRnl = zeros(Float64, MAX_NEIGHBORS, N_RNL)
const WORK_Ylm = zeros(Float64, MAX_NEIGHBORS, N_YLM)
const WORK_dYlm = zeros(SVector{3, Float64}, MAX_NEIGHBORS, N_YLM)
const WORK_rs = zeros(Float64, MAX_NEIGHBORS)
const WORK_rhats = zeros(SVector{3, Float64}, MAX_NEIGHBORS)

# Work arrays for tensor evaluation
const WORK_A = zeros(Float64, 58)
const WORK_AA = zeros(Float64, 550)
const WORK_B = zeros(Float64, N_BASIS)

# Work arrays for pullback
const WORK_∂A = zeros(Float64, 58)
const WORK_∂AA = zeros(Float64, 550)
const WORK_∂Rnl = zeros(Float64, MAX_NEIGHBORS, N_RNL)
const WORK_∂Ylm = zeros(Float64, MAX_NEIGHBORS, N_YLM)
const WORK_∂B = zeros(Float64, N_BASIS)

# ============================================================================
# EVALUATION FUNCTIONS
# ============================================================================

# Compute embeddings for all neighbors (values only)
# Uses pre-allocated arrays, returns views
function compute_embeddings(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    nneigh = length(Rs)
    @assert nneigh <= MAX_NEIGHBORS "Too many neighbors: $nneigh > $MAX_NEIGHBORS"
    iz0 = z2i(Z0)

    # Get views into pre-allocated arrays
    Rnl = view(WORK_Rnl, 1:nneigh, :)
    Ylm = view(WORK_Ylm, 1:nneigh, :)

    @inbounds for j in 1:nneigh
        r = norm(Rs[j])
        if r > 1e-10
            jz = z2i(Zs[j])
            Rnl_j = evaluate_Rnl(r, iz0, jz)
            @simd for t in 1:N_RNL
                WORK_Rnl[j, t] = Rnl_j[t]
            end

            # Solid harmonics: evaluate with full R vector (not unit vector!)
            Ylm_j = eval_ylm(Rs[j])
            @simd for t in 1:N_YLM
                WORK_Ylm[j, t] = Ylm_j[t]
            end
        else
            # Zero out for this neighbor (r too small)
            @simd for t in 1:N_RNL
                WORK_Rnl[j, t] = 0.0
            end
            @simd for t in 1:N_YLM
                WORK_Ylm[j, t] = 0.0
            end
        end
    end

    return Rnl, Ylm
end

# Compute embeddings with derivatives for analytic forces
# Uses pre-allocated arrays, returns views
function compute_embeddings_ed(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    nneigh = length(Rs)
    @assert nneigh <= MAX_NEIGHBORS "Too many neighbors: $nneigh > $MAX_NEIGHBORS"
    iz0 = z2i(Z0)

    # Get views into pre-allocated arrays
    Rnl = view(WORK_Rnl, 1:nneigh, :)
    dRnl = view(WORK_dRnl, 1:nneigh, :)
    Ylm = view(WORK_Ylm, 1:nneigh, :)
    dYlm = view(WORK_dYlm, 1:nneigh, :)
    rs = view(WORK_rs, 1:nneigh)
    rhats = view(WORK_rhats, 1:nneigh)

    @inbounds for j in 1:nneigh
        r = norm(Rs[j])
        WORK_rs[j] = r
        if r > 1e-10
            rhat = Rs[j] / r
            WORK_rhats[j] = rhat
            jz = z2i(Zs[j])

            # Radial basis with derivative
            Rnl_j, dRnl_j = evaluate_Rnl_d(r, iz0, jz)
            @simd for t in 1:N_RNL
                WORK_Rnl[j, t] = Rnl_j[t]
                WORK_dRnl[j, t] = dRnl_j[t]
            end

            # Solid harmonics with derivatives (evaluated with full R vector)
            # dYlm returns dR_lm/dR directly (not dY_lm/dr̂)
            Ylm_j, dYlm_j = eval_ylm_ed(Rs[j])
            @simd for t in 1:N_YLM
                WORK_Ylm[j, t] = Ylm_j[t]
                WORK_dYlm[j, t] = dYlm_j[t]
            end
        else
            # Zero out for this neighbor (r too small)
            WORK_rhats[j] = zero(SVector{3, Float64})
            @simd for t in 1:N_RNL
                WORK_Rnl[j, t] = 0.0
                WORK_dRnl[j, t] = 0.0
            end
            @simd for t in 1:N_YLM
                WORK_Ylm[j, t] = 0.0
                WORK_dYlm[j, t] = zero(SVector{3, Float64})
            end
        end
    end

    return Rnl, dRnl, Ylm, dYlm, rs, rhats
end

# Site energy evaluation
function site_energy(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    iz0 = z2i(Z0)

    if length(Rs) == 0
        # Return E0 for isolated atom

        if iz0 == 1; return E0_1
        elseif iz0 == 2; return E0_2
        end
    end

    # Compute embeddings
    Rnl, Ylm = compute_embeddings(Rs, Zs, Z0)

    # Evaluate tensor (using manual inline evaluation, trim-safe)
    B, _ = tensor_evaluate(Rnl, Ylm)

    # Contract with weights
    val = 0.0

    if iz0 == 1
        val = dot(B, WB_1)
    elseif iz0 == 2
        val = dot(B, WB_2)
    end

    # Add reference energy

    if iz0 == 1; val += E0_1
    elseif iz0 == 2; val += E0_2
    end

    return val
end

# Site basis evaluation (returns raw basis vector without weight contraction)
function site_basis(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    if length(Rs) == 0
        # Return zeros for isolated atom
        return zeros(Float64, N_BASIS)
    end

    # Compute embeddings
    Rnl, Ylm = compute_embeddings(Rs, Zs, Z0)

    # Evaluate tensor (using manual inline evaluation, trim-safe)
    B, _ = tensor_evaluate(Rnl, Ylm)

    return collect(B)
end

# ============================================================================
# MANUAL PULLBACK FUNCTIONS (trim-safe)
# ============================================================================

# Static product with gradient (for SparseSymmProd pullback)
@inline function _static_prod_ed(b::NTuple{1, T}) where {T}
    return b[1], (one(T),)
end

@inline function _static_prod_ed(b::NTuple{2, T}) where {T}
    return b[1] * b[2], (b[2], b[1])
end

@inline function _static_prod_ed(b::NTuple{3, T}) where {T}
    p12 = b[1] * b[2]
    return p12 * b[3], (b[2] * b[3], b[1] * b[3], p12)
end

@inline function _static_prod_ed(b::NTuple{4, T}) where {T}
    p12 = b[1] * b[2]
    p34 = b[3] * b[4]
    return p12 * p34, (b[2] * p34, b[1] * p34, p12 * b[4], p12 * b[3])
end

# Manual pullback through PooledSparseProduct (abasis): ∂A -> (∂Rnl, ∂Ylm)
# This is the key function that replaces ET.pullback for the abasis
@inline function pullback_abasis!(∂Rnl, ∂Ylm, ∂A, Rnl, Ylm)
    nX = size(Rnl, 1)

    @inbounds for (iA, ϕ) in enumerate(ABASIS_SPEC)
        ϕ1, ϕ2 = ϕ  # (Rnl index, Ylm index)
        ∂A_iA = ∂A[iA]
        @simd ivdep for j = 1:nX
            ∂Rnl[j, ϕ1] += ∂A_iA * Ylm[j, ϕ2]
            ∂Ylm[j, ϕ2] += ∂A_iA * Rnl[j, ϕ1]
        end
    end
    return ∂Rnl, ∂Ylm
end

# Manual pullback through SparseSymmProd (aabasis): ∂AA -> ∂A
# Note: Accepts any array types to support views
@inline function pullback_aabasis!(∂A, ∂AA, A)

    # Order 1 terms (indices 1:16)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_1)
        i = 0 + i_local
        ∂AA_i = ∂AA[i]
        ∂A[ϕ[1]] += ∂AA_i
    end

    # Order 2 terms (indices 17:175)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_2)
        i = 16 + i_local
        ∂AA_i = ∂AA[i]
        a1, a2 = A[ϕ[1]], A[ϕ[2]]
        ∂A[ϕ[1]] += ∂AA_i * a2
        ∂A[ϕ[2]] += ∂AA_i * a1
    end

    # Order 3 terms (indices 176:550)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_3)
        i = 175 + i_local
        ∂AA_i = ∂AA[i]
        a1, a2, a3 = A[ϕ[1]], A[ϕ[2]], A[ϕ[3]]
        ∂A[ϕ[1]] += ∂AA_i * a2 * a3
        ∂A[ϕ[2]] += ∂AA_i * a1 * a3
        ∂A[ϕ[3]] += ∂AA_i * a1 * a2
    end

    return ∂A
end

# ============================================================================
# MANUAL FORWARD EVALUATION FUNCTIONS (trim-safe)
# ============================================================================

# Manual forward pass through PooledSparseProduct (abasis): (Rnl, Ylm) -> A
# This replaces ET.evaluate! for the abasis
@inline function evaluate_abasis!(A, Rnl, Ylm)
    nX = size(Rnl, 1)

    @inbounds for (iA, ϕ) in enumerate(ABASIS_SPEC)
        ϕ1, ϕ2 = ϕ  # (Rnl index, Ylm index)
        acc = 0.0
        @simd ivdep for j = 1:nX
            acc += Rnl[j, ϕ1] * Ylm[j, ϕ2]
        end
        A[iA] = acc
    end
    return A
end

# Manual forward pass through SparseSymmProd (aabasis): A -> AA
# This replaces ET.evaluate for the aabasis
# Note: Accepts any array types to support views
@inline function evaluate_aabasis!(AA, A)

    # Order 1 terms (indices 1:16)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_1)
        i = 0 + i_local
        AA[i] = A[ϕ[1]]
    end

    # Order 2 terms (indices 17:175)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_2)
        i = 16 + i_local
        AA[i] = A[ϕ[1]] * A[ϕ[2]]
    end

    # Order 3 terms (indices 176:550)
    @inbounds for (i_local, ϕ) in enumerate(AABASIS_SPECS_3)
        i = 175 + i_local
        AA[i] = A[ϕ[1]] * A[ϕ[2]] * A[ϕ[3]]
    end

    return AA
end

# Full manual forward pass through tensor: (Rnl, Ylm) -> B
# This replaces ET.evaluate with a trim-safe implementation
# Uses pre-allocated work arrays to avoid allocations
function tensor_evaluate(Rnl, Ylm)
    # Reset and use pre-allocated arrays
    fill!(WORK_A, 0.0)
    fill!(WORK_AA, 0.0)
    fill!(WORK_B, 0.0)

    # Step 1: A = evaluate(abasis, Rnl, Ylm)
    evaluate_abasis!(WORK_A, Rnl, Ylm)

    # Step 2: AA = evaluate(aabasis, A)
    evaluate_aabasis!(WORK_AA, WORK_A)

    # Step 3: B = A2Bmap * AA (sparse matrix-vector multiplication)
    @inbounds for (idx, I) in enumerate(A2BMAP_1_I)
        J = A2BMAP_1_J[idx]
        V = A2BMAP_1_V[idx]
        WORK_B[I] += V * WORK_AA[J]
    end

    return WORK_B, WORK_A
end

# ============================================================================
# MANUAL PULLBACK FUNCTIONS (trim-safe)
# ============================================================================

# Full manual pullback through tensor: ∂B -> (∂Rnl, ∂Ylm)
# This replaces ET.pullback with a trim-safe implementation
# Uses pre-allocated work arrays to avoid allocations
function tensor_pullback!(∂Rnl, ∂Ylm, ∂B, Rnl, Ylm, A)
    # Reset pre-allocated arrays
    fill!(WORK_∂AA, 0.0)
    fill!(WORK_∂A, 0.0)

    # Step 1: ∂AA = A2Bmap' * ∂B (sparse transpose multiplication)
    @inbounds for (I_idx, I) in enumerate(A2BMAP_1_I)
        J = A2BMAP_1_J[I_idx]
        V = A2BMAP_1_V[I_idx]
        WORK_∂AA[J] += V * ∂B[I]  # Transpose: A2Bmap'[J,I] = A2Bmap[I,J]
    end

    # Step 2: ∂A = pullback_aabasis(∂AA, A)
    pullback_aabasis!(WORK_∂A, WORK_∂AA, A)

    # Step 3: (∂Rnl, ∂Ylm) = pullback_abasis(∂A, Rnl, Ylm)
    pullback_abasis!(∂Rnl, ∂Ylm, WORK_∂A, Rnl, Ylm)

    return ∂Rnl, ∂Ylm
end

# Site energy with ANALYTIC forces using manual pullback (trim-safe)
function site_energy_forces(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    iz0 = z2i(Z0)
    nneigh = length(Rs)

    if nneigh == 0
        # Return E0 for isolated atom, no forces

        if iz0 == 1; return E0_1, SVector{3, Float64}[]
        elseif iz0 == 2; return E0_2, SVector{3, Float64}[]
        end
    end

    # Compute embeddings with derivatives
    Rnl, dRnl, Ylm, dYlm, rs, rhats = compute_embeddings_ed(Rs, Zs, Z0)

    # Evaluate tensor (using manual inline evaluation, trim-safe)
    # Returns both B and A (A needed for pullback)
    B, A = tensor_evaluate(Rnl, Ylm)

    # Contract with weights to get energy
    # Use pre-allocated ∂B array
    fill!(WORK_∂B, 0.0)
    Ei = 0.0

    if iz0 == 1
        Ei = dot(B, WB_1)
        for k in 1:N_BASIS; WORK_∂B[k] = WB_1[k]; end  # ∂Ei/∂B = WB
    elseif iz0 == 2
        Ei = dot(B, WB_2)
        for k in 1:N_BASIS; WORK_∂B[k] = WB_2[k]; end  # ∂Ei/∂B = WB
    end

    # Backward pass through tensor using MANUAL pullback (trim-safe)
    # Use pre-allocated arrays for gradients
    ∂Rnl = view(WORK_∂Rnl, 1:nneigh, :)
    ∂Ylm = view(WORK_∂Ylm, 1:nneigh, :)
    @inbounds for j in 1:nneigh
        @simd for t in 1:N_RNL; WORK_∂Rnl[j, t] = 0.0; end
        @simd for t in 1:N_YLM; WORK_∂Ylm[j, t] = 0.0; end
    end
    tensor_pullback!(∂Rnl, ∂Ylm, WORK_∂B, Rnl, Ylm, A)

    # Assemble forces: ∂Ei/∂Rⱼ
    forces = Vector{SVector{3, Float64}}(undef, nneigh)
    @inbounds for j in 1:nneigh
        f = zero(SVector{3, Float64})
        r = rs[j]
        if r > 1e-10
            rhat = rhats[j]
            # Contribution from radial basis: ∂Ei/∂Rnl * dRnl/dr * r̂
            for t in 1:N_RNL
                f = f + (∂Rnl[j, t] * dRnl[j, t]) * rhat
            end
            # Contribution from solid harmonics: ∂Ei/∂R_lm * dR_lm/dR
            # (dYlm is dR_lm/dR for solid harmonics - direct gradient, no chain rule needed)
            for t in 1:N_YLM
                f = f + ∂Ylm[j, t] * dYlm[j, t]
            end
        end
        forces[j] = -f  # Force is negative gradient
    end

    # Add reference energy

    if iz0 == 1; Ei += E0_1
    elseif iz0 == 2; Ei += E0_2
    end

    return Ei, forces
end

# Site energy with forces AND virial stress using manual pullback (trim-safe)
function site_energy_forces_virial(Rs::Vector{SVector{3, Float64}}, Zs::Vector{<:Integer}, Z0::Integer)
    iz0 = z2i(Z0)
    nneigh = length(Rs)

    # Initialize virial tensor (3x3 symmetric)
    virial = zeros(SMatrix{3, 3, Float64, 9})

    if nneigh == 0
        # Return E0 for isolated atom, no forces/virial

        if iz0 == 1; return E0_1, SVector{3, Float64}[], virial
        elseif iz0 == 2; return E0_2, SVector{3, Float64}[], virial
        end
    end

    # Compute embeddings with derivatives
    Rnl, dRnl, Ylm, dYlm, rs, rhats = compute_embeddings_ed(Rs, Zs, Z0)

    # Evaluate tensor (using manual inline evaluation, trim-safe)
    # Returns both B and A (A needed for pullback)
    B, A = tensor_evaluate(Rnl, Ylm)

    # Contract with weights to get energy
    # Use pre-allocated ∂B array
    fill!(WORK_∂B, 0.0)
    Ei = 0.0

    if iz0 == 1
        Ei = dot(B, WB_1)
        for k in 1:N_BASIS; WORK_∂B[k] = WB_1[k]; end  # ∂Ei/∂B = WB
    elseif iz0 == 2
        Ei = dot(B, WB_2)
        for k in 1:N_BASIS; WORK_∂B[k] = WB_2[k]; end  # ∂Ei/∂B = WB
    end

    # Backward pass through tensor using MANUAL pullback (trim-safe)
    # Use pre-allocated arrays for gradients
    ∂Rnl = view(WORK_∂Rnl, 1:nneigh, :)
    ∂Ylm = view(WORK_∂Ylm, 1:nneigh, :)
    @inbounds for j in 1:nneigh
        @simd for t in 1:N_RNL; WORK_∂Rnl[j, t] = 0.0; end
        @simd for t in 1:N_YLM; WORK_∂Ylm[j, t] = 0.0; end
    end
    tensor_pullback!(∂Rnl, ∂Ylm, WORK_∂B, Rnl, Ylm, A)

    # Assemble forces and virial
    forces = Vector{SVector{3, Float64}}(undef, nneigh)
    @inbounds for j in 1:nneigh
        f = zero(SVector{3, Float64})
        r = rs[j]
        if r > 1e-10
            rhat = rhats[j]
            Rj = Rs[j]
            # Contribution from radial basis
            for t in 1:N_RNL
                df = (∂Rnl[j, t] * dRnl[j, t]) * rhat
                f = f + df
                # Virial: -Rⱼ ⊗ fⱼ (outer product)
                virial = virial - Rj * df'
            end
            # Contribution from solid harmonics: ∂Ei/∂R_lm * dR_lm/dR
            for t in 1:N_YLM
                df = ∂Ylm[j, t] * dYlm[j, t]
                f = f + df
                virial = virial - Rj * df'
            end
        end
        forces[j] = -f
    end

    # Add reference energy

    if iz0 == 1; Ei += E0_1
    elseif iz0 == 2; Ei += E0_2
    end

    return Ei, forces, virial
end

# ============================================================================
# C INTERFACE FOR SHARED LIBRARY
# ============================================================================
#
# Two API levels:
# 1. SITE-LEVEL (for LAMMPS): Works with pre-computed neighbor lists
# 2. SYSTEM-LEVEL (for Python/ASE): Computes neighbor list internally

# ============================================================================
# HELPER FUNCTIONS FOR C INTERFACE
# ============================================================================

@inline function c_read_Rij(ptr::Ptr{Cdouble}, nneigh::Int)::Vector{SVector{3, Float64}}
    Rs = Vector{SVector{3, Float64}}(undef, nneigh)
    @inbounds for j in 1:nneigh
        x = unsafe_load(ptr, 3*(j-1) + 1)
        y = unsafe_load(ptr, 3*(j-1) + 2)
        z = unsafe_load(ptr, 3*(j-1) + 3)
        Rs[j] = SVector(x, y, z)
    end
    return Rs
end

@inline function c_read_species(ptr::Ptr{Cint}, n::Int)::Vector{Int}
    species = Vector{Int}(undef, n)
    @inbounds for i in 1:n
        species[i] = unsafe_load(ptr, i)
    end
    return species
end

@inline function c_write_forces!(ptr::Ptr{Cdouble}, forces::Vector{SVector{3, Float64}})
    @inbounds for j in 1:length(forces)
        unsafe_store!(ptr, forces[j][1], 3*(j-1) + 1)
        unsafe_store!(ptr, forces[j][2], 3*(j-1) + 2)
        unsafe_store!(ptr, forces[j][3], 3*(j-1) + 3)
    end
end

@inline function c_write_virial!(ptr::Ptr{Cdouble}, virial::SMatrix{3,3,Float64,9})
    # Voigt notation: xx, yy, zz, yz, xz, xy (LAMMPS convention)
    unsafe_store!(ptr, virial[1,1], 1)  # xx
    unsafe_store!(ptr, virial[2,2], 2)  # yy
    unsafe_store!(ptr, virial[3,3], 3)  # zz
    unsafe_store!(ptr, virial[2,3], 4)  # yz
    unsafe_store!(ptr, virial[1,3], 5)  # xz
    unsafe_store!(ptr, virial[1,2], 6)  # xy
end

# ============================================================================
# SITE-LEVEL C INTERFACE (for LAMMPS)
# ============================================================================
# These work directly with LAMMPS neighbor lists.
# Forces returned are forces ON the neighbors (not on the center atom).
# LAMMPS handles force accumulation via Newton's 3rd law.

Base.@ccallable function ace_site_energy(
    z0::Cint,
    nneigh::Cint,
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble}
)::Cdouble
    if nneigh == 0
        # Return E0 for isolated atom
        iz0 = z2i(z0)

        if iz0 == 1; return E0_1
        elseif iz0 == 2; return E0_2
        end
        return 0.0
    end

    Zs = c_read_species(neighbor_z, Int(nneigh))
    Rs = c_read_Rij(neighbor_Rij, Int(nneigh))

    return site_energy(Rs, Zs, Int(z0))
end

Base.@ccallable function ace_site_energy_forces(
    z0::Cint,
    nneigh::Cint,
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble},
    forces::Ptr{Cdouble}
)::Cdouble
    if nneigh == 0
        iz0 = z2i(z0)

        if iz0 == 1; return E0_1
        elseif iz0 == 2; return E0_2
        end
        return 0.0
    end

    Zs = c_read_species(neighbor_z, Int(nneigh))
    Rs = c_read_Rij(neighbor_Rij, Int(nneigh))

    Ei, Fi = site_energy_forces(Rs, Zs, Int(z0))

    # Write forces (these are -dE/dRj, the force ON neighbor j)
    c_write_forces!(forces, Fi)

    return Ei
end

Base.@ccallable function ace_site_energy_forces_virial(
    z0::Cint,
    nneigh::Cint,
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble},
    forces::Ptr{Cdouble},
    virial::Ptr{Cdouble}
)::Cdouble
    if nneigh == 0
        iz0 = z2i(z0)
        # Zero virial for isolated atom
        for k in 1:6
            unsafe_store!(virial, 0.0, k)
        end

        if iz0 == 1; return E0_1
        elseif iz0 == 2; return E0_2
        end
        return 0.0
    end

    Zs = c_read_species(neighbor_z, Int(nneigh))
    Rs = c_read_Rij(neighbor_Rij, Int(nneigh))

    Ei, Fi, Vi = site_energy_forces_virial(Rs, Zs, Int(z0))

    c_write_forces!(forces, Fi)
    c_write_virial!(virial, Vi)

    return Ei
end

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

Base.@ccallable function ace_get_cutoff()::Cdouble
    return RCUT_MAX
end

Base.@ccallable function ace_get_n_species()::Cint
    return Cint(NZ)
end

Base.@ccallable function ace_get_species(idx::Cint)::Cint
    if idx < 1 || idx > NZ
        return Cint(-1)
    end
    return Cint(I2Z[idx])
end

Base.@ccallable function ace_get_n_basis()::Cint
    return Cint(N_BASIS)
end

# ============================================================================
# BASIS EVALUATION (for descriptor computation)
# ============================================================================

Base.@ccallable function ace_site_basis(
    z0::Cint,
    nneigh::Cint,
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble},
    basis_out::Ptr{Cdouble}
)::Cint
    if nneigh == 0
        # Return zeros for isolated atom
        for k in 1:N_BASIS
            unsafe_store!(basis_out, 0.0, k)
        end
        return Cint(0)
    end

    Zs = c_read_species(neighbor_z, Int(nneigh))
    Rs = c_read_Rij(neighbor_Rij, Int(nneigh))

    B = site_basis(Rs, Zs, Int(z0))

    # Write basis to output buffer
    for k in 1:N_BASIS
        unsafe_store!(basis_out, B[k], k)
    end

    return Cint(0)  # Success
end

# ============================================================================
# BATCH API
# ============================================================================
# Process multiple atoms at once, reducing Python-Julia FFI call overhead.
# Note: Threads.@threads doesn't work with --trim=safe (closures are trimmed).
# For multi-threaded evaluation, use LAMMPS (OpenMP) or IPICalculator.

Base.@ccallable function ace_batch_energy_forces_virial(
    natoms::Cint,
    z::Ptr{Cint},
    neighbor_counts::Ptr{Cint},
    neighbor_offsets::Ptr{Cint},
    neighbor_z::Ptr{Cint},
    neighbor_Rij::Ptr{Cdouble},
    energies::Ptr{Cdouble},
    forces::Ptr{Cdouble},
    virials::Ptr{Cdouble}
)::Cvoid
    # Process atoms sequentially
    for i in 1:Int(natoms)
        z0 = unsafe_load(z, i)
        nneigh = Int(unsafe_load(neighbor_counts, i))
        offset = Int(unsafe_load(neighbor_offsets, i))  # 0-indexed from C

        if nneigh == 0
            # Isolated atom - return E0
            iz0 = z2i(z0)

            if iz0 == 1; E0 = E0_1
            elseif iz0 == 2; E0 = E0_2
            else; E0 = 0.0
            end
            unsafe_store!(energies, E0, i)
            # Zero virial
            for k in 1:6
                unsafe_store!(virials, 0.0, (i-1)*6 + k)
            end
        else
            # Read neighbor data for this atom
            Zs = Vector{Int}(undef, nneigh)
            Rs = Vector{SVector{3, Float64}}(undef, nneigh)

            @inbounds for j in 1:nneigh
                idx = offset + j  # 1-indexed from 0-indexed offset
                Zs[j] = unsafe_load(neighbor_z, idx)
                x = unsafe_load(neighbor_Rij, 3*(idx-1) + 1)
                y = unsafe_load(neighbor_Rij, 3*(idx-1) + 2)
                z_coord = unsafe_load(neighbor_Rij, 3*(idx-1) + 3)
                Rs[j] = SVector(x, y, z_coord)
            end

            # Compute energy, forces, virial
            Ei, Fi, Vi = site_energy_forces_virial(Rs, Zs, Int(z0))

            # Write outputs
            unsafe_store!(energies, Ei, i)

            # Forces for this atom's neighbors
            @inbounds for j in 1:nneigh
                idx = offset + j
                unsafe_store!(forces, Fi[j][1], 3*(idx-1) + 1)
                unsafe_store!(forces, Fi[j][2], 3*(idx-1) + 2)
                unsafe_store!(forces, Fi[j][3], 3*(idx-1) + 3)
            end

            # Virial in Voigt notation: xx, yy, zz, yz, xz, xy
            vbase = (i-1)*6
            unsafe_store!(virials, Vi[1,1], vbase + 1)
            unsafe_store!(virials, Vi[2,2], vbase + 2)
            unsafe_store!(virials, Vi[3,3], vbase + 3)
            unsafe_store!(virials, Vi[2,3], vbase + 4)
            unsafe_store!(virials, Vi[1,3], vbase + 5)
            unsafe_store!(virials, Vi[1,2], vbase + 6)
        end
    end
    return nothing
end


