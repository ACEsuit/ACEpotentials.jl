<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Smoothness Priors · ACEpotentials.jl</title><meta name="title" content="Smoothness Priors · ACEpotentials.jl"/><meta property="og:title" content="Smoothness Priors · ACEpotentials.jl"/><meta property="twitter:title" content="Smoothness Priors · ACEpotentials.jl"/><meta name="description" content="Documentation for ACEpotentials.jl."/><meta property="og:description" content="Documentation for ACEpotentials.jl."/><meta property="twitter:description" content="Documentation for ACEpotentials.jl."/><meta property="og:url" content="https://ACEsuit.github.io/ACEpotentials.jl/literate_tutorials/smoothness_priors/"/><meta property="twitter:url" content="https://ACEsuit.github.io/ACEpotentials.jl/literate_tutorials/smoothness_priors/"/><link rel="canonical" href="https://ACEsuit.github.io/ACEpotentials.jl/literate_tutorials/smoothness_priors/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ACEpotentials.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../gettingstarted/installation/">Installation</a></li><li><a class="tocitem" href="../../gettingstarted/saving-and-loading/">Saving and Loading Potentials</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/">Tutorials Overview</a></li><li><a class="tocitem" href="../basic_julia_workflow/">Basic Workflow</a></li><li class="is-active"><a class="tocitem" href>Smoothness Priors</a></li><li><a class="tocitem" href="../dataset_analysis/">Basic Dataset Analysis</a></li><li><a class="tocitem" href="../../tutorials/scripting/">Basic Shell Workflow</a></li><li><a class="tocitem" href="../descriptor/">ACE Descriptors</a></li><li><a class="tocitem" href="../asp/">Sparse Solvers</a></li></ul></li><li><span class="tocitem">Additional Topics</span><ul><li><a class="tocitem" href="../../gettingstarted/parallel-fitting/">Parallel Fitting</a></li><li><a class="tocitem" href="../../gettingstarted/aceintro/">Introduction to ACE Models</a></li><li><a class="tocitem" href="../../gettingstarted/pkg/">Using the Julia Package Manager</a></li></ul></li><li><a class="tocitem" href="../../all_exported/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Smoothness Priors</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Smoothness Priors</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ACEsuit/ACEpotentials.jl/blob/main/docs/src/tutorials/smoothness_priors.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Smoothness-Priors"><a class="docs-heading-anchor" href="#Smoothness-Priors">Smoothness Priors</a><a id="Smoothness-Priors-1"></a><a class="docs-heading-anchor-permalink" href="#Smoothness-Priors" title="Permalink"></a></h1><pre><code class="language-julia hljs">using ACEpotentials, LinearAlgebra, Plots, LaTeXStrings, Unitful</code></pre><p>ACEpotentials models make heavy use of smoothness priors, i.e., prior parameter distributions that impose smoothness on the fitted potential. This tutorial demonstrates how to use the smoothness priors implemented in ACEpotentials. We start by reading in a tiny testing dataset, and bring the data into a format that ACEfit likes. Note that using a very limited dataset makes the use of priors particularlty important. In general, the larger and more diverse the dataset, the less important the prior becomes.</p><pre><code class="language-julia hljs">rawdata, _, _ = ACEpotentials.example_dataset(&quot;Si_tiny&quot;)
datakeys = (energy_key = &quot;dft_energy&quot;, force_key = &quot;dft_force&quot;, virial_key = &quot;dft_virial&quot;)

rcut = 6.0     # cut off distance
r_nn = 2.3     # typical nearest neighbour distance

model = ace1_model(elements = [:Si],
                    order = 3, totaldegree = 12,
                    rcut = rcut, r0 = r_nn,
                    Eref = Dict(:Si =&gt; -158.54496821))

data = [ AtomsData(at; datakeys..., v_ref = model.model.Vref) for at in rawdata ]
A, Y, W = ACEfit.assemble(data, model);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr36"><span class="sgr1">[ Info: </span></span>Assembling linear problem.
<span class="sgr36"><span class="sgr1">[ Info: </span></span>  - Creating feature matrix with size (1052, 223).
<span class="sgr36"><span class="sgr1">[ Info: </span></span>  - Beginning assembly with processor count:  1.
<span class="sgr32">Progress:   4%|█▌                                       |  ETA: 0:01:03</span><span class="sgr32">Progress:   9%|███▉                                     |  ETA: 0:00:45</span><span class="sgr32">Progress:  11%|████▋                                    |  ETA: 0:00:41</span><span class="sgr32">Progress:  13%|█████▍                                   |  ETA: 0:00:39</span><span class="sgr32">Progress:  15%|██████▎                                  |  ETA: 0:00:37</span><span class="sgr32">Progress:  17%|███████                                  |  ETA: 0:00:36</span><span class="sgr32">Progress:  19%|███████▊                                 |  ETA: 0:00:34</span><span class="sgr32">Progress:  21%|████████▌                                |  ETA: 0:00:33</span><span class="sgr32">Progress:  23%|█████████▎                               |  ETA: 0:00:32</span><span class="sgr32">Progress:  25%|██████████                               |  ETA: 0:00:31</span><span class="sgr32">Progress:  26%|██████████▉                              |  ETA: 0:00:30</span><span class="sgr32">Progress:  28%|███████████▋                             |  ETA: 0:00:29</span><span class="sgr32">Progress:  30%|████████████▍                            |  ETA: 0:00:27</span><span class="sgr32">Progress:  36%|██████████████▊                          |  ETA: 0:00:25</span><span class="sgr32">Progress:  38%|███████████████▌                         |  ETA: 0:00:24</span><span class="sgr32">Progress:  40%|████████████████▎                        |  ETA: 0:00:23</span><span class="sgr32">Progress:  42%|█████████████████                        |  ETA: 0:00:22</span><span class="sgr32">Progress:  43%|█████████████████▊                       |  ETA: 0:00:21</span><span class="sgr32">Progress:  45%|██████████████████▋                      |  ETA: 0:00:20</span><span class="sgr32">Progress:  51%|████████████████████▉                    |  ETA: 0:00:18</span><span class="sgr32">Progress:  57%|███████████████████████▎                 |  ETA: 0:00:16</span><span class="sgr32">Progress:  58%|████████████████████████                 |  ETA: 0:00:15</span><span class="sgr32">Progress:  64%|██████████████████████████▎              |  ETA: 0:00:13</span><span class="sgr32">Progress:  66%|███████████████████████████▏             |  ETA: 0:00:12</span><span class="sgr32">Progress:  68%|███████████████████████████▉             |  ETA: 0:00:12</span><span class="sgr32">Progress:  70%|████████████████████████████▋            |  ETA: 0:00:11</span><span class="sgr32">Progress:  72%|█████████████████████████████▍           |  ETA: 0:00:10</span><span class="sgr32">Progress:  74%|██████████████████████████████▏          |  ETA: 0:00:10</span><span class="sgr32">Progress:  75%|███████████████████████████████          |  ETA: 0:00:09</span><span class="sgr32">Progress:  77%|███████████████████████████████▊         |  ETA: 0:00:08</span><span class="sgr32">Progress:  92%|█████████████████████████████████████▉   |  ETA: 0:00:03</span><span class="sgr32">Progress:  94%|██████████████████████████████████████▋  |  ETA: 0:00:02</span><span class="sgr32">Progress:  96%|███████████████████████████████████████▌ |  ETA: 0:00:01</span><span class="sgr32">Progress:  98%|████████████████████████████████████████▎|  ETA: 0:00:01</span><span class="sgr32">Progress: 100%|█████████████████████████████████████████| Time: 0:00:36</span>
<span class="sgr36"><span class="sgr1">[ Info: </span></span>  - Assembly completed.
<span class="sgr36"><span class="sgr1">[ Info: </span></span>Assembling full weight vector.</code></pre><p>A positive definite matrix P specifies a normal prior distribution in the Bayesian framework, but for the purpose of this tutorial it is maybe more intuitive to simply think of it as a regularisation operator. The regularised linear least squares problem is</p><p class="math-container">\[  \| A c - y \|^2 + \lambda \| P c \|^2\]</p><p>where <code>A</code> is the design matrix, <span>$y$</span> is the vector of observations, <span>$c$</span> is the vector of parameters, and <span>$\lambda$</span> is a regularisation parameter. The prior matrix <span>$P$</span> is specified by the user. At present we support diagonal operators <span>$P$</span>. The diagonal elements of <span>$P$</span> are the prior variances. The larger the prior variance, the smoother the fitted potential. Although not <em>strictly</em> true, we can think of each basis function as specified by a the parameters <span>$(n_t, l_t)_{t = 1}^N$</span>, where <span>$N$</span> is the correlation-order, i.e., corresponding prior matrix element must be a function of those <span>$n_t, l_t$</span> values,</p><p class="math-container">\[   P_{\bf k \bf k} = \gamma({\bf k}).\]</p><p>We currently provide convenient interfaces for three classes: algebraic, exponential and gaussian. Technically, (but loosely speaking) an algebraic prior declares that the target function has <code>p</code> derivatives (for some parameter <code>p</code>), the exponential prior declares that the target function is analytic, while the gaussian prior declares that the target function is entire. In practice, especially for small datasets when the model is underdetermined, one may use a stronger prior than is justified by our knowledge about the target function. For large and diverse datasets it can happen that too strong a prior will adversely affect the fit accuracy. For the definition of the three main prior classes, see the documentation for</p><pre><code class="language-julia hljs">?algebraic_smoothness_prior
?exp_smoothness_prior
?gaussian_smoothness_prior</code></pre><p>In the following we demonstrate the usage of algebraic and gaussian priors. The choices for <code>σl, σn</code> made here may seem &quot;magical&quot;, but there is a good justification and we plan to automate this in future releases.</p><pre><code class="language-julia hljs">Pa2 = algebraic_smoothness_prior(model; p=2)
Pa4 = algebraic_smoothness_prior(model; p=4)
Pg  = gaussian_smoothness_prior( model; wl = (2/r_nn)^2, wn = (0.5/r_nn)^2);</code></pre><p>Each of these object <code>Pa2, Pa4, Pg</code> are diagonal matrices. For each prior constructed above we now solve the regularised least squares problem. Note how design matrix need only be assembled once if we want to play with many different priors. Most of the time we would just use defaults however and then these steps are all taken care of behind the scenes.</p><pre><code class="language-julia hljs">priors = Dict(&quot;Id&quot; =&gt; I, &quot;Algebraic(2)&quot; =&gt; Pa2, &quot;Algebraic(4)&quot; =&gt; Pa4,&quot;Gaussian&quot; =&gt; Pg)
rmse = Dict()
pots = Dict()

for (prior_name, P) in priors
    print(&quot;Solving with &quot;, prior_name, &quot; prior ... &quot;)

    # solve the regularized least squares problem
    Ã = Diagonal(W) * (A / P)
    ỹ = Diagonal(W) * Y
    c̃ = ACEfit.solve(ACEfit.BLR(; verbose=false), Ã, ỹ)[&quot;C&quot;]
    _modl = deepcopy(model)
    set_parameters!(_modl, P \ c̃)

    # compute errors and store them for later use (don&#39;t print them here)
    errs = compute_errors(rawdata, model; verbose=false, datakeys...)
    rmse[prior_name] = errs[&quot;rmse&quot;][&quot;set&quot;][&quot;F&quot;]
    pots[prior_name] = _modl
    println(&quot; force=rmse = &quot;, rmse[prior_name])
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Solving with Id prior ... <span class="sgr33"><span class="sgr1">┌ Warning: </span></span>x_tol is deprecated. Use x_abstol or x_reltol instead. The provided value (1.0e-8) will be used as x_abstol.
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ Optim ~/.julia/packages/Optim/7krni/src/types.jl:110</span>
 force=rmse = 1.2215538976358178
Solving with Algebraic(4) prior ... <span class="sgr33"><span class="sgr1">┌ Warning: </span></span>x_tol is deprecated. Use x_abstol or x_reltol instead. The provided value (1.0e-8) will be used as x_abstol.
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ Optim ~/.julia/packages/Optim/7krni/src/types.jl:110</span>
 force=rmse = 1.2215538976358178
Solving with Gaussian prior ... <span class="sgr33"><span class="sgr1">┌ Warning: </span></span>x_tol is deprecated. Use x_abstol or x_reltol instead. The provided value (1.0e-8) will be used as x_abstol.
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ Optim ~/.julia/packages/Optim/7krni/src/types.jl:110</span>
 force=rmse = 1.2215538976358178
Solving with Algebraic(2) prior ... <span class="sgr33"><span class="sgr1">┌ Warning: </span></span>x_tol is deprecated. Use x_abstol or x_reltol instead. The provided value (1.0e-8) will be used as x_abstol.
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ Optim ~/.julia/packages/Optim/7krni/src/types.jl:110</span>
 force=rmse = 1.2215538976358178</code></pre><p>The force RMSE errors are comparable for the three priors, though slightly better for the weaker smoothness priors <code>Algebraic(2)</code> and <code>Id</code>. This is unsurprising, since those priors are less restrictive.</p><p>On the other hand, we expect the stronger priors to generalize better. A typical intuition is that smooth potentials with similar accuracy will be more transferable than rougher potentials. We will show three one-dimensional slices through the fitted potentials: dimer curves, trimer curves and a decohesion curve.</p><p>First, the dimer curves: the utility function <code>ACEpotentials.dimers</code> can be used to generate the data for those curves, which are then plotted using <code>Plots.jl</code>. We also add a vertical line to indicate the nearest neighbour distance. The standard identity prior gives a completely unrealistic dimer curve. The <code>Algebraic(2)</code> regularised potential is missing a repulsive core behaviour. The two remaining smoothness priors give physically sensible dimer curve shapes.</p><pre><code class="language-julia hljs">labels = sort(collect(keys(priors)))[[4,1,2,3]]
plt_dim = plot(legend = :topright, xlabel = L&quot;r [\AA]&quot;, ylabel = &quot;E [eV]&quot;,
               xlims = (0, rcut), ylims = (-2, 5))
for l in labels
    D = ACEpotentials.dimers(pots[l], [:Si,])
    plot!(plt_dim, D[(:Si, :Si)]..., label = l, lw=2)
end
vline!([r_nn,], lw=2, ls=:dash, label = L&quot;r_{\rm nn}&quot;)
plt_dim</code></pre><img src="0fbfed51.svg" alt="Example block output"/><p>Next, we look at a trimer curve. This is generated using <code>ACEpotentials.trimers</code>. Both the <code>Id</code> and <code>Algebraic(2)</code> regularised models contain fairly significant oscillations while the <code>Algebraic(4)</code> and <code>Gaussian</code> models are much smoother. In addition, it appears that the <code>Gaussian</code> regularised model is somewhat more physically realistic on this slice with high energy at small bond-angles (thought the low energy at angle π seems somewhat strange).</p><pre><code class="language-julia hljs">plt_trim = plot(legend = :topright, xlabel = L&quot;\theta&quot;, ylabel = &quot;E [eV]&quot;,
               xlims = (0, pi), ylims = (-0.6, 0.2))
for l in labels
    D = ACEpotentials.trimers(pots[l], [:Si,], r_nn*u&quot;Å&quot;,  r_nn*u&quot;Å&quot;)
    plot!(plt_trim, D[(:Si, :Si, :Si)]..., label = l, lw=2)
end
vline!(plt_trim, [1.90241,], lw=2, label = &quot;equilibrium angle&quot;)
plt_trim</code></pre><img src="9572aace.svg" alt="Example block output"/><p>Finally, we plot a decohesion curve, which contains more significant many-body effects. Arguably, none of our potentials perform very well on this test. Usually larger datasets, and longer cutoffs help in this case.</p><pre><code class="language-julia hljs">using AtomsBuilder  # gives us `bulk`

at0 = bulk(:Si, cubic=true)
plt_dec = plot(legend = :topright, xlabel = L&quot;r [\AA]&quot;, ylabel = &quot;strain [eV/Å]&quot;,
                xlim = (0.0, 5.0))
for l in labels
    rr, E, dE = ACEpotentials.decohesion_curve(at0, pots[l])
    plot!(plt_dec, ustrip.(rr), ustrip.(dE), label = l, lw=2)
end
plt_dec</code></pre><img src="396b0397.svg" alt="Example block output"/><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../basic_julia_workflow/">« Basic Workflow</a><a class="docs-footer-nextpage" href="../dataset_analysis/">Basic Dataset Analysis »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Wednesday 26 November 2025 03:15">Wednesday 26 November 2025</span>. Using Julia version 1.12.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
